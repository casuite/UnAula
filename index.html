<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASuite || Sistema de Gestión Educativa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .calendar-day {
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background-color: #e5e7eb;
        }
        
        .calendar-day.today {
            background-color: #3b82f6;
            color: white;
        }
        
        .calendar-day.has-event {
            background-color: #fef3c7;
            font-weight: 600;
        }
        
        .attendance-btn {
            transition: all 0.2s ease;
        }
        
        .attendance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .menu-item {
            transition: all 0.2s ease;
        }
        
        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .auth-tab.active {
            background-color: white;
            color: #1f2937;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .student-card {
            transition: all 0.2s ease;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .attendance-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .attendance-status:hover {
            transform: scale(1.1);
        }

        .attendance-status.present {
            background-color: #10b981;
            color: white;
        }

        .attendance-status.absent {
            background-color: #ef4444;
            color: white;
        }

        .attendance-status.late {
            background-color: #f59e0b;
            color: white;
        }

        .attendance-status.justified {
            background-color: #6366f1;
            color: white;
        }

        .tab-button {
            transition: all 0.2s ease;
        }

        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }

        .observation-card {
            border-left: 4px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .observation-card.comportamiento {
            border-left-color: #3b82f6;
        }

        .observation-card.felicitaciones {
            border-left-color: #10b981;
        }

        .observation-card.academico {
            border-left-color: #f59e0b;
        }

        .observation-card.participacion {
            border-left-color: #8b5cf6;
        }

        .observation-card.asistencia {
            border-left-color: #ef4444;
        }

        .observation-card.general {
            border-left-color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Authentication Screen -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-green-500 rounded-2xl flex items-center justify-center text-white text-2xl font-bold mx-auto mb-4">
                    CA
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">CASuite</h1>
                <p class="text-gray-600">Sistema de Gestión Educativa Completo</p>
            </div>
            
            <!-- Auth Tabs -->
            <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                <button class="auth-tab flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all active" onclick="showLoginTab()">
                    Iniciar Sesión
                </button>
                <button class="auth-tab flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all" onclick="showRegisterTab()">
                    Registrarse
                </button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="space-y-4">
                    <!-- Demo Credentials Info -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="text-sm text-blue-800">
                            <div class="font-semibold mb-2">🎯 Credenciales de Demostración:</div>
                            <div class="space-y-1">
                                <div><strong>Usuario:</strong> demo</div>
                                <div><strong>Contraseña:</strong> 123456</div>
                            </div>
                            <div class="text-xs text-blue-600 mt-2">
                                Los campos ya están completados automáticamente
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <input type="text" id="loginUsername" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nombre de usuario" autocomplete="username" onkeypress="if(event.key==='Enter') loginUser()">
                    </div>
                    <div>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contraseña" autocomplete="current-password" onkeypress="if(event.key==='Enter') loginUser()">
                    </div>
                    <button type="button" class="w-full bg-gradient-to-r from-blue-500 to-green-500 text-white py-3 px-4 rounded-lg font-medium hover:shadow-lg transition-all" onclick="loginUser()">
                        Iniciar Sesión
                    </button>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="space-y-4">
                    <div>
                        <input type="text" id="registerName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nombre completo" autocomplete="name">
                    </div>
                    <div>
                        <input type="email" id="registerEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Correo electrónico" autocomplete="email">
                    </div>
                    <div>
                        <input type="text" id="registerUsername" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nombre de usuario" autocomplete="username">
                    </div>
                    <div>
                        <input type="password" id="registerPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contraseña" autocomplete="new-password">
                    </div>
                    <div>
                        <input type="password" id="registerConfirmPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Confirmar contraseña" autocomplete="new-password">
                    </div>
                    <button type="button" class="w-full bg-gradient-to-r from-blue-500 to-green-500 text-white py-3 px-4 rounded-lg font-medium hover:shadow-lg transition-all" onclick="registerUser()">
                        Crear Cuenta
                    </button>
                </div>
            </div>
            
            <p class="text-xs text-gray-500 text-center mt-6 leading-relaxed">
                Al continuar, aceptas nuestros términos de servicio y política de privacidad.
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-green-500 rounded-lg flex items-center justify-center text-white text-sm font-bold">
                            CA
                        </div>
                        <h1 id="pageTitle" class="text-xl font-semibold text-gray-900">CASuite || Dashboard</h1>
                    </div>
                    
                    <!-- Global Search -->
                    <div class="flex-1 max-w-md mx-8 relative">
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">🔍</span>
                            <input type="text" id="globalSearch" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" placeholder="Buscar estudiante..." oninput="performGlobalSearch()">
                            <div id="searchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden"></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 bg-blue-50 px-3 py-2 rounded-lg">
                            <div id="userAvatar" class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-medium">U</div>
                            <span id="currentUser" class="text-sm text-gray-700">Usuario</span>
                        </div>
                        <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" onclick="logout()">
                            Salir
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard -->
            <div id="dashboard">
                <div class="fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <!-- Main Content -->
                        <div class="lg:col-span-3">
                            <!-- Stats -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <div class="text-3xl font-bold text-gray-900" id="totalClassrooms">0</div>
                                    <div class="text-sm text-gray-600">Aulas Activas</div>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <div class="text-3xl font-bold text-gray-900" id="totalStudents">0</div>
                                    <div class="text-sm text-gray-600">Estudiantes</div>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <div class="text-3xl font-bold text-gray-900" id="attendanceToday">0</div>
                                    <div class="text-sm text-gray-600">Asistencias Hoy</div>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <div class="text-3xl font-bold text-gray-900" id="averageAttendance">0%</div>
                                    <div class="text-sm text-gray-600">Promedio Asistencia</div>
                                </div>
                            </div>
                            
                            <!-- Menu -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="showClassrooms()">
                                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl mb-4">🏫</div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Gestión de Aulas</h3>
                                    <p class="text-gray-600 text-sm">Administra aulas, estudiantes y configuraciones académicas</p>
                                </div>
                                
                                <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="showAttendance()">
                                    <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-2xl mb-4">📋</div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Control de Asistencia</h3>
                                    <p class="text-gray-600 text-sm">Registra y gestiona la asistencia de estudiantes</p>
                                </div>
                                
                                <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="showReports()">
                                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl mb-4">📊</div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Informes y Reportes</h3>
                                    <p class="text-gray-600 text-sm">Genera reportes detallados y estadísticas con IA</p>
                                </div>
                                
                                <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="showExams()">
                                    <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center text-2xl mb-4">📝</div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Exámenes</h3>
                                    <p class="text-gray-600 text-sm">Crea y gestiona evaluaciones y exámenes</p>
                                </div>
                                
                                <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="showSettings()">
                                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl mb-4">⚙️</div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Configuración</h3>
                                    <p class="text-gray-600 text-sm">Personaliza el sistema según tus necesidades</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sidebar -->
                        <div class="space-y-6">
                            <!-- Calendar Widget -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div class="bg-gray-50 px-4 py-3 flex justify-between items-center">
                                    <button class="text-gray-600 hover:text-gray-900 text-lg" onclick="previousMonth()">‹</button>
                                    <h3 id="calendarMonth" class="font-semibold text-gray-900">Enero 2024</h3>
                                    <button class="text-gray-600 hover:text-gray-900 text-lg" onclick="nextMonth()">›</button>
                                </div>
                                <div class="grid grid-cols-7 gap-px bg-gray-200" id="calendarGrid">
                                    <!-- Calendar will be generated here -->
                                </div>
                            </div>
                            
                            <!-- Tasks Widget -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                                <div class="bg-gray-50 px-4 py-3 flex justify-between items-center">
                                    <h3 class="font-semibold text-gray-900">Tareas Pendientes</h3>
                                    <button class="px-3 py-1 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" onclick="addTask()">+</button>
                                </div>
                                <div id="tasksList" class="p-4">
                                    <!-- Tasks will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Classrooms Section -->
            <div id="classroomsSection" class="hidden">
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-900">CASuite || Gestión de Aulas</h2>
                        <div class="space-x-3">
                            <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" onclick="showAddClassroom()">
                                + Nueva Aula
                            </button>
                            <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" onclick="showDashboard()">
                                Volver
                            </button>
                        </div>
                    </div>
                    
                    <div id="classroomsList">
                        <!-- Classrooms will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Classroom Detail Section -->
            <div id="classroomDetailSection" class="hidden">
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <h2 id="classroomDetailTitle" class="text-2xl font-bold text-gray-900">CASuite || Detalle del Aula</h2>
                        <div class="space-x-3">
                            <button class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" onclick="showAddStudent()">
                                + Agregar Estudiante
                            </button>
                            <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" onclick="showClassrooms()">
                                Volver a Aulas
                            </button>
                        </div>
                    </div>

                    <!-- Classroom Info Card -->
                    <div id="classroomInfoCard" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                        <!-- Classroom info will be loaded here -->
                    </div>

                    <!-- Tabs -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="border-b border-gray-200">
                            <nav class="flex space-x-8 px-6">
                                <button class="tab-button py-4 px-2 border-b-2 border-transparent font-medium text-sm active" onclick="showStudentsTab()">
                                    Estudiantes
                                </button>
                                <button class="tab-button py-4 px-2 border-b-2 border-transparent font-medium text-sm" onclick="showAttendanceTab()">
                                    Asistencia
                                </button>
                                <button class="tab-button py-4 px-2 border-b-2 border-transparent font-medium text-sm" onclick="showObservationsTab()">
                                    Observaciones
                                </button>
                                <button class="tab-button py-4 px-2 border-b-2 border-transparent font-medium text-sm" onclick="showGradesTab()">
                                    Calificaciones
                                </button>
                            </nav>
                        </div>

                        <!-- Students Tab -->
                        <div id="studentsTab" class="p-6">
                            <div id="studentsList">
                                <!-- Students will be loaded here -->
                            </div>
                        </div>

                        <!-- Attendance Tab -->
                        <div id="attendanceTab" class="p-6 hidden">
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900">Control de Asistencia</h3>
                                    <div class="flex space-x-3">
                                        <input type="date" id="attendanceDate" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" onclick="loadAttendanceForDate()">
                                            Cargar Fecha
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-4 text-sm text-gray-600 mb-4">
                                    <div class="flex items-center space-x-2">
                                        <div class="attendance-status present">P</div>
                                        <span>Presente</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="attendance-status absent">A</div>
                                        <span>Ausente</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="attendance-status late">T</div>
                                        <span>Tardanza</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="attendance-status justified">J</div>
                                        <span>Justificado</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="attendanceList">
                                <!-- Attendance list will be loaded here -->
                            </div>
                        </div>

                        <!-- Observations Tab -->
                        <div id="observationsTab" class="p-6 hidden">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-semibold text-gray-900">Observaciones del Aula</h3>
                                <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" onclick="showAddObservation()">
                                    + Nueva Observación
                                </button>
                            </div>
                            
                            <div id="observationsList">
                                <!-- Observations will be loaded here -->
                            </div>
                        </div>

                        <!-- Grades Tab -->
                        <div id="gradesTab" class="p-6 hidden">
                            <div class="text-center py-12">
                                <div class="w-16 h-16 bg-yellow-100 rounded-xl flex items-center justify-center text-3xl mx-auto mb-4">📊</div>
                                <h3 class="text-xl font-semibold text-gray-900 mb-4">Módulo de Calificaciones</h3>
                                <p class="text-gray-600">Esta funcionalidad estará disponible próximamente</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Section -->
            <div id="attendanceSection" class="hidden">
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-900">CASuite || Control de Asistencia</h2>
                        <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" onclick="showDashboard()">
                            Volver
                        </button>
                    </div>
                    
                    <div id="attendanceClassroomSelect">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                            <div class="bg-gray-50 px-6 py-4">
                                <h3 class="text-lg font-semibold text-gray-900">Seleccionar Aula</h3>
                            </div>
                            <div class="p-6">
                                <div id="attendanceClassroomsList">
                                    <!-- Classrooms for attendance will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="hidden">
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-900">CASuite || Informes y Reportes</h2>
                        <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" onclick="showDashboard()">
                            Volver
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="generateStudentReport()">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl mb-4">👥</div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Reporte de Estudiantes</h3>
                            <p class="text-gray-600 text-sm">Lista completa de estudiantes por aula</p>
                        </div>
                        
                        <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="generateAttendanceReport()">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl mb-4">📊</div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Reporte de Asistencia</h3>
                            <p class="text-gray-600 text-sm">Estadísticas detalladas de asistencia</p>
                        </div>
                        
                        <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="generateGradeReport()">
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-2xl mb-4">📈</div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Reporte de Calificaciones</h3>
                            <p class="text-gray-600 text-sm">Análisis de rendimiento académico</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exams Section -->
            <div id="examsSection" class="hidden">
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-900">CASuite || Exámenes</h2>
                        <div class="space-x-3">
                            <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" onclick="showAddExam()">
                                + Nuevo Examen
                            </button>
                            <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" onclick="showDashboard()">
                                Volver
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                        <div class="w-16 h-16 bg-pink-100 rounded-xl flex items-center justify-center text-3xl mx-auto mb-4">📝</div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Módulo de Exámenes</h3>
                        <p class="text-gray-600 mb-6">Esta funcionalidad estará disponible próximamente</p>
                        <div class="text-sm text-gray-500">Podrás crear, gestionar y calificar exámenes</div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="hidden">
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-900">CASuite || Configuración</h2>
                        <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" onclick="showDashboard()">
                            Volver
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="showProfileSettings()">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl mb-4">👤</div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Perfil de Usuario</h3>
                            <p class="text-gray-600 text-sm">Actualiza tu información personal</p>
                        </div>
                        
                        <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="showSchoolSettings()">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl mb-4">🏫</div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Gestión de Colegios</h3>
                            <p class="text-gray-600 text-sm">Administra la información de colegios</p>
                        </div>
                        
                        <div class="menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer" onclick="showSystemSettings()">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl mb-4">⚙️</div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Configuración del Sistema</h3>
                            <p class="text-gray-600 text-sm">Personaliza la apariencia y comportamiento</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
        // Global Variables
        let currentUser = null;
        let currentUserData = null;
        let currentClassroom = null;
        let currentStudent = null;
        let currentAttendanceSession = null;
        let currentCalendarDate = new Date();
        let selectedDateOption = 'today';
        let currentAttendanceDate = new Date().toISOString().split('T')[0];

        // System Data
        let systemData = {
            users: {},
            schools: [
                { id: 1, name: 'Colegio San Martín', address: 'Av. San Martín 123', phone: '123-456-7890' },
                { id: 2, name: 'Instituto Belgrano', address: 'Belgrano 456', phone: '098-765-4321' }
            ],
            subjects: ['Matemáticas', 'Lengua', 'Historia', 'Geografía', 'Ciencias Naturales', 'Inglés', 'Educación Física'],
            quarters: ['1° Cuatrimestre', '2° Cuatrimestre', 'Anual'],
            examTypes: ['Parcial', 'Final', 'Recuperatorio', 'Integrador', 'Oral'],
            observationTypes: ['Comportamiento', 'Felicitaciones', 'Académico', 'Participación', 'Asistencia', 'General']
        };

        // Notification Functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg max-w-sm fade-in ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">×</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Modal Functions
        function showModal(title, content, buttons = []) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-96 overflow-y-auto">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                    </div>
                    <div class="p-6">
                        ${content}
                    </div>
                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                        ${buttons.map(btn => `<button class="px-4 py-2 text-white rounded-lg font-medium transition-colors ${btn.class}" onclick="${btn.onclick}">${btn.text}</button>`).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').appendChild(modal);
        }

        function closeModal() {
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML = '';
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            createDemoUser();
            
            // Auto-fill login form with demo credentials
            document.getElementById('loginUsername').value = 'demo';
            document.getElementById('loginPassword').value = '123456';
            
            // Set today's date for attendance
            document.getElementById('attendanceDate') && (document.getElementById('attendanceDate').value = currentAttendanceDate);
            
            // Check for existing session
            const savedSession = localStorage.getItem('casuiteCurrentUser');
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    const users = JSON.parse(localStorage.getItem('casuiteUsers') || '{}');
                    const user = users[sessionData.username];
                    
                    if (user && sessionData.timestamp > Date.now() - (24 * 60 * 60 * 1000)) {
                        currentUser = user;
                        initializeUserSession();
                        return;
                    }
                } catch (error) {
                    console.error('Error loading session:', error);
                }
            }
            
            showAuthScreen();
        });

        // Demo User Creation
        function createDemoUser() {
            const existingUsers = JSON.parse(localStorage.getItem('casuiteUsers') || '{}');
            
            if (!existingUsers['demo']) {
                const demoUser = {
                    id: 'demo_user',
                    name: 'Usuario Demo',
                    email: 'demo@casuite.com',
                    username: 'demo',
                    password: '123456',
                    createdAt: new Date().toISOString()
                };
                
                existingUsers['demo'] = demoUser;
                localStorage.setItem('casuiteUsers', JSON.stringify(existingUsers));
                
                createDemoData();
            }
        }

        function createDemoData() {
            const demoData = {
                classrooms: [
                    {
                        id: 1,
                        year: '5',
                        division: 'A',
                        schoolId: 1,
                        shift: 'Mañana',
                        classroomCode: 'abc123',
                        classroomLink: 'https://classroom.google.com/c/example',
                        createdAt: new Date().toISOString()
                    }
                ],
                students: [
                    {
                        id: 1,
                        name: 'Juan',
                        lastName: 'García',
                        classroomId: 1,
                        isRepeater: false,
                        average: 8.5,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'María',
                        lastName: 'Pérez',
                        classroomId: 1,
                        isRepeater: false,
                        average: 9.2,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        name: 'Carlos',
                        lastName: 'Rodríguez',
                        classroomId: 1,
                        isRepeater: true,
                        average: 6.8,
                        createdAt: new Date().toISOString()
                    }
                ],
                attendance: {
                    1: {
                        '2024-01-15': 'P',
                        '2024-01-16': 'P',
                        '2024-01-17': 'T',
                        '2024-01-18': 'P',
                        '2024-01-19': 'P'
                    },
                    2: {
                        '2024-01-15': 'P',
                        '2024-01-16': 'P',
                        '2024-01-17': 'P',
                        '2024-01-18': 'P',
                        '2024-01-19': 'A'
                    },
                    3: {
                        '2024-01-15': 'A',
                        '2024-01-16': 'P',
                        '2024-01-17': 'T',
                        '2024-01-18': 'P',
                        '2024-01-19': 'P'
                    }
                },
                observations: {
                    1: [
                        {
                            id: 1,
                            type: 'Comportamiento',
                            text: 'Excelente participación en clase',
                            date: '2024-01-15',
                            createdAt: new Date().toISOString()
                        }
                    ],
                    2: [
                        {
                            id: 2,
                            type: 'Felicitaciones',
                            text: 'Ayudó a un compañero con dificultades',
                            date: '2024-01-16',
                            createdAt: new Date().toISOString()
                        }
                    ],
                    3: [
                        {
                            id: 3,
                            type: 'Académico',
                            text: 'Necesita refuerzo en matemáticas',
                            date: '2024-01-17',
                            createdAt: new Date().toISOString()
                        }
                    ]
                },
                exams: [],
                tasks: [
                    { id: 1, text: 'Revisar exámenes pendientes', completed: false, date: new Date().toISOString().split('T')[0] },
                    { id: 2, text: 'Preparar material para próxima clase', completed: false, date: new Date().toISOString().split('T')[0] },
                    { id: 3, text: 'Contactar padres de Carlos', completed: true, date: new Date().toISOString().split('T')[0] }
                ],
                calendarEvents: {},
                settings: {
                    theme: 'light',
                    language: 'es',
                    notifications: true
                }
            };
            
            localStorage.setItem('casuiteData_demo_user', JSON.stringify(demoData));
        }

        // Authentication Functions
        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showLoginTab() {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegisterTab() {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function registerUser() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (!name || !email || !username || !password || !confirmPassword) {
                showNotification('Por favor complete todos los campos', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Las contraseñas no coinciden', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('La contraseña debe tener al menos 6 caracteres', 'error');
                return;
            }
            
            const existingUsers = JSON.parse(localStorage.getItem('casuiteUsers') || '{}');
            if (existingUsers[username]) {
                showNotification('El nombre de usuario ya existe', 'error');
                return;
            }
            
            const newUser = {
                id: 'user_' + Date.now(),
                name: name,
                email: email,
                username: username,
                password: password,
                createdAt: new Date().toISOString()
            };
            
            existingUsers[username] = newUser;
            localStorage.setItem('casuiteUsers', JSON.stringify(existingUsers));
            
            showNotification('Usuario registrado exitosamente', 'success');
            
            currentUser = newUser;
            initializeUserSession();
        }

        function loginUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showNotification('Por favor ingrese usuario y contraseña', 'error');
                return;
            }
            
            createDemoUser();
            
            const existingUsers = JSON.parse(localStorage.getItem('casuiteUsers') || '{}');
            const user = existingUsers[username];
            
            if (!user) {
                showNotification('Usuario no encontrado. Use "demo" / "123456" para acceder', 'error');
                return;
            }
            
            if (user.password !== password) {
                showNotification('Contraseña incorrecta. Use "demo" / "123456" para acceder', 'error');
                return;
            }
            
            currentUser = user;
            showNotification('¡Bienvenido a CASuite!', 'success');
            initializeUserSession();
        }

        function initializeUserSession() {
            localStorage.setItem('casuiteCurrentUser', JSON.stringify({
                username: currentUser.username,
                timestamp: Date.now()
            }));
            
            loadUserData(currentUser.id);
            updateUserInterface();
            
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            showDashboard();
        }

        function logout() {
            localStorage.removeItem('casuiteCurrentUser');
            currentUser = null;
            currentUserData = null;
            currentClassroom = null;
            currentStudent = null;
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            showAuthScreen();
            showNotification('Sesión cerrada exitosamente', 'success');
        }

        // Data Management Functions
        function loadUserData(userId) {
            const savedData = localStorage.getItem(`casuiteData_${userId}`);
            
            if (savedData) {
                try {
                    currentUserData = JSON.parse(savedData);
                } catch (error) {
                    console.error('Error loading user data:', error);
                    currentUserData = createDefaultUserData();
                }
            } else {
                currentUserData = createDefaultUserData();
            }
        }

        function createDefaultUserData() {
            return {
                classrooms: [],
                students: [],
                attendance: {},
                observations: {},
                exams: [],
                tasks: [
                    { id: 1, text: 'Revisar exámenes pendientes', completed: false, date: new Date().toISOString().split('T')[0] },
                    { id: 2, text: 'Preparar material para próxima clase', completed: false, date: new Date().toISOString().split('T')[0] }
                ],
                calendarEvents: {},
                settings: {
                    theme: 'light',
                    language: 'es',
                    notifications: true
                }
            };
        }

        function saveUserData() {
            if (!currentUser) return;
            
            try {
                localStorage.setItem(`casuiteData_${currentUser.id}`, JSON.stringify(currentUserData));
            } catch (error) {
                console.error('Error saving user data:', error);
                showNotification('Error al guardar los datos', 'error');
            }
        }

        // UI Update Functions
        function updateUserInterface() {
            if (!currentUser) return;
            
            document.getElementById('currentUser').textContent = currentUser.name;
            const avatar = document.getElementById('userAvatar');
            avatar.textContent = currentUser.name.charAt(0).toUpperCase();
        }

        function updatePageTitle(title) {
            document.getElementById('pageTitle').textContent = title;
            document.title = title;
        }

        // Navigation Functions
        function showDashboard() {
            hideAllSections();
            document.getElementById('dashboard').classList.remove('hidden');
            updatePageTitle('CASuite || Dashboard');
            updateDashboardStats();
            loadCalendar();
            loadTasks();
        }

        function showClassrooms() {
            hideAllSections();
            document.getElementById('classroomsSection').classList.remove('hidden');
            updatePageTitle('CASuite || Gestión de Aulas');
            loadClassroomsList();
        }

        function showClassroomDetail(classroomId) {
            const classroom = currentUserData.classrooms.find(c => c.id === classroomId);
            if (!classroom) return;
            
            currentClassroom = classroom;
            hideAllSections();
            document.getElementById('classroomDetailSection').classList.remove('hidden');
            
            const schoolName = getSchoolName(classroom.schoolId);
            updatePageTitle(`CASuite || ${classroom.year}° ${classroom.division} - ${schoolName}`);
            
            loadClassroomDetail();
            showStudentsTab();
        }

        function showAttendance() {
            hideAllSections();
            document.getElementById('attendanceSection').classList.remove('hidden');
            updatePageTitle('CASuite || Control de Asistencia');
            loadAttendanceClassrooms();
        }

        function showReports() {
            hideAllSections();
            document.getElementById('reportsSection').classList.remove('hidden');
            updatePageTitle('CASuite || Informes y Reportes');
        }

        function showExams() {
            hideAllSections();
            document.getElementById('examsSection').classList.remove('hidden');
            updatePageTitle('CASuite || Exámenes');
        }

        function showSettings() {
            hideAllSections();
            document.getElementById('settingsSection').classList.remove('hidden');
            updatePageTitle('CASuite || Configuración');
        }

        function hideAllSections() {
            const sections = [
                'dashboard', 'classroomsSection', 'classroomDetailSection', 'attendanceSection',
                'reportsSection', 'examsSection', 'settingsSection'
            ];
            sections.forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });
        }

        // Dashboard Functions
        function updateDashboardStats() {
            const totalClassrooms = currentUserData.classrooms.length;
            const totalStudents = currentUserData.students.length;
            const attendanceToday = calculateTodayAttendance();
            const averageAttendance = calculateAverageAttendance();
            
            document.getElementById('totalClassrooms').textContent = totalClassrooms;
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('attendanceToday').textContent = attendanceToday;
            document.getElementById('averageAttendance').textContent = averageAttendance + '%';
        }

        function calculateTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            let count = 0;
            
            Object.values(currentUserData.attendance).forEach(studentAttendance => {
                if (studentAttendance[today] === 'P' || studentAttendance[today] === 'T') {
                    count++;
                }
            });
            
            return count;
        }

        function calculateAverageAttendance() {
            if (currentUserData.students.length === 0) return 0;
            
            let totalPercentage = 0;
            let studentsWithAttendance = 0;
            
            currentUserData.students.forEach(student => {
                const percentage = calculateStudentAttendancePercentage(student.id);
                if (percentage > 0) {
                    totalPercentage += percentage;
                    studentsWithAttendance++;
                }
            });
            
            return studentsWithAttendance > 0 ? Math.round(totalPercentage / studentsWithAttendance) : 0;
        }

        function calculateStudentAttendancePercentage(studentId) {
            const studentAttendance = currentUserData.attendance[studentId];
            if (!studentAttendance) return 0;
            
            const records = Object.values(studentAttendance);
            if (records.length === 0) return 0;
            
            const presentCount = records.filter(status => status === 'P' || status === 'T').length;
            return Math.round((presentCount / records.length) * 100);
        }

        // Calendar Functions
        function loadCalendar() {
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const dayNames = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
            
            document.getElementById('calendarMonth').textContent = 
                `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'bg-gray-100 p-2 text-center text-xs font-semibold text-gray-600';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });
            
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day bg-white p-2 text-center text-sm cursor-pointer min-h-8 flex items-center justify-center';
                dayElement.textContent = date.getDate();
                
                if (date.getMonth() !== currentCalendarDate.getMonth()) {
                    dayElement.classList.add('text-gray-400');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                const dateStr = date.toISOString().split('T')[0];
                if (currentUserData.calendarEvents[dateStr]) {
                    dayElement.classList.add('has-event');
                }
                
                grid.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            loadCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            loadCalendar();
        }

        // Tasks Functions
        function loadTasks() {
            const container = document.getElementById('tasksList');
            container.innerHTML = '';
            
            if (currentUserData.tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 italic py-4">
                        No hay tareas pendientes
                    </div>
                `;
                return;
            }
            
            currentUserData.tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'flex items-center space-x-3 py-2';
                taskElement.innerHTML = `
                    <div class="w-4 h-4 border-2 border-gray-300 rounded cursor-pointer ${task.completed ? 'bg-green-500 border-green-500' : ''}" onclick="toggleTask(${task.id})">
                        ${task.completed ? '<span class="text-white text-xs">✓</span>' : ''}
                    </div>
                    <span class="flex-1 text-sm ${task.completed ? 'line-through text-gray-500' : 'text-gray-700'}">${task.text}</span>
                `;
                container.appendChild(taskElement);
            });
        }

        function toggleTask(taskId) {
            const task = currentUserData.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                saveUserData();
                loadTasks();
            }
        }

        function addTask() {
            const text = prompt('Ingrese la nueva tarea:');
            if (text && text.trim()) {
                const newTask = {
                    id: Date.now(),
                    text: text.trim(),
                    completed: false,
                    date: new Date().toISOString().split('T')[0]
                };
                currentUserData.tasks.push(newTask);
                saveUserData();
                loadTasks();
            }
        }

        // Global Search Functions
        function performGlobalSearch() {
            const query = document.getElementById('globalSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('searchResults');
            
            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const results = [];
            
            currentUserData.students.forEach(student => {
                const fullName = `${student.name} ${student.lastName}`.toLowerCase();
                if (fullName.includes(query)) {
                    const classroom = currentUserData.classrooms.find(c => c.id === student.classroomId);
                    results.push({
                        type: 'student',
                        id: student.id,
                        classroomId: student.classroomId,
                        title: `${student.name} ${student.lastName}`,
                        subtitle: classroom ? `${classroom.year}° ${classroom.division} - ${getSchoolName(classroom.schoolId)}` : 'Sin aula asignada'
                    });
                }
            });
            
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="p-4 text-gray-500 text-center">
                        No se encontraron resultados
                    </div>
                `;
            } else {
                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'p-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0';
                    item.onclick = () => selectSearchResult(result);
                    item.innerHTML = `
                        <div class="font-medium text-gray-900">${result.title}</div>
                        <div class="text-sm text-gray-500">${result.subtitle}</div>
                    `;
                    resultsContainer.appendChild(item);
                });
            }
            
            resultsContainer.classList.remove('hidden');
        }

        function selectSearchResult(result) {
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('globalSearch').value = '';
            
            if (result.type === 'student' && result.classroomId) {
                showClassroomDetail(result.classroomId);
                showNotification(`Mostrando aula del estudiante: ${result.title}`, 'success');
            }
        }

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#globalSearch') && !e.target.closest('#searchResults')) {
                document.getElementById('searchResults').classList.add('hidden');
            }
        });

        // Classroom Functions
        function loadClassroomsList() {
            const container = document.getElementById('classroomsList');
            container.innerHTML = '';
            
            if (currentUserData.classrooms.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">No hay aulas registradas</h3>
                        <p class="text-gray-600 mb-6">Comienza creando tu primera aula</p>
                        <button class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" onclick="showAddClassroom()">+ Crear Primera Aula</button>
                    </div>
                `;
                return;
            }
            
            currentUserData.classrooms.forEach(classroom => {
                const students = currentUserData.students.filter(s => s.classroomId === classroom.id);
                const studentCount = students.length;
                const approvedCount = students.filter(s => s.average >= 7).length;
                const attendancePercentage = calculateClassroomAttendance(classroom.id);
                const schoolName = getSchoolName(classroom.schoolId);
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">${classroom.year}° ${classroom.division}</h3>
                            <p class="text-gray-600 mb-4">${schoolName} - ${classroom.shift}</p>
                            
                            <div class="flex flex-wrap gap-3 mb-4">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">${studentCount} estudiantes</span>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">${approvedCount} TEA</span>
                                <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">${attendancePercentage}% asistencia</span>
                            </div>
                            
                            ${classroom.classroomCode ? `
                                <div class="text-sm text-gray-500">
                                    Código Classroom: ${classroom.classroomCode}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="flex space-x-2">
                            <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" onclick="showClassroomDetail(${classroom.id})">
                                Ver Detalle
                            </button>
                            <button class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" onclick="showClassroomDetail(${classroom.id}); setTimeout(() => showAttendanceTab(), 100)">
                                Asistencia
                            </button>
                            <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" onclick="deleteClassroom(${classroom.id})">
                                Eliminar
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function getSchoolName(schoolId) {
            const school = systemData.schools.find(s => s.id === schoolId);
            return school ? school.name : 'Colegio no encontrado';
        }

        function calculateClassroomAttendance(classroomId) {
            const students = currentUserData.students.filter(s => s.classroomId === classroomId);
            if (students.length === 0) return 0;
            
            let totalPercentage = 0;
            let studentsWithAttendance = 0;
            
            students.forEach(student => {
                const percentage = calculateStudentAttendancePercentage(student.id);
                if (percentage > 0) {
                    totalPercentage += percentage;
                    studentsWithAttendance++;
                }
            });
            
            return studentsWithAttendance > 0 ? Math.round(totalPercentage / studentsWithAttendance) : 0;
        }

        function showAddClassroom() {
            showModal('Agregar Nueva Aula', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Año</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="classroomYear">
                                <option value="">Seleccionar año</option>
                                <option value="1">1°</option>
                                <option value="2">2°</option>
                                <option value="3">3°</option>
                                <option value="4">4°</option>
                                <option value="5">5°</option>
                                <option value="6">6°</option>
                                <option value="7">7°</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">División</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="classroomDivision" placeholder="A, B, C...">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Colegio</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="classroomSchool">
                            <option value="">Seleccionar colegio</option>
                            ${systemData.schools.map(school => `<option value="${school.id}">${school.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Turno</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="classroomShift">
                            <option value="">Seleccionar turno</option>
                            <option value="Mañana">Mañana</option>
                            <option value="Tarde">Tarde</option>
                            <option value="Noche">Noche</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Código Classroom (opcional)</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="classroomCode" placeholder="abc123">
                    </div>
                </div>
            `, [
                { text: 'Cancelar', class: 'bg-gray-500 hover:bg-gray-600', onclick: 'closeModal()' },
                { text: 'Crear Aula', class: 'bg-blue-500 hover:bg-blue-600', onclick: 'createClassroom()' }
            ]);
        }

        function createClassroom() {
            const year = document.getElementById('classroomYear').value;
            const division = document.getElementById('classroomDivision').value.trim();
            const schoolId = document.getElementById('classroomSchool').value;
            const shift = document.getElementById('classroomShift').value;
            const classroomCode = document.getElementById('classroomCode').value.trim();
            
            if (!year || !division || !schoolId || !shift) {
                showNotification('Por favor complete los campos obligatorios', 'error');
                return;
            }
            
            const exists = currentUserData.classrooms.find(c => 
                c.year === year && c.division === division && c.schoolId == schoolId && c.shift === shift
            );
            
            if (exists) {
                showNotification('Ya existe un aula con estos datos', 'error');
                return;
            }
            
            const newClassroom = {
                id: Date.now(),
                year: year,
                division: division,
                schoolId: parseInt(schoolId),
                shift: shift,
                classroomCode: classroomCode,
                createdAt: new Date().toISOString()
            };
            
            currentUserData.classrooms.push(newClassroom);
            saveUserData();
            closeModal();
            loadClassroomsList();
            showNotification('Aula creada exitosamente', 'success');
        }

        function deleteClassroom(classroomId) {
            const classroom = currentUserData.classrooms.find(c => c.id === classroomId);
            if (!classroom) return;
            
            const students = currentUserData.students.filter(s => s.classroomId === classroomId);
            
            let message = `¿Está seguro que desea eliminar el aula ${classroom.year}° ${classroom.division}?`;
            if (students.length > 0) {
                message += `\n\nEsto también eliminará ${students.length} estudiante(s) y todos sus datos asociados.`;
            }
            
            if (confirm(message)) {
                currentUserData.classrooms = currentUserData.classrooms.filter(c => c.id !== classroomId);
                
                const studentIds = students.map(s => s.id);
                currentUserData.students = currentUserData.students.filter(s => s.classroomId !== classroomId);
                
                studentIds.forEach(studentId => {
                    delete currentUserData.attendance[studentId];
                    delete currentUserData.observations[studentId];
                });
                
                saveUserData();
                loadClassroomsList();
                showNotification('Aula eliminada exitosamente', 'success');
            }
        }

        // Classroom Detail Functions
        function loadClassroomDetail() {
            if (!currentClassroom) return;
            
            const students = currentUserData.students.filter(s => s.classroomId === currentClassroom.id);
            const schoolName = getSchoolName(currentClassroom.schoolId);
            const attendancePercentage = calculateClassroomAttendance(currentClassroom.id);
            
            document.getElementById('classroomDetailTitle').textContent = 
                `CASuite || ${currentClassroom.year}° ${currentClassroom.division} - ${schoolName}`;
            
            const infoCard = document.getElementById('classroomInfoCard');
            infoCard.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600">${students.length}</div>
                        <div class="text-sm text-gray-600">Estudiantes</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-600">${students.filter(s => s.average >= 7).length}</div>
                        <div class="text-sm text-gray-600">TEA</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-purple-600">${attendancePercentage}%</div>
                        <div class="text-sm text-gray-600">Asistencia</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-orange-600">${currentClassroom.shift}</div>
                        <div class="text-sm text-gray-600">Turno</div>
                    </div>
                </div>
                
                ${currentClassroom.classroomCode ? `
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <div class="text-sm font-medium text-blue-900">Código Google Classroom</div>
                        <div class="text-blue-700">${currentClassroom.classroomCode}</div>
                    </div>
                ` : ''}
            `;
        }

        // Tab Functions
        function showStudentsTab() {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-button')[0].classList.add('active');
            
            document.getElementById('studentsTab').classList.remove('hidden');
            document.getElementById('attendanceTab').classList.add('hidden');
            document.getElementById('observationsTab').classList.add('hidden');
            document.getElementById('gradesTab').classList.add('hidden');
            
            loadStudentsList();
        }

        function showAttendanceTab() {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-button')[1].classList.add('active');
            
            document.getElementById('studentsTab').classList.add('hidden');
            document.getElementById('attendanceTab').classList.remove('hidden');
            document.getElementById('observationsTab').classList.add('hidden');
            document.getElementById('gradesTab').classList.add('hidden');
            
            // Set today's date if not set
            const dateInput = document.getElementById('attendanceDate');
            if (dateInput && !dateInput.value) {
                dateInput.value = currentAttendanceDate;
            }
            
            loadAttendanceForDate();
        }

        function showObservationsTab() {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-button')[2].classList.add('active');
            
            document.getElementById('studentsTab').classList.add('hidden');
            document.getElementById('attendanceTab').classList.add('hidden');
            document.getElementById('observationsTab').classList.remove('hidden');
            document.getElementById('gradesTab').classList.add('hidden');
            
            loadObservationsList();
        }

        function showGradesTab() {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-button')[3].classList.add('active');
            
            document.getElementById('studentsTab').classList.add('hidden');
            document.getElementById('attendanceTab').classList.add('hidden');
            document.getElementById('observationsTab').classList.add('hidden');
            document.getElementById('gradesTab').classList.remove('hidden');
        }

        // Students Functions
        function loadStudentsList() {
            if (!currentClassroom) return;
            
            const container = document.getElementById('studentsList');
            const students = currentUserData.students.filter(s => s.classroomId === currentClassroom.id);
            
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-xl flex items-center justify-center text-3xl mx-auto mb-4">👥</div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">No hay estudiantes registrados</h3>
                        <p class="text-gray-600 mb-6">Comienza agregando estudiantes a esta aula</p>
                        <button class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" onclick="showAddStudent()">+ Agregar Primer Estudiante</button>
                    </div>
                `;
                return;
            }
            
            // Sort students by last name, then by name
            students.sort((a, b) => {
                const lastNameCompare = a.lastName.localeCompare(b.lastName);
                if (lastNameCompare !== 0) return lastNameCompare;
                return a.name.localeCompare(b.name);
            });
            
            students.forEach(student => {
                const attendancePercentage = calculateStudentAttendancePercentage(student.id);
                const observations = currentUserData.observations[student.id] || [];
                
                const card = document.createElement('div');
                card.className = 'student-card bg-white border border-gray-200 rounded-lg p-4 mb-4';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-semibold">
                                    ${student.name.charAt(0)}${student.lastName.charAt(0)}
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">${student.lastName}, ${student.name}</h4>
                                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                                        ${student.isRepeater ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Recursante</span>' : '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Regular</span>'}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-500">Promedio:</span>
                                    <span class="font-medium ${student.average >= 7 ? 'text-green-600' : student.average >= 4 ? 'text-yellow-600' : 'text-red-600'}">${student.average.toFixed(1)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Asistencia:</span>
                                    <span class="font-medium">${attendancePercentage}%</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Observaciones:</span>
                                    <span class="font-medium">${observations.length}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors" onclick="showStudentDetail(${student.id})">
                                Ver
                            </button>
                            <button class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors" onclick="showAddObservationForStudent(${student.id})">
                                Obs.
                            </button>
                            <button class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors" onclick="deleteStudent(${student.id})">
                                Eliminar
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function showAddStudent() {
            if (!currentClassroom) return;
            
            showModal('Agregar Nuevo Estudiante', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="studentName" placeholder="Nombre del estudiante">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Apellido</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="studentLastName" placeholder="Apellido del estudiante">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Promedio Inicial</label>
                            <input type="number" min="1" max="10" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="studentAverage" placeholder="7.0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="studentStatus">
                                <option value="false">Regular</option>
                                <option value="true">Recursante</option>
                            </select>
                        </div>
                    </div>
                </div>
            `, [
                { text: 'Cancelar', class: 'bg-gray-500 hover:bg-gray-600', onclick: 'closeModal()' },
                { text: 'Agregar Estudiante', class: 'bg-green-500 hover:bg-green-600', onclick: 'createStudent()' }
            ]);
        }

        function createStudent() {
            const name = document.getElementById('studentName').value.trim();
            const lastName = document.getElementById('studentLastName').value.trim();
            const average = parseFloat(document.getElementById('studentAverage').value) || 7.0;
            const isRepeater = document.getElementById('studentStatus').value === 'true';
            
            if (!name || !lastName) {
                showNotification('Por favor complete nombre y apellido', 'error');
                return;
            }
            
            if (average < 1 || average > 10) {
                showNotification('El promedio debe estar entre 1 y 10', 'error');
                return;
            }
            
            const exists = currentUserData.students.find(s => 
                s.name.toLowerCase() === name.toLowerCase() && 
                s.lastName.toLowerCase() === lastName.toLowerCase() && 
                s.classroomId === currentClassroom.id
            );
            
            if (exists) {
                showNotification('Ya existe un estudiante con ese nombre en esta aula', 'error');
                return;
            }
            
            const newStudent = {
                id: Date.now(),
                name: name,
                lastName: lastName,
                classroomId: currentClassroom.id,
                isRepeater: isRepeater,
                average: average,
                createdAt: new Date().toISOString()
            };
            
            currentUserData.students.push(newStudent);
            
            // Initialize attendance and observations for the new student
            currentUserData.attendance[newStudent.id] = {};
            currentUserData.observations[newStudent.id] = [];
            
            saveUserData();
            closeModal();
            loadStudentsList();
            loadClassroomDetail(); // Update stats
            showNotification('Estudiante agregado exitosamente', 'success');
        }

        function deleteStudent(studentId) {
            const student = currentUserData.students.find(s => s.id === studentId);
            if (!student) return;
            
            if (confirm(`¿Está seguro que desea eliminar al estudiante ${student.name} ${student.lastName}?\n\nEsto eliminará todos sus datos de asistencia y observaciones.`)) {
                currentUserData.students = currentUserData.students.filter(s => s.id !== studentId);
                delete currentUserData.attendance[studentId];
                delete currentUserData.observations[studentId];
                
                saveUserData();
                loadStudentsList();
                loadClassroomDetail(); // Update stats
                showNotification('Estudiante eliminado exitosamente', 'success');
            }
        }

        function showStudentDetail(studentId) {
            const student = currentUserData.students.find(s => s.id === studentId);
            if (!student) return;
            
            const attendancePercentage = calculateStudentAttendancePercentage(studentId);
            const observations = currentUserData.observations[studentId] || [];
            const attendanceRecords = currentUserData.attendance[studentId] || {};
            
            const presentCount = Object.values(attendanceRecords).filter(status => status === 'P').length;
            const absentCount = Object.values(attendanceRecords).filter(status => status === 'A').length;
            const lateCount = Object.values(attendanceRecords).filter(status => status === 'T').length;
            const justifiedCount = Object.values(attendanceRecords).filter(status => status === 'J').length;
            
            showModal(`Detalle del Estudiante: ${student.name} ${student.lastName}`, `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600">Estado Académico</div>
                            <div class="text-lg font-semibold ${student.isRepeater ? 'text-yellow-600' : 'text-green-600'}">
                                ${student.isRepeater ? 'Recursante' : 'Regular'}
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600">Promedio</div>
                            <div class="text-lg font-semibold ${student.average >= 7 ? 'text-green-600' : student.average >= 4 ? 'text-yellow-600' : 'text-red-600'}">
                                ${student.average.toFixed(1)}
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-3">Resumen de Asistencia</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-green-50 p-3 rounded-lg">
                                <div class="text-sm text-green-600">Presente</div>
                                <div class="text-xl font-bold text-green-700">${presentCount}</div>
                            </div>
                            <div class="bg-red-50 p-3 rounded-lg">
                                <div class="text-sm text-red-600">Ausente</div>
                                <div class="text-xl font-bold text-red-700">${absentCount}</div>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <div class="text-sm text-yellow-600">Tardanza</div>
                                <div class="text-xl font-bold text-yellow-700">${lateCount}</div>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <div class="text-sm text-blue-600">Justificado</div>
                                <div class="text-xl font-bold text-blue-700">${justifiedCount}</div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <span class="text-sm text-gray-600">Porcentaje de asistencia: </span>
                            <span class="font-semibold text-lg">${attendancePercentage}%</span>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-3">Observaciones Recientes (${observations.length})</h4>
                        <div class="max-h-32 overflow-y-auto space-y-2">
                            ${observations.length === 0 ? 
                                '<div class="text-gray-500 text-sm italic">No hay observaciones registradas</div>' :
                                observations.slice(-3).map(obs => `
                                    <div class="bg-gray-50 p-2 rounded text-sm">
                                        <div class="font-medium text-gray-900">${obs.type}</div>
                                        <div class="text-gray-600">${obs.text}</div>
                                        <div class="text-xs text-gray-500">${new Date(obs.date).toLocaleDateString('es-ES')}</div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `, [
                { text: 'Cerrar', class: 'bg-gray-500 hover:bg-gray-600', onclick: 'closeModal()' }
            ]);
        }

        // Attendance Functions
        function loadAttendanceForDate() {
            if (!currentClassroom) return;
            
            const dateInput = document.getElementById('attendanceDate');
            const selectedDate = dateInput ? dateInput.value : currentAttendanceDate;
            
            if (!selectedDate) {
                showNotification('Por favor seleccione una fecha', 'error');
                return;
            }
            
            currentAttendanceDate = selectedDate;
            
            const container = document.getElementById('attendanceList');
            const students = currentUserData.students.filter(s => s.classroomId === currentClassroom.id);
            
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">No hay estudiantes en esta aula para tomar asistencia</p>
                    </div>
                `;
                return;
            }
            
            // Sort students by last name
            students.sort((a, b) => {
                const lastNameCompare = a.lastName.localeCompare(b.lastName);
                if (lastNameCompare !== 0) return lastNameCompare;
                return a.name.localeCompare(b.name);
            });
            
            students.forEach(student => {
                const currentStatus = currentUserData.attendance[student.id] ? 
                    currentUserData.attendance[student.id][selectedDate] || '' : '';
                
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between py-3 px-4 border-b border-gray-200 last:border-b-0';
                row.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-semibold text-sm">
                            ${student.name.charAt(0)}${student.lastName.charAt(0)}
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">${student.lastName}, ${student.name}</div>
                            <div class="text-sm text-gray-500">${student.isRepeater ? 'Recursante' : 'Regular'}</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <div class="attendance-status ${currentStatus === 'P' ? 'present' : ''}" onclick="setAttendance(${student.id}, 'P', '${selectedDate}')" title="Presente">
                            P
                        </div>
                        <div class="attendance-status ${currentStatus === 'A' ? 'absent' : ''}" onclick="setAttendance(${student.id}, 'A', '${selectedDate}')" title="Ausente">
                            A
                        </div>
                        <div class="attendance-status ${currentStatus === 'T' ? 'late' : ''}" onclick="setAttendance(${student.id}, 'T', '${selectedDate}')" title="Tardanza">
                            T
                        </div>
                        <div class="attendance-status ${currentStatus === 'J' ? 'justified' : ''}" onclick="setAttendance(${student.id}, 'J', '${selectedDate}')" title="Justificado">
                            J
                        </div>
                    </div>
                `;
                
                container.appendChild(row);
            });
        }

        function setAttendance(studentId, status, date) {
            if (!currentUserData.attendance[studentId]) {
                currentUserData.attendance[studentId] = {};
            }
            
            // Toggle status if clicking the same one
            if (currentUserData.attendance[studentId][date] === status) {
                delete currentUserData.attendance[studentId][date];
            } else {
                currentUserData.attendance[studentId][date] = status;
            }
            
            saveUserData();
            loadAttendanceForDate();
            loadClassroomDetail(); // Update stats
        }

        // Observations Functions
        function loadObservationsList() {
            if (!currentClassroom) return;
            
            const container = document.getElementById('observationsList');
            const students = currentUserData.students.filter(s => s.classroomId === currentClassroom.id);
            
            // Collect all observations from all students in the classroom
            let allObservations = [];
            students.forEach(student => {
                const studentObservations = currentUserData.observations[student.id] || [];
                studentObservations.forEach(obs => {
                    allObservations.push({
                        ...obs,
                        studentId: student.id,
                        studentName: `${student.name} ${student.lastName}`
                    });
                });
            });
            
            // Sort by date (newest first)
            allObservations.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = '';
            
            if (allObservations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-xl flex items-center justify-center text-3xl mx-auto mb-4">📝</div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">No hay observaciones registradas</h3>
                        <p class="text-gray-600 mb-6">Las observaciones aparecerán aquí cuando las agregues</p>
                    </div>
                `;
                return;
            }
            
            allObservations.forEach(observation => {
                const card = document.createElement('div');
                card.className = `observation-card bg-white border border-gray-200 rounded-lg p-4 mb-4 ${observation.type.toLowerCase()}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-medium">${observation.type}</span>
                                <span class="text-sm text-gray-500">${new Date(observation.date).toLocaleDateString('es-ES')}</span>
                            </div>
                            <div class="font-medium text-gray-900 mb-1">${observation.studentName}</div>
                            <div class="text-gray-700">${observation.text}</div>
                        </div>
                        <button class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors" onclick="deleteObservation(${observation.studentId}, ${observation.id})">
                            Eliminar
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function showAddObservation() {
            if (!currentClassroom) return;
            
            const students = currentUserData.students.filter(s => s.classroomId === currentClassroom.id);
            
            if (students.length === 0) {
                showNotification('No hay estudiantes en esta aula para agregar observaciones', 'error');
                return;
            }
            
            showModal('Agregar Nueva Observación', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estudiante</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="observationStudent">
                            <option value="">Seleccionar estudiante</option>
                            ${students.sort((a, b) => a.lastName.localeCompare(b.lastName)).map(student => 
                                `<option value="${student.id}">${student.lastName}, ${student.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Observación</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="observationType">
                            ${systemData.observationTypes.map(type => 
                                `<option value="${type}">${type}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
                        <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="observationDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observación</label>
                        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="observationText" rows="4" placeholder="Describe la observación..."></textarea>
                    </div>
                </div>
            `, [
                { text: 'Cancelar', class: 'bg-gray-500 hover:bg-gray-600', onclick: 'closeModal()' },
                { text: 'Agregar Observación', class: 'bg-blue-500 hover:bg-blue-600', onclick: 'createObservation()' }
            ]);
        }

        function showAddObservationForStudent(studentId) {
            const student = currentUserData.students.find(s => s.id === studentId);
            if (!student) return;
            
            showModal(`Agregar Observación - ${student.name} ${student.lastName}`, `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Observación</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="observationType">
                            ${systemData.observationTypes.map(type => 
                                `<option value="${type}">${type}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
                        <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="observationDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observación</label>
                        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="observationText" rows="4" placeholder="Describe la observación..."></textarea>
                    </div>
                    
                    <input type="hidden" id="observationStudent" value="${studentId}">
                </div>
            `, [
                { text: 'Cancelar', class: 'bg-gray-500 hover:bg-gray-600', onclick: 'closeModal()' },
                { text: 'Agregar Observación', class: 'bg-blue-500 hover:bg-blue-600', onclick: 'createObservation()' }
            ]);
        }

        function createObservation() {
            const studentId = parseInt(document.getElementById('observationStudent').value);
            const type = document.getElementById('observationType').value;
            const date = document.getElementById('observationDate').value;
            const text = document.getElementById('observationText').value.trim();
            
            if (!studentId || !type || !date || !text) {
                showNotification('Por favor complete todos los campos', 'error');
                return;
            }
            
            const newObservation = {
                id: Date.now(),
                type: type,
                text: text,
                date: date,
                createdAt: new Date().toISOString()
            };
            
            if (!currentUserData.observations[studentId]) {
                currentUserData.observations[studentId] = [];
            }
            
            currentUserData.observations[studentId].push(newObservation);
            
            saveUserData();
            closeModal();
            loadObservationsList();
            loadStudentsList(); // Update student cards
            showNotification('Observación agregada exitosamente', 'success');
        }

        function deleteObservation(studentId, observationId) {
            if (confirm('¿Está seguro que desea eliminar esta observación?')) {
                if (currentUserData.observations[studentId]) {
                    currentUserData.observations[studentId] = currentUserData.observations[studentId].filter(obs => obs.id !== observationId);
                }
                
                saveUserData();
                loadObservationsList();
                loadStudentsList(); // Update student cards
                showNotification('Observación eliminada exitosamente', 'success');
            }
        }

        // Attendance Section Functions
        function loadAttendanceClassrooms() {
            const container = document.getElementById('attendanceClassroomsList');
            container.innerHTML = '';
            
            if (currentUserData.classrooms.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">No hay aulas disponibles para tomar asistencia</p>
                    </div>
                `;
                return;
            }
            
            currentUserData.classrooms.forEach(classroom => {
                const students = currentUserData.students.filter(s => s.classroomId === classroom.id);
                const studentCount = students.length;
                const schoolName = getSchoolName(classroom.schoolId);
                
                const item = document.createElement('div');
                item.className = 'menu-item bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer';
                item.onclick = () => {
                    showClassroomDetail(classroom.id);
                    setTimeout(() => showAttendanceTab(), 100);
                };
                item.innerHTML = `
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl mb-4">🏫</div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">${classroom.year}° ${classroom.division} - ${schoolName}</h3>
                    <p class="text-gray-600 text-sm">${studentCount} estudiantes - ${classroom.shift}</p>
                `;
                
                container.appendChild(item);
            });
        }

        // Report Functions
        function generateStudentReport() {
            showNotification('Generando reporte de estudiantes...', 'info');
            
            setTimeout(() => {
                let report = 'REPORTE DE ESTUDIANTES\n';
                report += '='.repeat(50) + '\n\n';
                
                currentUserData.classrooms.forEach(classroom => {
                    const students = currentUserData.students.filter(s => s.classroomId === classroom.id);
                    const schoolName = getSchoolName(classroom.schoolId);
                    
                    report += `${classroom.year}° ${classroom.division} - ${schoolName}\n`;
                    report += '-'.repeat(30) + '\n';
                    
                    if (students.length === 0) {
                        report += 'No hay estudiantes registrados\n\n';
                    } else {
                        students.sort((a, b) => {
                            const lastNameCompare = a.lastName.localeCompare(b.lastName);
                            if (lastNameCompare !== 0) return lastNameCompare;
                            return a.name.localeCompare(b.name);
                        }).forEach((student, index) => {
                            const attendancePercentage = calculateStudentAttendancePercentage(student.id);
                            const observations = currentUserData.observations[student.id] || [];
                            report += `${index + 1}. ${student.lastName}, ${student.name}\n`;
                            report += `   Estado: ${student.isRepeater ? 'Recursante' : 'Regular'}\n`;
                            report += `   Promedio: ${student.average.toFixed(1)}\n`;
                            report += `   Asistencia: ${attendancePercentage}%\n`;
                            report += `   Observaciones: ${observations.length}\n\n`;
                        });
                    }
                });
                
                report += `Generado el: ${new Date().toLocaleString('es-ES')}\n`;
                report += `Usuario: ${currentUser.name}`;
                
                downloadReport('reporte_estudiantes.txt', report);
                showNotification('Reporte generado exitosamente', 'success');
            }, 1000);
        }

        function generateAttendanceReport() {
            showNotification('Funcionalidad disponible próximamente', 'info');
        }

        function generateGradeReport() {
            showNotification('Funcionalidad disponible próximamente', 'info');
        }

        function downloadReport(filename, content) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // Settings Functions
        function showProfileSettings() {
            showNotification('Funcionalidad disponible próximamente', 'info');
        }

        function showSchoolSettings() {
            showNotification('Funcionalidad disponible próximamente', 'info');
        }

        function showSystemSettings() {
            showNotification('Funcionalidad disponible próximamente', 'info');
        }

        function showAddExam() {
            showNotification('Funcionalidad disponible próximamente', 'info');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9698407db4f92569',t:'MTc1NDI0OTY2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
