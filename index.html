<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cátedra Abierta Suite - Sistema de Gestión Docente</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier Prime', monospace;
            background: #000080;
            color: #FFFFFF;
            overflow: hidden;
            height: 100vh;
        }
        
        .dos-screen {
            width: 100vw;
            height: 100vh;
            background: #000080;
            position: relative;
            padding: 0;
        }
        
        .dos-header {
            background: #008080;
            color: #FFFFFF;
            padding: 2px 10px;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 2px solid #FFFFFF;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
        }
        
        .system-logo {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        
        .dos-content {
            padding: 20px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }
        
        .login-box {
            background: #000080;
            padding: 20px;
            margin: 50px auto;
            max-width: 500px;
        }
        
        .main-menu {
            background: #000080;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
        }
        
        .dos-input {
            background: #FFFFFF;
            color: #000000;
            border: 2px inset #C0C0C0;
            padding: 5px;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            width: 100%;
            margin: 5px 0;
        }
        
        .dos-button {
            background: #C0C0C0;
            color: #000000;
            border: 2px outset #C0C0C0;
            padding: 8px 16px;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
        }
        
        .dos-button:hover {
            background: #E0E0E0;
        }
        
        .dos-button:active {
            border: 2px inset #C0C0C0;
        }
        
        .menu-item {
            padding: 10px;
            border: 1px solid #FFFFFF;
            margin: 5px 0;
            cursor: pointer;
            background: #000080;
            transition: background 0.2s;
        }
        
        .menu-item:hover {
            background: #0000FF;
            color: #FFFF00;
        }
        
        .dos-table {
            border: 2px solid #FFFFFF;
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        
        .dos-table th, .dos-table td {
            border: 1px solid #FFFFFF;
            padding: 8px;
            text-align: left;
        }
        
        .dos-table th {
            background: #008080;
        }
        
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #008080;
            color: #FFFFFF;
            padding: 5px 10px;
            font-size: 12px;
            border-top: 2px solid #FFFFFF;
        }
        
        .hidden {
            display: none;
        }
        
        .dos-form {
            background: #000080;
            padding: 20px;
            margin: 20px 0;
        }
        
        .form-row {
            margin: 10px 0;
        }
        
        .form-label {
            display: inline-block;
            width: 150px;
            color: #FFFFFF;
        }
        
        .cursor-blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .repeater-row {
            background-color: #404040 !important;
            color: #FFFFFF;
        }
        
        .repeater-row td {
            background-color: #404040 !important;
        }
        
        .loading-animation {
            font-size: 12px;
            line-height: 1.2;
            color: #00FFFF;
            text-align: center;
            margin: 20px 0;
            font-family: 'Courier Prime', monospace;
            white-space: pre;
        }
        
        .loading-bar {
            animation: loadingProgress 3s ease-in-out infinite;
        }
        
        @keyframes loadingProgress {
            0% { transform: translateX(-100px); }
            50% { transform: translateX(0px); }
            100% { transform: translateX(100px); }
        }
    </style>
</head>
<body>
    <div class="dos-screen">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="dos-header">
                <img src="https://i.imgur.com/Hgur4W6.png" alt="Logo" class="system-logo">
                Cátedra Abierta Suite - Acceso al Sistema
            </div>
            <div class="dos-content">

                
                <div class="login-box">
                    <h2>CA Suite ║ ACCESO AL SISTEMA</h2>
                    <br>
                    
                    <div class="form-row">
                        <label class="form-label">Usuario:</label>
                        <input type="text" id="username" class="dos-input" placeholder="Ingrese su nombre de usuario">
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="dos-button" onclick="login()">[ INGRESAR ]</button>
                        <button class="dos-button" onclick="clearForm()">[ LIMPIAR ]</button>
                    </div>
                    
                    <div style="margin-top: 20px; font-size: 12px; color: #00FFFF;">
                        <p><strong>Bienvenido(a) a Cátedra Abierta Suite</strong></p>
                        <p>Tu nueva herramienta de gestión docente diseñada para</p>
                        <p>acompañarte en cada paso de tu labor educativa.</p>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 12px; color: #FFFF00;">
                        <p>Simplemente ingrese su nombre de usuario para acceder</p>
                        <p>Ejemplos: admin, profesor, secretaria, etc.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main System -->
        <div id="mainSystem" class="hidden">
            <div class="dos-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="https://i.imgur.com/Hgur4W6.png" alt="Logo" class="system-logo">
                    Cátedra Abierta Suite - Usuario: <span id="currentUser"></span> | <span id="currentTime"></span>
                </div>
                <button onclick="refreshApplication()" class="dos-button" style="padding: 2px 8px; font-size: 12px; background: #008080; color: #FFFFFF; border: 1px solid #FFFFFF;" title="Actualizar aplicación">
                    🔄
                </button>
            </div>
            <div class="dos-content">
                <!-- Main Menu -->
                <div id="mainMenu">
                    <div class="main-menu">
                        <h2>CA Suite ║ MENÚ PRINCIPAL</h2>
                        <br>
                        
                        <div class="menu-item" onclick="showClassroomManager()">
                            [1] AULAS
                        </div>
                        <div class="menu-item" onclick="showAttendanceManager()">
                            [2] CONTROL DE ASISTENCIA
                        </div>
                        <div class="menu-item" onclick="showReports()">
                            [3] INFORMES Y REPORTES
                        </div>
                        <div class="menu-item" onclick="showSettings()">
                            [4] CONFIGURACIÓN DEL SISTEMA
                        </div>
                        <div class="menu-item" onclick="logout()" style="color: #FF0000;">
                            [0] SALIR DEL SISTEMA
                        </div>
                    </div>
                </div>

                <!-- Classroom Manager -->
                <div id="classroomManager" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ AULAS</h2>
                        <br>
                        
                        <button class="dos-button" onclick="showManageClassrooms()">[ GESTIONAR AULAS ]</button>
                        <button class="dos-button" onclick="showMainMenu()">[ VOLVER AL MENÚ ]</button>
                        <br><br>
                        
                        <div id="classroomList">
                            <!-- Classrooms will be loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Classroom Detail -->
                <div id="classroomDetail" class="hidden">
                    <div class="main-menu">
                        <h2 id="classroomDetailTitle">CA Suite ║ DETALLE DEL AULA</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>AULA:</strong> <span id="currentClassroom">No asignada</span><br>
                            <strong>COLEGIO:</strong> <span id="currentSchool">No asignado</span><br>
                            <strong>TURNO:</strong> <span id="currentShift"></span><br>
                            <strong>TOTAL ESTUDIANTES:</strong> <span id="totalStudents">0</span><br>
                            <strong>TEA (≥7):</strong> <span id="approvedStudents">0</span> (<span id="approvalPercentage">0%</span>)<br>
                            <strong>CÓDIGO CLASSROOM:</strong> <a href="#" id="currentClassroomLink" onclick="openClassroomLink(event)" style="color: #FFFF00; text-decoration: underline;"><span id="currentClassroomCode">No asignado</span></a>
                        </div>
                        
                        <button class="dos-button" onclick="showAddStudent()" style="padding: 4px 8px; font-size: 12px; margin: 2px;">[ AGREGAR ]</button>
                        <button class="dos-button" onclick="showImportExcel()" style="padding: 4px 8px; font-size: 12px; margin: 2px;">[ IMPORTAR LISTA ]</button>
                        <button class="dos-button" onclick="showExamManager()" style="padding: 4px 8px; font-size: 12px; margin: 2px;">[ EXÁMENES ]</button>
                        <button class="dos-button" onclick="showRepeatersTab()" style="padding: 4px 8px; font-size: 12px; margin: 2px;">[ RECURSANTES ]</button>
                        <button class="dos-button" onclick="showEditClassroom()" style="padding: 4px 8px; font-size: 12px; margin: 2px;">[ EDITAR AULA ]</button>
                        <button class="dos-button" onclick="showClassroomManager()" style="padding: 4px 8px; font-size: 12px; margin: 2px;">[ VOLVER A AULAS ]</button>
                        <button class="dos-button" onclick="showMainMenu()" style="padding: 4px 8px; font-size: 12px; margin: 2px;">[ MENÚ PRINCIPAL ]</button>
                        <br><br>
                        
                        <table class="dos-table">
                            <thead id="studentTableHeader">
                                <tr>
                                    <th>APELLIDO, NOMBRE</th>
                                    <th style="text-align: center;">⚙️</th>
                                </tr>
                            </thead>
                            <tbody id="studentList">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Repeaters Tab -->
                <div id="repeatersTab" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ RECURSANTES</h2>
                        <br>
                        
                        <button class="dos-button" onclick="showClassroomDetail()">[ VOLVER AL AULA ]</button>
                        <br><br>
                        
                        <table class="dos-table">
                            <thead>
                                <tr>
                                    <th>NOMBRE</th>
                                    <th>APELLIDO</th>
                                    <th>COLEGIO ANTERIOR</th>
                                    <th>AÑO ANTERIOR</th>
                                    <th>MOTIVO</th>
                                    <th>FECHA INGRESO</th>
                                </tr>
                            </thead>
                            <tbody id="repeatersList">
                                <tr>
                                    <td>CARLOS</td>
                                    <td>RODRÍGUEZ</td>
                                    <td>INSTITUTO RIVADAVIA</td>
                                    <td>1°B</td>
                                    <td>REPITENCIA</td>
                                    <td>15/03/2024</td>
                                </tr>
                                <tr>
                                    <td>ANA</td>
                                    <td>MARTÍNEZ</td>
                                    <td>COLEGIO NACIONAL</td>
                                    <td>1°A</td>
                                    <td>CAMBIO DE DOMICILIO</td>
                                    <td>20/02/2024</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Add Student Form -->
                <div id="addStudentForm" class="hidden">
                    <div class="dos-form">
                        <h2>CA Suite ║ AGREGAR ESTUDIANTE</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>AGREGANDO ESTUDIANTE AL AULA:</strong> <span id="studentFormClassroom"></span><br>
                            <strong>COLEGIO:</strong> <span id="studentFormSchool"></span>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Nombre:</label>
                            <input type="text" id="studentName" class="dos-input" placeholder="Ingrese el nombre del estudiante">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Apellido:</label>
                            <input type="text" id="studentLastName" class="dos-input" placeholder="Ingrese el apellido del estudiante">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Fecha Nacimiento:</label>
                            <input type="date" id="studentBirth" class="dos-input">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">¿Es recursante?</label>
                            <select id="isRepeater" class="dos-input" onchange="toggleRepeaterFields()">
                                <option value="no">NO</option>
                                <option value="yes">SÍ</option>
                            </select>
                        </div>
                        
                        <div id="repeaterFields" class="hidden">
                            <div class="form-row">
                                <label class="form-label">Colegio Anterior:</label>
                                <input type="text" id="previousSchool" class="dos-input">
                            </div>
                            
                            <div class="form-row">
                                <label class="form-label">Año Anterior:</label>
                                <input type="text" id="previousYear" class="dos-input">
                            </div>
                            
                            <div class="form-row">
                                <label class="form-label">Motivo:</label>
                                <select id="repeaterReason" class="dos-input">
                                    <option value="">Seleccionar motivo</option>
                                    <option value="REPITENCIA">REPITENCIA</option>
                                    <option value="CAMBIO DE DOMICILIO">CAMBIO DE DOMICILIO</option>
                                    <option value="CAMBIO DE COLEGIO">CAMBIO DE COLEGIO</option>
                                    <option value="OTROS">OTROS</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="dos-button" onclick="saveStudent()">[ GUARDAR ]</button>
                            <button class="dos-button" onclick="showClassroomDetail()">[ CANCELAR ]</button>
                        </div>
                    </div>
                </div>

                <!-- Create Classroom Form -->
                <div id="createClassroomForm" class="hidden">
                    <div class="dos-form">
                        <h2>CA Suite ║ CREAR NUEVA AULA</h2>
                        <br>
                        
                        <div class="form-row">
                            <label class="form-label">Año:</label>
                            <input type="number" id="newClassroomYear" class="dos-input" placeholder="Ej: 1, 2, 3, etc." min="1" max="12">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">División:</label>
                            <input type="text" id="newClassroomDivision" class="dos-input" placeholder="Ej: A, B, C, etc.">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Colegio:</label>
                            <input type="text" id="newClassroomSchool" class="dos-input" placeholder="Escriba el nombre del colegio" list="schoolsList">
                            <datalist id="schoolsList">
                                <option value="COLEGIO SAN MARTÍN">
                                <option value="COLEGIO BELGRANO">
                                <option value="INSTITUTO MORENO">
                                <option value="INSTITUTO RIVADAVIA">
                                <option value="COLEGIO NACIONAL">
                            </datalist>
                            <button type="button" class="dos-button" onclick="showAddSchool()" style="margin-top: 5px;">[ AGREGAR NUEVO COLEGIO ]</button>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Turno:</label>
                            <select id="newClassroomShift" class="dos-input">
                                <option value="">Seleccionar turno</option>
                                <option value="MAÑANA">MAÑANA</option>
                                <option value="TARDE">TARDE</option>
                                <option value="VESPERTINO">VESPERTINO</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Código Classroom:</label>
                            <input type="text" id="newClassroomCode" class="dos-input" placeholder="Código de Google Classroom (opcional)">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Enlace Classroom:</label>
                            <input type="url" id="newClassroomLink" class="dos-input" placeholder="https://classroom.google.com/c/...">
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="dos-button" onclick="saveClassroom()">[ CREAR AULA ]</button>
                            <button class="dos-button" onclick="showClassroomManager()">[ CANCELAR ]</button>
                        </div>
                    </div>
                </div>

                <!-- Exam Manager -->
                <div id="examManager" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ EXÁMENES</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>AULA:</strong> <span id="examClassroom"></span><br>
                            <strong>COLEGIO:</strong> <span id="examSchool"></span>
                        </div>
                        
                        <button class="dos-button" onclick="showCreateExam()">[ CREAR EXAMEN ]</button>
                        <button class="dos-button" onclick="returnToCurrentClassroom()">[ VOLVER AL AULA ]</button>
                        <button class="dos-button" onclick="goBack()">[ VOLVER ]</button>
                        <br><br>
                        
                        <table class="dos-table">
                            <thead>
                                <tr>
                                    <th>FECHA</th>
                                    <th>MATERIA</th>
                                    <th>TÍTULO</th>
                                    <th>TIPO</th>
                                    <th style="text-align: center;">⚙️</th>
                                </tr>
                            </thead>
                            <tbody id="examList">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Create Exam Form -->
                <div id="createExamForm" class="hidden">
                    <div class="dos-form">
                        <h2>CA Suite ║ CREAR EXAMEN</h2>
                        <br>
                        
                        <div class="form-row">
                            <label class="form-label">Título del Examen:</label>
                            <input type="text" id="examTitle" class="dos-input" placeholder="Ej: Primer Parcial de Matemáticas">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Materia:</label>
                            <select id="examSubject" class="dos-input">
                                <option value="">Seleccionar materia</option>
                                <option value="MATEMÁTICAS">MATEMÁTICAS</option>
                                <option value="LENGUA">LENGUA</option>
                                <option value="CIENCIAS NATURALES">CIENCIAS NATURALES</option>
                                <option value="CIENCIAS SOCIALES">CIENCIAS SOCIALES</option>
                                <option value="INGLÉS">INGLÉS</option>
                                <option value="EDUCACIÓN FÍSICA">EDUCACIÓN FÍSICA</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Fecha:</label>
                            <input type="date" id="examDate" class="dos-input">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Cuatrimestre:</label>
                            <select id="examSemester" class="dos-input">
                                <option value="">Seleccionar cuatrimestre</option>
                                <option value="1">PRIMER CUATRIMESTRE</option>
                                <option value="2">SEGUNDO CUATRIMESTRE</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Tipo:</label>
                            <select id="examType" class="dos-input" onchange="showExamTypeDescription()">
                                <option value="">Seleccionar tipo</option>
                                <option value="EXAMEN ESCRITO">EXAMEN ESCRITO</option>
                                <option value="EXAMEN ORAL">EXAMEN ORAL</option>
                                <option value="PUESTA GRUPAL">PUESTA GRUPAL</option>
                                <option value="EXAMEN INTEGRADOR">EXAMEN INTEGRADOR</option>
                                <option value="INTENSIFICACIÓN">INTENSIFICACIÓN</option>
                                <option value="RECUPERATORIO">RECUPERATORIO</option>
                                <option value="EVALUACIONES DIAGNÓSTICAS">EVALUACIONES DIAGNÓSTICAS</option>
                            </select>
                        </div>
                        
                        <div id="examTypeDescription" class="form-row" style="display: none;">
                            <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF; font-size: 12px;">
                                <strong>DESCRIPCIÓN:</strong><br>
                                <span id="typeDescriptionText"></span>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Contenidos a evaluar:</label>
                            <textarea id="examDescription" class="dos-input" rows="3" placeholder="Contenidos y temas a evaluar en este examen..."></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="dos-button" onclick="saveExam()">[ CREAR EXAMEN ]</button>
                            <button class="dos-button" onclick="goBack()">[ CANCELAR ]</button>
                        </div>
                    </div>
                </div>

                <!-- Add School Form -->
                <div id="addSchoolForm" class="hidden">
                    <div class="dos-form">
                        <h2>CA Suite ║ AGREGAR NUEVO COLEGIO</h2>
                        <br>
                        
                        <div class="form-row">
                            <label class="form-label">Nombre del Colegio:</label>
                            <input type="text" id="newSchoolName" class="dos-input" placeholder="Escriba el nombre completo del colegio">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Dirección:</label>
                            <input type="text" id="newSchoolAddress" class="dos-input" placeholder="Dirección del colegio (opcional)">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Teléfono:</label>
                            <input type="text" id="newSchoolPhone" class="dos-input" placeholder="Teléfono de contacto (opcional)">
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="dos-button" onclick="saveNewSchool()">[ AGREGAR COLEGIO ]</button>
                            <button class="dos-button" onclick="showCreateClassroom()">[ CANCELAR ]</button>
                        </div>
                    </div>
                </div>

                <!-- Import Excel Form -->
                <div id="importExcelForm" class="hidden">
                    <div class="dos-form">
                        <h2>CA Suite ║ IMPORTAR DESDE EXCEL/CSV</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>INSTRUCCIONES:</strong><br>
                            • Formato: Apellido, Nombre (uno por línea)<br>
                            • Ejemplo: García López, Juan Carlos<br>
                            • Los estudiantes se asignarán automáticamente al aula actual
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Lista de Estudiantes:</label>
                            <textarea id="excelData" class="dos-input" rows="10" placeholder="Pegue aquí la lista de estudiantes:
García López, Juan Carlos
Martínez Silva, María Elena
Rodríguez, Carlos Alberto
Fernández, Ana Sofía"></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="dos-button" onclick="importStudents()">[ IMPORTAR ]</button>
                            <button class="dos-button" onclick="returnToClassroomFromImport()">[ VOLVER AL AULA ]</button>
                            <button class="dos-button" onclick="goBack()">[ CANCELAR ]</button>
                        </div>
                    </div>
                </div>

                <!-- Edit Classroom Form -->
                <div id="editClassroomForm" class="hidden">
                    <div class="dos-form">
                        <h2>CA Suite ║ EDITAR AULA</h2>
                        <br>
                        
                        <div class="form-row">
                            <label class="form-label">Año:</label>
                            <input type="number" id="editClassroomYear" class="dos-input" min="1" max="12">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">División:</label>
                            <input type="text" id="editClassroomDivision" class="dos-input">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Colegio:</label>
                            <input type="text" id="editClassroomSchool" class="dos-input">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Turno:</label>
                            <select id="editClassroomShift" class="dos-input">
                                <option value="">Seleccionar turno</option>
                                <option value="MAÑANA">MAÑANA</option>
                                <option value="TARDE">TARDE</option>
                                <option value="VESPERTINO">VESPERTINO</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Código Classroom:</label>
                            <input type="text" id="editClassroomCode" class="dos-input">
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Enlace Classroom:</label>
                            <input type="url" id="editClassroomLink" class="dos-input" placeholder="https://classroom.google.com/c/...">
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="dos-button" onclick="updateClassroom()">[ ACTUALIZAR ]</button>
                            <button class="dos-button" onclick="goBack()">[ VOLVER ]</button>
                        </div>
                    </div>
                </div>

                <!-- Student Notes Form -->
                <div id="studentNotesForm" class="hidden">
                    <div class="dos-form">
                        <h2>CA Suite ║ AGREGAR NOTA ESTUDIANTE</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>ESTUDIANTE:</strong> <span id="noteStudentName"></span>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Tipo de Nota:</label>
                            <select id="noteType" class="dos-input">
                                <option value="">Seleccionar tipo</option>
                                <option value="SANCIÓN">SANCIÓN</option>
                                <option value="OBSERVACIÓN">OBSERVACIÓN</option>
                                <option value="RECONOCIMIENTO">RECONOCIMIENTO</option>
                                <option value="LLAMADO DE ATENCIÓN">LLAMADO DE ATENCIÓN</option>
                                <option value="FELICITACIÓN">FELICITACIÓN</option>
                                <option value="CITACIÓN A PADRES">CITACIÓN A PADRES</option>
                                <option value="SUSPENSIÓN">SUSPENSIÓN</option>
                                <option value="AMONESTACIÓN">AMONESTACIÓN</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Nivel de Gravedad:</label>
                            <select id="noteLevel" class="dos-input">
                                <option value="">Seleccionar nivel</option>
                                <option value="LEVE">LEVE</option>
                                <option value="MODERADA">MODERADA</option>
                                <option value="GRAVE">GRAVE</option>
                                <option value="MUY GRAVE">MUY GRAVE</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Descripción:</label>
                            <textarea id="noteDescription" class="dos-input" rows="4" placeholder="Describa detalladamente la situación..."></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="dos-button" onclick="saveStudentNote()">[ GUARDAR NOTA ]</button>
                            <button class="dos-button" onclick="showStudentNotesHistory(currentStudentId)">[ VER HISTORIAL ]</button>
                            <button class="dos-button" onclick="showClassroomDetail()">[ CANCELAR ]</button>
                        </div>
                    </div>
                </div>

                <!-- Student Detail Page -->
                <div id="studentDetail" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ DETALLE DEL ESTUDIANTE</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>ESTUDIANTE:</strong> <span id="detailStudentName"></span><br>
                            <strong>AULA:</strong> <span id="detailStudentClassroom"></span><br>
                            <strong>PROMEDIO:</strong> <span id="detailStudentAverage"></span><br>
                            <strong>ESTADO:</strong> <span id="detailStudentStatus"></span>
                        </div>
                        
                        <div class="menu-item" onclick="showAddStudentNote(currentStudentId)">
                            [1] AGREGAR NOTA
                        </div>
                        <div class="menu-item" onclick="showStudentNotesHistory(currentStudentId)">
                            [2] VER HISTORIAL DE NOTAS
                        </div>
                        <div class="menu-item" onclick="editStudentInfo(currentStudentId)">
                            [3] EDITAR INFORMACIÓN
                        </div>
                        <div class="menu-item" onclick="showStudentGrades(currentStudentId)">
                            [4] CALIFICACIONES
                        </div>
                        <div class="menu-item" onclick="showStudentAttendance(currentStudentId)">
                            [5] ASISTENCIA
                        </div>
                        <div class="menu-item" onclick="deleteStudent(currentStudentId)" style="color: #FF0000;">
                            [6] ELIMINAR ESTUDIANTE
                        </div>
                        <div class="menu-item" onclick="showClassroomDetail()">
                            [0] VOLVER AL AULA
                        </div>
                    </div>
                </div>

                <!-- Exam Grades -->
                <div id="examGrades" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ CALIFICACIONES DEL EXAMEN</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>EXAMEN:</strong> <span id="gradeExamTitle"></span><br>
                            <strong>MATERIA:</strong> <span id="gradeExamSubject"></span><br>
                            <strong>FECHA:</strong> <span id="gradeExamDate"></span><br>
                            <strong>AULA:</strong> <span id="gradeExamClassroom"></span>
                        </div>
                        
                        <button class="dos-button" onclick="goBack()">[ VOLVER ]</button>
                        <button class="dos-button" onclick="saveAllGrades()">[ GUARDAR TODAS LAS NOTAS ]</button>
                        <br><br>
                        
                        <table class="dos-table">
                            <thead>
                                <tr>
                                    <th>ESTUDIANTE</th>
                                    <th>CALIFICACIÓN</th>
                                    <th>OBSERVACIONES</th>
                                </tr>
                            </thead>
                            <tbody id="examGradesList">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Student Notes History -->
                <div id="studentNotesHistory" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ HISTORIAL DE NOTAS</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>ESTUDIANTE:</strong> <span id="historyStudentName"></span>
                        </div>
                        
                        <button class="dos-button" onclick="showAddStudentNote(currentStudentId)">[ AGREGAR NOTA ]</button>
                        <button class="dos-button" onclick="generateStudentNotePDF(currentStudentId)">[ GENERAR PDF ]</button>
                        <button class="dos-button" onclick="returnToCurrentClassroom()">[ VOLVER AL AULA ]</button>
                        <br><br>
                        
                        <table class="dos-table">
                            <thead>
                                <tr>
                                    <th>FECHA</th>
                                    <th>HORA</th>
                                    <th>TIPO</th>
                                    <th>NIVEL</th>
                                    <th>DESCRIPCIÓN</th>
                                </tr>
                            </thead>
                            <tbody id="notesHistoryList">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Grade Manager -->
                <div id="gradeManager" class="hidden">
                    <div class="main-menu">
                        <h2>CALIFICACIONES</h2>
                        <br>
                        
                        <button class="dos-button" onclick="showManageClassrooms()">[ GESTIONAR AULAS ]</button>
                        <button class="dos-button" onclick="showMainMenu()">[ VOLVER AL MENÚ ]</button>
                        <br><br>
                        
                        <table class="dos-table">
                            <thead>
                                <tr>
                                    <th>ESTUDIANTE</th>
                                    <th>MATEMÁTICAS</th>
                                    <th>ESPAÑOL</th>
                                    <th>CIENCIAS</th>
                                    <th>PROMEDIO</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>JUAN PÉREZ</td>
                                    <td>8.5</td>
                                    <td>9.0</td>
                                    <td>7.8</td>
                                    <td>8.4</td>
                                </tr>
                                <tr>
                                    <td>MARÍA GARCÍA</td>
                                    <td>9.2</td>
                                    <td>8.7</td>
                                    <td>9.5</td>
                                    <td>9.1</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Attendance Manager -->
                <div id="attendanceManager" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ CONTROL DE ASISTENCIA</h2>
                        <br>
                        
                        <button class="dos-button" onclick="showMainMenu()">[ VOLVER AL MENÚ ]</button>
                        <br><br>
                        
                        <div id="attendanceClassroomList">
                            <h3>SELECCIONAR AULA PARA TOMAR ASISTENCIA:</h3>
                            <br>
                            <!-- Classrooms will be loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Attendance Date Selection -->
                <div id="attendanceDateSelection" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ FECHA DE ASISTENCIA</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>AULA SELECCIONADA:</strong> <span id="attendanceSelectedClassroom"></span><br>
                            <strong>COLEGIO:</strong> <span id="attendanceSelectedSchool"></span>
                        </div>
                        
                        <h3>¿PARA QUÉ FECHA DESEA TOMAR LA ASISTENCIA?</h3>
                        <br>
                        
                        <button class="dos-button" onclick="selectCurrentDate()" style="margin: 10px; padding: 15px;">[ FECHA ACTUAL ]</button>
                        <button class="dos-button" onclick="selectCustomDate()" style="margin: 10px; padding: 15px;">[ OTRA FECHA ]</button>
                        <br><br>
                        
                        <div id="customDateInput" class="hidden">
                            <div class="form-row">
                                <label class="form-label">Fecha:</label>
                                <input type="date" id="customAttendanceDate" class="dos-input">
                            </div>
                            <br>
                            <button class="dos-button" onclick="confirmCustomDate()">[ CONFIRMAR FECHA ]</button>
                        </div>
                        
                        <button class="dos-button" onclick="showAttendanceManager()">[ VOLVER ]</button>
                    </div>
                </div>

                <!-- Individual Attendance Taking -->
                <div id="individualAttendance" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ TOMANDO ASISTENCIA</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>AULA:</strong> <span id="attendanceCurrentClassroom"></span><br>
                            <strong>FECHA:</strong> <span id="attendanceCurrentDate"></span><br>
                            <strong>PROGRESO:</strong> <span id="attendanceProgress">0/0</span>
                        </div>
                        
                        <div style="text-align: center; margin: 30px 0;">
                            <h3 style="font-size: 24px; color: #FFFF00; margin-bottom: 20px;">
                                <span id="currentStudentName">ESTUDIANTE</span>
                            </h3>
                            
                            <div style="margin: 30px 0;">
                                <button class="dos-button" onclick="markAttendance('P')" style="background: #00AA00; color: #FFFFFF; margin: 10px; padding: 20px 30px; font-size: 18px;">
                                    [ PRESENTE ]
                                </button>
                                <button class="dos-button" onclick="markAttendance('A')" style="background: #AA0000; color: #FFFFFF; margin: 10px; padding: 20px 30px; font-size: 18px;">
                                    [ AUSENTE ]
                                </button>
                                <button class="dos-button" onclick="markAttendance('T')" style="background: #AA6600; color: #FFFFFF; margin: 10px; padding: 20px 30px; font-size: 18px;">
                                    [ TARDE ]
                                </button>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="dos-button" onclick="cancelAttendance()">[ CANCELAR ]</button>
                        </div>
                    </div>
                </div>

                <!-- Attendance Results -->
                <div id="attendanceResults" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ REGISTRO DE ASISTENCIA</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>AULA:</strong> <span id="resultsClassroom"></span><br>
                            <strong>FECHA:</strong> <span id="resultsDate"></span><br>
                            <strong>TOTAL ESTUDIANTES:</strong> <span id="resultsTotal">0</span><br>
                            <strong>PRESENTES:</strong> <span id="resultsPresent">0</span> | 
                            <strong>AUSENTES:</strong> <span id="resultsAbsent">0</span> | 
                            <strong>TARDANZAS:</strong> <span id="resultsLate">0</span>
                        </div>
                        
                        <button class="dos-button" onclick="showAttendanceView()">[ VER REGISTRO COMPLETO ]</button>
                        <button class="dos-button" onclick="showAttendanceManager()">[ NUEVA ASISTENCIA ]</button>
                        <button class="dos-button" onclick="showMainMenu()">[ MENÚ PRINCIPAL ]</button>
                        <br><br>
                        
                        <table class="dos-table">
                            <thead>
                                <tr>
                                    <th>ESTUDIANTE</th>
                                    <th>% ASIST.</th>
                                    <th id="attendanceTableHeader">FECHA</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceResultsList">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Full Attendance View -->
                <div id="attendanceView" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ REGISTRO COMPLETO DE ASISTENCIA</h2>
                        <br>
                        
                        <div style="background: #008080; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>AULA:</strong> <span id="viewClassroom"></span><br>
                            <strong>COLEGIO:</strong> <span id="viewSchool"></span><br>
                            <strong>TOTAL ESTUDIANTES:</strong> <span id="viewTotal">0</span>
                        </div>
                        
                        <button class="dos-button" onclick="showAttendanceManager()">[ NUEVA ASISTENCIA ]</button>
                        <button class="dos-button" onclick="exportAttendanceReport()">[ EXPORTAR REPORTE ]</button>
                        <button class="dos-button" onclick="showMainMenu()">[ MENÚ PRINCIPAL ]</button>
                        <br><br>
                        
                        <div style="overflow-x: auto;">
                            <table class="dos-table">
                                <thead id="fullAttendanceHeader">
                                    <tr>
                                        <th>ESTUDIANTE</th>
                                        <th>% ASIST.</th>
                                        <!-- Date columns will be added dynamically -->
                                    </tr>
                                </thead>
                                <tbody id="fullAttendanceList">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manage Classrooms -->
                <div id="manageClassrooms" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ GESTIONAR AULAS</h2>
                        <br>
                        
                        <div class="menu-item" onclick="showCreateClassroom()">
                            [1] CREAR AULA
                        </div>
                        <div class="menu-item" onclick="showMergeClassrooms()">
                            [2] FUSIONAR AULAS
                        </div>
                        <div class="menu-item" onclick="showMoveStudents()">
                            [3] MOVER ESTUDIANTES ENTRE AULAS
                        </div>
                        <div class="menu-item" onclick="showClassroomStatistics()">
                            [4] ESTADÍSTICAS DE AULAS
                        </div>
                        <div class="menu-item" onclick="showArchiveClassrooms()">
                            [5] ARCHIVAR AULAS
                        </div>
                        <div class="menu-item" onclick="showDeleteClassrooms()" style="color: #FF0000;">
                            [6] ELIMINAR AULAS
                        </div>
                        <div class="menu-item" onclick="showClassroomManager()">
                            [0] VOLVER A AULAS
                        </div>
                    </div>
                </div>

                <!-- Delete Classrooms -->
                <div id="deleteClassrooms" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ ELIMINAR AULAS</h2>
                        <br>
                        
                        <div style="background: #FF0000; color: #FFFFFF; padding: 10px; margin: 10px 0; border: 1px solid #FFFFFF;">
                            <strong>⚠️ ADVERTENCIA:</strong><br>
                            • La eliminación de un aula es PERMANENTE<br>
                            • Se eliminarán TODOS los estudiantes del aula<br>
                            • Se eliminarán TODAS las notas de los estudiantes<br>
                            • Esta acción NO se puede deshacer
                        </div>
                        
                        <button class="dos-button" onclick="showManageClassrooms()">[ VOLVER A GESTIÓN ]</button>
                        <br><br>
                        
                        <div id="deleteClassroomList">
                            <!-- Classrooms for deletion will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Reports -->
                <div id="reports" class="hidden">
                    <div class="main-menu">
                        <h2>CA Suite ║ INFORMES Y REPORTES</h2>
                        <br>
                        
                        <div class="menu-item" onclick="generateStudentReport()">
                            [1] REPORTE DE ESTUDIANTES
                        </div>
                        <div class="menu-item" onclick="generateGradeReport()">
                            [2] REPORTE DE CALIFICACIONES
                        </div>
                        <div class="menu-item" onclick="generateAttendanceReport()">
                            [3] REPORTE DE ASISTENCIA
                        </div>
                        <div class="menu-item" onclick="showMainMenu()">
                            [0] VOLVER AL MENÚ PRINCIPAL
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <span id="statusText">Sistema listo | F1=Ayuda | ESC=Salir</span>
            <span style="float: right;">Cátedra Abierta Suite</span>
        </div>
    </div>

    <script>
        let currentUser = '';
        let students = [
            {id: 1, name: 'JUAN', lastName: 'PÉREZ', year: '1', division: 'A', school: 'COLEGIO SAN MARTÍN', isRepeater: false},
            {id: 2, name: 'MARÍA', lastName: 'GARCÍA', year: '1', division: 'B', school: 'COLEGIO SAN MARTÍN', isRepeater: false},
            {id: 3, name: 'CARLOS', lastName: 'RODRÍGUEZ', year: '1', division: 'A', school: 'COLEGIO SAN MARTÍN', isRepeater: true, previousSchool: 'INSTITUTO RIVADAVIA', previousYear: '1°B', reason: 'REPITENCIA'},
            {id: 4, name: 'ANA', lastName: 'MARTÍNEZ', year: '2', division: 'A', school: 'COLEGIO BELGRANO', isRepeater: true, previousSchool: 'COLEGIO NACIONAL', previousYear: '1°A', reason: 'CAMBIO DE DOMICILIO'},
            {id: 5, name: 'LUIS', lastName: 'GONZÁLEZ', year: '2', division: 'B', school: 'COLEGIO BELGRANO', isRepeater: false},
            {id: 6, name: 'SOFIA', lastName: 'LÓPEZ', year: '3', division: 'A', school: 'INSTITUTO MORENO', isRepeater: false}
        ];

        // Update time
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', {hour12: false});
            const dateString = now.toLocaleDateString('es-ES');
            
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            
            if (timeElement) timeElement.textContent = timeString;
            if (dateElement) dateElement.textContent = dateString;
        }

        // Login function
        function login() {
            const username = document.getElementById('username').value;
            
            if (username.trim()) {
                currentUser = username.toUpperCase();
                document.getElementById('currentUser').textContent = currentUser;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainSystem').classList.remove('hidden');
                updateStatus('Acceso exitoso - Bienvenido ' + currentUser);
            } else {
                alert('Por favor ingrese un nombre de usuario');
                updateStatus('Error de acceso - Ingrese usuario');
            }
        }

        // Clear login form
        function clearForm() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Logout
        function logout() {
            if (confirm('¿Está seguro que desea salir del sistema?')) {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainSystem').classList.add('hidden');
                clearForm();
                updateStatus('Sesión cerrada');
            }
        }

        // Navigation stack for proper back functionality
        let navigationStack = ['mainMenu'];
        
        function pushNavigation(screen) {
            navigationStack.push(screen);
        }
        
        function goBack() {
            if (navigationStack.length > 1) {
                navigationStack.pop(); // Remove current screen
                const previousScreen = navigationStack[navigationStack.length - 1];
                
                hideAllScreens();
                
                // Special handling for screens that need data refresh
                if (previousScreen === 'classroomManager') {
                    document.getElementById('classroomManager').classList.remove('hidden');
                    loadClassroomList();
                } else if (previousScreen === 'classroomDetail') {
                    // Refresh classroom detail if we have the info
                    if (currentClassroomName && currentSchoolName) {
                        showClassroomDetail(currentClassroomName, currentSchoolName);
                        return; // Don't update status twice
                    } else {
                        document.getElementById('classroomDetail').classList.remove('hidden');
                    }
                } else if (previousScreen === 'mainMenu') {
                    document.getElementById('mainMenu').classList.remove('hidden');
                } else if (previousScreen === 'examManager') {
                    document.getElementById('examManager').classList.remove('hidden');
                    loadExamList();
                } else if (previousScreen === 'examGrades') {
                    document.getElementById('examGrades').classList.remove('hidden');
                } else if (previousScreen === 'studentDetail') {
                    document.getElementById('studentDetail').classList.remove('hidden');
                } else if (previousScreen === 'studentNotesHistory') {
                    document.getElementById('studentNotesHistory').classList.remove('hidden');
                } else {
                    // Default case - just show the screen
                    const element = document.getElementById(previousScreen);
                    if (element) {
                        element.classList.remove('hidden');
                    }
                }
                
                updateStatus('Navegación: volviendo atrás');
            }
        }

        // Navigation functions
        function showMainMenu() {
            navigationStack = ['mainMenu'];
            hideAllScreens();
            document.getElementById('mainMenu').classList.remove('hidden');
            updateStatus('Menú principal activo');
        }

        function showClassroomManager() {
            pushNavigation('classroomManager');
            hideAllScreens();
            document.getElementById('classroomManager').classList.remove('hidden');
            loadClassroomList();
            updateStatus('Gestión de aulas activa');
        }

        function showClassroomDetail(classroom, school) {
            console.log('=== SHOWING CLASSROOM DETAIL ===');
            console.log('Classroom:', classroom);
            console.log('School:', school);
            console.log('Current students array:', students);
            console.log('Current classrooms array:', classrooms);
            
            pushNavigation('classroomDetail');
            hideAllScreens();
            document.getElementById('classroomDetail').classList.remove('hidden');
            
            // Find classroom object
            const classroomObj = classrooms.find(c => c.name === classroom && c.school === school);
            console.log('Found classroom object:', classroomObj);
            
            if (classroomObj) {
                currentClassroomId = classroomObj.id;
            }
            
            // Store current classroom info for navigation
            currentClassroomName = classroom || '';
            currentSchoolName = school || '';
            
            // Update classroom info
            document.getElementById('currentClassroom').textContent = classroom || '';
            document.getElementById('currentSchool').textContent = school || '';
            document.getElementById('currentShift').textContent = classroomObj ? classroomObj.shift : '';
            
            // Update title with classroom and school info
            document.getElementById('classroomDetailTitle').textContent = `CA Suite ║ ${classroom} ${school}`;
            
            // Display classroom code and link
            const code = classroomObj ? (classroomObj.classroomCode || 'No asignado') : 'No asignado';
            const link = classroomObj ? classroomObj.classroomLink : '';
            
            document.getElementById('currentClassroomCode').textContent = code;
            const linkElement = document.getElementById('currentClassroomLink');
            if (link && code !== 'No asignado') {
                linkElement.href = link;
                linkElement.style.color = '#FFFF00';
                linkElement.style.textDecoration = 'underline';
            } else {
                linkElement.href = '#';
                linkElement.style.color = '#FFFFFF';
                linkElement.style.textDecoration = 'none';
            }
            
            // Filter students for this classroom
            console.log('Filtering students for classroom:', classroom, 'school:', school);
            const classroomStudents = students.filter(s => {
                const studentClassroom = s.year + '°' + s.division;
                const matches = studentClassroom === classroom && s.school === school;
                console.log(`Student ${s.name} ${s.lastName}: ${studentClassroom} === ${classroom} && ${s.school} === ${school} = ${matches}`);
                return matches;
            });
            
            console.log('Filtered classroom students:', classroomStudents);
            
            // Calculate statistics based on TEA/TEP/TED system
            const total = classroomStudents.length;
            let teaCount = 0;
            let tepCount = 0;
            let tedCount = 0;
            let sinCalificar = 0;
            
            classroomStudents.forEach(student => {
                // Calculate average from exam grades
                const studentGrades = [];
                exams.forEach(exam => {
                    if (exam.grades && exam.grades[student.id] && exam.grades[student.id].grade !== null) {
                        studentGrades.push(exam.grades[student.id].grade);
                    }
                });
                
                if (studentGrades.length > 0) {
                    const calculatedAverage = studentGrades.reduce((sum, grade) => sum + grade, 0) / studentGrades.length;
                    if (calculatedAverage >= 7) {
                        teaCount++;
                    } else if (calculatedAverage >= 4 && calculatedAverage < 7) {
                        tepCount++;
                    } else if (calculatedAverage < 4) {
                        tedCount++;
                    }
                } else {
                    sinCalificar++;
                }
            });
            
            const teaPercentage = total > 0 ? Math.round((teaCount / total) * 100) : 0;
            
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('approvedStudents').textContent = teaCount;
            document.getElementById('approvalPercentage').textContent = teaPercentage + '%';
            
            console.log('Calling updateStudentList with:', classroomStudents);
            updateStudentList(classroomStudents);
            updateStatus(`Aula ${classroom} - ${school} activa (${total} estudiantes)`);
        }

        function showRepeatersTab() {
            pushNavigation('repeatersTab');
            hideAllScreens();
            document.getElementById('repeatersTab').classList.remove('hidden');
            updateStatus('Módulo de recursantes activo');
        }

        function showAddStudent() {
            pushNavigation('addStudentForm');
            hideAllScreens();
            document.getElementById('addStudentForm').classList.remove('hidden');
            
            // Set current classroom info in form - check if elements exist
            const classroomEl = document.getElementById('currentClassroom');
            const schoolEl = document.getElementById('currentSchool');
            const formClassroomEl = document.getElementById('studentFormClassroom');
            const formSchoolEl = document.getElementById('studentFormSchool');
            
            if (classroomEl && schoolEl && formClassroomEl && formSchoolEl) {
                const classroom = classroomEl.textContent;
                const school = schoolEl.textContent;
                formClassroomEl.textContent = classroom;
                formSchoolEl.textContent = school;
            }
            
            updateStatus('Formulario de nuevo estudiante');
        }

        function showGradeManager() {
            hideAllScreens();
            document.getElementById('gradeManager').classList.remove('hidden');
            updateStatus('Gestión de calificaciones activa');
        }

        function showAttendanceManager() {
            pushNavigation('attendanceManager');
            hideAllScreens();
            document.getElementById('attendanceManager').classList.remove('hidden');
            loadAttendanceClassroomList();
            updateStatus('Control de asistencia activo');
        }

        function showReports() {
            pushNavigation('reports');
            hideAllScreens();
            document.getElementById('reports').classList.remove('hidden');
            updateStatus('Módulo de reportes activo');
        }

        function showSettings() {
            alert('Módulo de configuración en desarrollo');
            updateStatus('Configuración - En desarrollo');
        }

        function hideAllScreens() {
            const screens = ['mainMenu', 'classroomManager', 'classroomDetail', 'repeatersTab', 'addStudentForm', 'createClassroomForm', 'createExamForm', 'editClassroomForm', 'studentNotesForm', 'studentNotesHistory', 'addSchoolForm', 'importExcelForm', 'gradeManager', 'attendanceManager', 'attendanceDateSelection', 'individualAttendance', 'attendanceResults', 'attendanceView', 'reports', 'studentDetail', 'manageClassrooms', 'deleteClassrooms', 'examGrades', 'examManager'];
            screens.forEach(screen => {
                const element = document.getElementById(screen);
                if (element) {
                    element.classList.add('hidden');
                }
            });
        }

        // Show student detail page
        function showStudentDetail(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            currentStudentId = studentId;
            pushNavigation('studentDetail');
            hideAllScreens();
            document.getElementById('studentDetail').classList.remove('hidden');
            
            // Update student info
            document.getElementById('detailStudentName').textContent = `${student.name} ${student.lastName}`;
            document.getElementById('detailStudentId').textContent = `${student.name} ${student.lastName}`;
            document.getElementById('detailStudentClassroom').textContent = `${student.year}°${student.division} - ${student.school}`;
            
            // Calculate average from exam grades
            const studentGrades = [];
            exams.forEach(exam => {
                if (exam.grades && exam.grades[student.id] && exam.grades[student.id].grade !== null) {
                    studentGrades.push(exam.grades[student.id].grade);
                }
            });
            
            let averageDisplay = 'Sin calificar';
            let calculatedAverage = null;
            let status = 'SIN CALIFICAR';
            let statusColor = '#FFFF00';
            
            if (studentGrades.length > 0) {
                calculatedAverage = studentGrades.reduce((sum, grade) => sum + grade, 0) / studentGrades.length;
                averageDisplay = calculatedAverage.toFixed(1);
                
                // TEA/TEP/TED system
                if (calculatedAverage >= 7) {
                    status = 'TEA';
                    statusColor = '#00FF00';
                } else if (calculatedAverage >= 4 && calculatedAverage < 7) {
                    status = 'TEP';
                    statusColor = '#FFFF00';
                } else if (calculatedAverage < 4) {
                    status = 'TED';
                    statusColor = '#FF0000';
                }
            }
            
            document.getElementById('detailStudentAverage').textContent = averageDisplay;
            const statusElement = document.getElementById('detailStudentStatus');
            statusElement.textContent = status;
            statusElement.style.color = statusColor;
            
            updateStatus(`Detalle del estudiante: ${student.name} ${student.lastName}`);
        }

        // Show manage classrooms page
        function showManageClassrooms() {
            pushNavigation('manageClassrooms');
            hideAllScreens();
            document.getElementById('manageClassrooms').classList.remove('hidden');
            updateStatus('Gestión avanzada de aulas');
        }

        // Placeholder functions for student detail options
        function editStudentInfo(studentId) {
            alert('Función de edición de información en desarrollo');
        }

        function showStudentGrades(studentId) {
            alert('Función de calificaciones en desarrollo');
        }

        function showStudentAttendance(studentId) {
            alert('Función de asistencia en desarrollo');
        }

        // Show delete classrooms page
        function showDeleteClassrooms() {
            pushNavigation('deleteClassrooms');
            hideAllScreens();
            document.getElementById('deleteClassrooms').classList.remove('hidden');
            loadDeleteClassroomList();
            updateStatus('Módulo de eliminación de aulas - ¡PRECAUCIÓN!');
        }

        // Load classrooms for deletion
        function loadDeleteClassroomList() {
            const deleteList = document.getElementById('deleteClassroomList');
            deleteList.innerHTML = '';
            
            if (classrooms.length === 0) {
                deleteList.innerHTML = '<p style="color: #FFFF00; text-align: center;">No hay aulas disponibles para eliminar</p>';
                return;
            }
            
            classrooms.forEach((classroom, index) => {
                // Calculate students count
                const classroomStudents = students.filter(s => 
                    s.year + '°' + s.division === classroom.name && s.school === classroom.school
                );
                const studentCount = classroomStudents.length;
                
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.style.display = 'flex';
                menuItem.style.justifyContent = 'space-between';
                menuItem.style.alignItems = 'center';
                menuItem.style.backgroundColor = '#800000'; // Dark red background
                
                const span = document.createElement('span');
                span.style.flex = '1';
                span.textContent = `[${index + 1}] ${classroom.name} - ${classroom.school} (${studentCount} estudiantes)`;
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'dos-button';
                deleteButton.style.marginLeft = '10px';
                deleteButton.style.background = '#FF0000';
                deleteButton.style.color = '#FFFFFF';
                deleteButton.style.fontWeight = 'bold';
                deleteButton.textContent = '🗑️ ELIMINAR';
                deleteButton.addEventListener('click', function() {
                    confirmDeleteClassroom(classroom.id);
                });
                
                menuItem.appendChild(span);
                menuItem.appendChild(deleteButton);
                deleteList.appendChild(menuItem);
            });
        }

        // Confirm and delete classroom
        function confirmDeleteClassroom(classroomId) {
            const classroom = classrooms.find(c => c.id === classroomId);
            if (!classroom) return;
            
            // Calculate students and notes that will be deleted
            const classroomStudents = students.filter(s => 
                s.year + '°' + s.division === classroom.name && s.school === classroom.school
            );
            const studentCount = classroomStudents.length;
            
            let totalNotes = 0;
            classroomStudents.forEach(student => {
                const notes = studentNotes[student.id] || [];
                totalNotes += notes.length;
            });
            
            // Show detailed confirmation
            let confirmMessage = `⚠️ CONFIRMACIÓN DE ELIMINACIÓN ⚠️\n\n`;
            confirmMessage += `AULA A ELIMINAR: ${classroom.name} - ${classroom.school}\n`;
            confirmMessage += `TURNO: ${classroom.shift}\n\n`;
            confirmMessage += `SE ELIMINARÁN DEL SITIO WEB:\n`;
            confirmMessage += `• ${studentCount} estudiantes\n`;
            confirmMessage += `• ${totalNotes} notas de estudiantes\n`;
            confirmMessage += `• Toda la información del aula\n\n`;
            confirmMessage += `NOTA: Solo se eliminan los datos del sitio web.\n`;
            confirmMessage += `Google Classroom NO se verá afectado.\n\n`;
            confirmMessage += `Esta acción es IRREVERSIBLE.\n\n`;
            confirmMessage += `¿Desea continuar con la eliminación?`;
            
            if (confirm(confirmMessage)) {
                // Direct execution without additional prompt
                executeClassroomDeletion(classroomId, classroom, classroomStudents);
            } else {
                updateStatus('Eliminación cancelada por el usuario');
            }
        }

        // Execute the actual deletion
        function executeClassroomDeletion(classroomId, classroom, classroomStudents) {
            try {
                // Count notes before deletion
                let totalNotesDeleted = 0;
                const studentIds = classroomStudents.map(s => s.id);
                studentIds.forEach(studentId => {
                    const notes = studentNotes[studentId] || [];
                    totalNotesDeleted += notes.length;
                });
                
                // Remove classroom
                classrooms = classrooms.filter(c => c.id !== classroomId);
                
                // Remove students from this classroom
                students = students.filter(s => !studentIds.includes(s.id));
                
                // Remove notes for students from this classroom
                studentIds.forEach(studentId => {
                    delete studentNotes[studentId];
                });
                
                // Save changes
                saveData();
                
                // Show success message
                let successMessage = `✅ ELIMINACIÓN COMPLETADA\n\n`;
                successMessage += `AULA ELIMINADA: ${classroom.name} - ${classroom.school}\n`;
                successMessage += `ESTUDIANTES ELIMINADOS: ${classroomStudents.length}\n`;
                successMessage += `NOTAS ELIMINADAS: ${totalNotesDeleted}\n\n`;
                successMessage += `La eliminación se ha completado exitosamente.`;
                
                alert(successMessage);
                
                // Refresh the delete list
                loadDeleteClassroomList();
                updateStatus(`Aula ${classroom.name} - ${classroom.school} eliminada exitosamente`);
                
            } catch (error) {
                alert('Error durante la eliminación. Por favor intente nuevamente.');
                updateStatus('Error durante la eliminación del aula');
                console.error('Deletion error:', error);
            }
        }

        // Placeholder functions for manage classrooms options
        function showMergeClassrooms() {
            alert('Función de fusionar aulas en desarrollo');
        }

        function showMoveStudents() {
            alert('Función de mover estudiantes en desarrollo');
        }

        function showClassroomStatistics() {
            alert('Función de estadísticas en desarrollo');
        }

        function showArchiveClassrooms() {
            alert('Función de archivar aulas en desarrollo');
        }

        // Student management functions
        function saveStudent() {
            const name = document.getElementById('studentName').value;
            const lastName = document.getElementById('studentLastName').value;
            const isRepeater = document.getElementById('isRepeater').value === 'yes';
            
            // Get current classroom info - check if elements exist
            const classroomEl = document.getElementById('currentClassroom');
            const schoolEl = document.getElementById('currentSchool');
            
            if (!classroomEl || !schoolEl) {
                alert('Error: No se puede determinar el aula actual');
                return;
            }
            
            const classroom = classroomEl.textContent;
            const school = schoolEl.textContent;
            
            if (name && lastName && classroom && school) {
                // Parse year and division from classroom name
                const yearMatch = classroom.match(/(\d+)°/);
                const year = yearMatch ? yearMatch[1] : '';
                const division = classroom.replace(/\d+°/, '');
                
                const newId = Math.max(...students.map(s => s.id), 0) + 1;
                const newStudent = {
                    id: newId,
                    name: name.toUpperCase(),
                    lastName: lastName.toUpperCase(),
                    year: year,
                    division: division,
                    school: school,
                    isRepeater: isRepeater
                };
                
                if (isRepeater) {
                    newStudent.previousSchool = document.getElementById('previousSchool').value;
                    newStudent.previousYear = document.getElementById('previousYear').value;
                    newStudent.reason = document.getElementById('repeaterReason').value;
                }
                
                students.push(newStudent);
                saveData();
                
                // Clear form
                clearStudentForm();
                
                alert('Estudiante guardado exitosamente');
                showClassroomDetail(classroom, school);
                updateStatus('Estudiante agregado: ' + name + ' ' + lastName);
            } else {
                alert('Por favor complete todos los campos obligatorios');
            }
        }

        function clearStudentForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentLastName').value = '';
            document.getElementById('studentBirth').value = '';
            document.getElementById('isRepeater').value = 'no';
            document.getElementById('previousSchool').value = '';
            document.getElementById('previousYear').value = '';
            document.getElementById('repeaterReason').value = '';
            document.getElementById('repeaterFields').classList.add('hidden');
        }

        function toggleRepeaterFields() {
            const isRepeater = document.getElementById('isRepeater').value === 'yes';
            const repeaterFields = document.getElementById('repeaterFields');
            
            if (isRepeater) {
                repeaterFields.classList.remove('hidden');
            } else {
                repeaterFields.classList.add('hidden');
            }
        }

        function updateStudentList(studentList = students) {
            console.log('=== UPDATE STUDENT LIST ===');
            console.log('Received student list:', studentList);
            console.log('Student list length:', studentList.length);
            
            const tbody = document.getElementById('studentList');
            const thead = document.getElementById('studentTableHeader');
            if (!tbody || !thead) {
                console.error('ERROR: studentList tbody or thead not found!');
                return;
            }
            
            // Get current classroom info
            const classroomEl = document.getElementById('currentClassroom');
            const schoolEl = document.getElementById('currentSchool');
            const classroom = classroomEl ? classroomEl.textContent : '';
            const school = schoolEl ? schoolEl.textContent : '';
            
            // Get exams for current classroom
            const classroomExams = exams.filter(e => e.classroom === classroom && e.school === school);
            console.log('Classroom exams found:', classroomExams);
            
            // Sort exams by semester first, then by creation order (id)
            const sortedExams = [...classroomExams].sort((a, b) => {
                if (a.semester !== b.semester) {
                    return a.semester - b.semester; // 1st semester first
                }
                return a.id - b.id; // Then by creation order
            });
            
            // Update table header with exam columns
            let headerHTML = '<tr><th>APELLIDO, NOMBRE</th>';
            sortedExams.forEach(exam => {
                const examTitle = exam.title || `${exam.subject} - ${exam.type}`;
                // Create very compact title - use subject abbreviation + type abbreviation
                let shortTitle = '';
                
                // Subject abbreviations
                const subjectAbbr = {
                    'MATEMÁTICAS': 'MAT',
                    'LENGUA': 'LEN',
                    'CIENCIAS NATURALES': 'CN',
                    'CIENCIAS SOCIALES': 'CS',
                    'INGLÉS': 'ING',
                    'EDUCACIÓN FÍSICA': 'EF'
                };
                
                // Type abbreviations
                const typeAbbr = {
                    'EXAMEN ESCRITO': 'EE',
                    'EXAMEN ORAL': 'EO',
                    'PUESTA GRUPAL': 'PG',
                    'EXAMEN INTEGRADOR': 'EI',
                    'INTENSIFICACIÓN': 'INT',
                    'RECUPERATORIO': 'REC',
                    'EVALUACIONES DIAGNÓSTICAS': 'ED',
                    'PARCIAL': 'P',
                    'TRABAJO PRÁCTICO': 'TP',
                    'FINAL': 'F'
                };
                
                const subjAbbr = subjectAbbr[exam.subject] || exam.subject.substring(0, 3);
                const typAbbr = typeAbbr[exam.type] || exam.type.substring(0, 3);
                shortTitle = `${subjAbbr}-${typAbbr}`;
                
                // Colors: Light blue for 1st semester, Gray for 2nd semester
                const headerColor = exam.semester === '1' ? '#000000' : '#FFFFFF'; // Black text on light blue, white on gray
                const bgColor = exam.semester === '1' ? '#87CEEB' : '#808080'; // Light blue for 1st, Gray for 2nd
                
                headerHTML += `<th style="text-align: center; font-size: 10px; color: ${headerColor}; background-color: ${bgColor}; padding: 4px 2px; min-width: 45px; max-width: 45px; white-space: nowrap; overflow: hidden;" title="${examTitle} (${exam.semester}° Cuatrimestre)">${shortTitle}</th>`;
            });
            headerHTML += '<th style="text-align: center;">⚙️</th></tr>';
            thead.innerHTML = headerHTML;
            
            // Store sorted exams for use in student rows
            classroomExams = sortedExams;
            
            tbody.innerHTML = '';
            
            if (studentList.length === 0) {
                console.log('No students to display - showing empty message');
                const row = tbody.insertRow();
                const colspan = 2 + classroomExams.length;
                row.innerHTML = `<td colspan="${colspan}" style="text-align: center; color: #FFFF00;">No hay estudiantes en esta aula</td>`;
                return;
            }
            
            // Sort students alphabetically by last name, then by first name
            const sortedStudents = [...studentList].sort((a, b) => {
                const lastNameCompare = a.lastName.localeCompare(b.lastName, 'es', { sensitivity: 'base' });
                if (lastNameCompare !== 0) return lastNameCompare;
                return a.name.localeCompare(b.name, 'es', { sensitivity: 'base' });
            });
            
            console.log('Sorted students:', sortedStudents);
            
            sortedStudents.forEach((student, index) => {
                console.log(`Processing student ${index + 1}:`, student);
                
                const row = tbody.insertRow();
                
                // Add gray background for repeaters
                if (student.isRepeater) {
                    row.className = 'repeater-row';
                }
                
                // Build exam columns
                let examColumns = '';
                classroomExams.forEach(exam => {
                    const studentGrade = exam.grades && exam.grades[student.id] ? exam.grades[student.id].grade : null;
                    let gradeDisplay = '';
                    let gradeColor = '#FFFFFF';
                    
                    // Background color based on semester - Light blue for 1st, Gray for 2nd
                    const bgColor = exam.semester === '1' ? '#87CEEB' : '#808080';
                    
                    if (studentGrade !== null) {
                        gradeDisplay = studentGrade.toString();
                        if (studentGrade >= 7) {
                            gradeColor = '#006400'; // Dark green for better contrast
                        } else if (studentGrade >= 4) {
                            gradeColor = '#FF8C00'; // Dark orange for better contrast
                        } else {
                            gradeColor = '#8B0000'; // Dark red for better contrast
                        }
                    } else {
                        gradeColor = exam.semester === '1' ? '#000000' : '#FFFFFF'; // Black on light blue, white on gray
                    }
                    
                    examColumns += `<td style="text-align: center; color: ${gradeColor}; background-color: ${bgColor}; font-weight: bold; padding: 4px 2px; min-width: 45px; max-width: 45px;">${gradeDisplay}</td>`;
                });
                
                row.innerHTML = `
                    <td>${student.lastName}, ${student.name}</td>
                    ${examColumns}
                    <td style="text-align: center;">
                        <button onclick="showStudentDetail(${student.id})" style="background: transparent; border: none; color: #FFFFFF; font-size: 16px; cursor: pointer; padding: 4px;">⚙️</button>
                    </td>
                `;
                
                console.log(`Added row for ${student.name} ${student.lastName}`);
            });
            
            console.log('Student list update completed');
        }

        function editStudent(id) {
            alert('Función de edición en desarrollo para estudiante ID: ' + id);
        }

        function deleteStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;
            
            if (confirm(`¿Está seguro que desea eliminar a ${student.name} ${student.lastName}?\n\nEsta acción también eliminará todas sus notas.`)) {
                students = students.filter(student => student.id !== id);
                delete studentNotes[id]; // Remove student notes
                saveData();
                
                // Refresh current view
                const classroomEl = document.getElementById('currentClassroom');
                const schoolEl = document.getElementById('currentSchool');
                
                if (!classroomEl || !schoolEl) {
                    alert('Error: No se puede determinar el aula actual');
                    return;
                }
                
                const classroom = classroomEl.textContent;
                const school = schoolEl.textContent;
                showClassroomDetail(classroom, school);
                updateStatus(`Estudiante eliminado: ${student.name} ${student.lastName}`);
            }
        }

        // Excel import functions
        function showImportExcel() {
            pushNavigation('importExcelForm');
            hideAllScreens();
            document.getElementById('importExcelForm').classList.remove('hidden');
            updateStatus('Importación desde Excel activa');
        }

        function getSeparator() {
            const separatorType = document.getElementById('separator').value;
            switch(separatorType) {
                case 'tab': return '\t';
                case 'comma': return ',';
                case 'semicolon': return ';';
                case 'space': return ' ';
                default: return '\t';
            }
        }

        function parseStudentData(data) {
            const lines = data.trim().split('\n');
            const parsedData = [];
            
            console.log('=== INICIO DEL ANÁLISIS DE IMPORTACIÓN ===');
            console.log('Datos recibidos:', data);
            console.log('Número de líneas:', lines.length);
            console.log('Líneas individuales:', lines);
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                console.log(`\n--- PROCESANDO LÍNEA ${index + 1} ---`);
                console.log(`Línea original: "${line}"`);
                console.log(`Línea limpia: "${trimmedLine}"`);
                
                if (trimmedLine === '') {
                    console.log(`❌ Línea vacía - OMITIDA`);
                    return;
                }
                
                let name = '';
                let lastName = '';
                
                // Detectar formato con coma
                if (trimmedLine.includes(',')) {
                    console.log('✅ Formato detectado: APELLIDO, Nombre');
                    const parts = trimmedLine.split(',');
                    console.log('Partes separadas por coma:', parts);
                    
                    if (parts.length >= 2) {
                        lastName = parts[0].trim();
                        name = parts.slice(1).join(',').trim();
                        console.log(`Apellido extraído: "${lastName}"`);
                        console.log(`Nombre extraído: "${name}"`);
                    } else {
                        console.log('❌ Error: Coma encontrada pero partes insuficientes');
                        lastName = 'ERROR_FORMATO';
                        name = 'ERROR_FORMATO';
                    }
                } else {
                    // Formato sin coma - asumir que el primer elemento es apellido
                    console.log('⚠️ Formato sin coma detectado - asumiendo primer elemento como apellido');
                    const spaceParts = trimmedLine.split(/\s+/);
                    console.log('Partes separadas por espacio:', spaceParts);
                    
                    if (spaceParts.length >= 2) {
                        lastName = spaceParts[0];
                        name = spaceParts.slice(1).join(' ');
                        console.log(`Apellido asumido: "${lastName}"`);
                        console.log(`Nombre asumido: "${name}"`);
                    } else {
                        console.log('❌ Error: Solo una palabra encontrada');
                        lastName = spaceParts[0] || 'ERROR';
                        name = 'SIN_NOMBRE';
                    }
                }
                
                // Limpiar y normalizar
                const cleanLastName = lastName.toUpperCase().trim();
                const cleanName = name.toUpperCase().trim();
                
                console.log(`Apellido normalizado: "${cleanLastName}"`);
                console.log(`Nombre normalizado: "${cleanName}"`);
                
                // Validación mejorada
                let status = 'VÁLIDO';
                let errorReason = '';
                
                if (!cleanLastName || cleanLastName === 'ERROR_FORMATO' || cleanLastName === 'ERROR') {
                    status = 'ERROR';
                    errorReason = 'Apellido inválido';
                } else if (!cleanName || cleanName === 'ERROR_FORMATO' || cleanName === 'SIN_NOMBRE') {
                    status = 'ERROR';
                    errorReason = 'Nombre inválido';
                } else if (students.some(s => s.name === cleanName && s.lastName === cleanLastName)) {
                    status = 'DUPLICADO';
                    errorReason = 'Ya existe en el sistema';
                } else {
                    console.log('✅ Estudiante válido para importar');
                }
                
                if (status !== 'VÁLIDO') {
                    console.log(`❌ Estado: ${status} - ${errorReason}`);
                } else {
                    console.log(`✅ Estado: ${status}`);
                }
                
                parsedData.push({
                    name: cleanName,
                    lastName: cleanLastName,
                    status: status,
                    errorReason: errorReason,
                    lineNumber: index + 1,
                    originalLine: trimmedLine
                });
            });
            
            console.log('\n=== RESUMEN DEL ANÁLISIS ===');
            console.log('Total de líneas procesadas:', parsedData.length);
            console.log('Estudiantes válidos:', parsedData.filter(s => s.status === 'VÁLIDO').length);
            console.log('Errores encontrados:', parsedData.filter(s => s.status === 'ERROR').length);
            console.log('Duplicados encontrados:', parsedData.filter(s => s.status === 'DUPLICADO').length);
            console.log('Datos finales:', parsedData);
            console.log('=== FIN DEL ANÁLISIS ===\n');
            
            return parsedData;
        }

        function previewImport() {
            const data = document.getElementById('excelData').value;
            
            if (!data.trim()) {
                alert('Por favor ingrese los datos a importar');
                return;
            }
            
            const parsedData = parseExcelData(data);
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '';
            
            parsedData.forEach(student => {
                const row = previewBody.insertRow();
                const statusColor = student.status === 'VÁLIDO' ? '#00FF00' : 
                                  student.status.includes('ADVERTENCIA') ? '#FFFF00' : '#FF0000';
                
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.lastName}</td>
                    <td>${student.grade}</td>
                    <td style="color: ${statusColor};">${student.status}</td>
                `;
            });
            
            document.getElementById('previewSection').classList.remove('hidden');
            updateStatus(`Vista previa: ${parsedData.length} registros procesados`);
        }

        function importStudents() {
            const data = document.getElementById('excelData').value;
            
            if (!data.trim()) {
                alert('Por favor ingrese la lista de estudiantes');
                return;
            }
            
            // Get current classroom info - check if elements exist
            const classroomEl = document.getElementById('currentClassroom');
            const schoolEl = document.getElementById('currentSchool');
            
            if (!classroomEl || !schoolEl) {
                alert('Error: No se puede determinar el aula actual');
                return;
            }
            
            const classroom = classroomEl.textContent;
            const school = schoolEl.textContent;
            
            if (!classroom || !school) {
                alert('Error: No se puede determinar el aula actual');
                return;
            }
            
            // Parse year and division from classroom name
            const yearMatch = classroom.match(/(\d+)°/);
            const year = yearMatch ? yearMatch[1] : '';
            const division = classroom.replace(/\d+°/, '');
            
            // Show processing message
            updateStatus('Procesando lista de estudiantes...');
            
            try {
                const parsedData = parseStudentData(data);
                let importedCount = 0;
                let errorCount = 0;
                let duplicateCount = 0;
                let errorDetails = [];
                
                console.log('Parsed data:', parsedData); // Debug log
                
                console.log('\n=== PROCESANDO ESTUDIANTES PARA IMPORTAR ===');
                
                parsedData.forEach((student, index) => {
                    console.log(`\n--- PROCESANDO ESTUDIANTE ${index + 1} ---`);
                    console.log('Datos del estudiante:', student);
                    console.log('Estado:', student.status);
                    
                    if (student.status === 'VÁLIDO') {
                        console.log('✅ Estudiante válido - AGREGANDO AL SISTEMA');
                        
                        const newId = Math.max(...students.map(s => s.id), 0) + 1;
                        const newStudent = {
                            id: newId,
                            name: student.name,
                            lastName: student.lastName,
                            year: year,
                            division: division,
                            school: school,
                            isRepeater: false
                        };
                        
                        students.push(newStudent);
                        importedCount++;
                        console.log('✅ Estudiante agregado exitosamente:', newStudent);
                        
                    } else if (student.status === 'DUPLICADO') {
                        console.log('⚠️ Estudiante duplicado - OMITIDO');
                        duplicateCount++;
                        errorDetails.push(`Línea ${student.lineNumber}: ${student.name} ${student.lastName} - Ya existe en el sistema`);
                        
                    } else {
                        console.log('❌ Error en estudiante - OMITIDO');
                        errorCount++;
                        errorDetails.push(`Línea ${student.lineNumber}: ${student.errorReason || student.status}`);
                    }
                });
                
                console.log('\n=== RESUMEN DE IMPORTACIÓN ===');
                console.log('Estudiantes importados:', importedCount);
                console.log('Duplicados omitidos:', duplicateCount);
                console.log('Errores encontrados:', errorCount);
                console.log('Total de estudiantes en el sistema:', students.length);
                
                // Save data
                saveData();
                
                // Show detailed import results
                let message = `IMPORTACIÓN COMPLETADA:\n\n`;
                message += `• Total procesado: ${parsedData.length} líneas\n`;
                message += `• Estudiantes importados: ${importedCount}\n`;
                message += `• Aula asignada: ${classroom} - ${school}\n`;
                
                if (duplicateCount > 0) {
                    message += `• Duplicados omitidos: ${duplicateCount}\n`;
                }
                
                if (errorCount > 0) {
                    message += `• Errores encontrados: ${errorCount}\n`;
                    if (errorDetails.length > 0) {
                        message += `\nDETALLE DE ERRORES:\n`;
                        message += errorDetails.slice(0, 5).join('\n'); // Show first 5 errors
                        if (errorDetails.length > 5) {
                            message += `\n... y ${errorDetails.length - 5} errores más`;
                        }
                    }
                }
                
                if (importedCount === 0 && errorCount > 0) {
                    message += `\n\nSUGERENCIAS:\n`;
                    message += `• Verifique el formato: "Apellido, Nombre"\n`;
                    message += `• Ejemplo: "García López, Juan Carlos"\n`;
                    message += `• Un estudiante por línea\n`;
                    message += `• Evite caracteres especiales`;
                }
                
                alert(message);
                
                // Only clear form and return if some students were imported
                if (importedCount > 0) {
                    document.getElementById('excelData').value = '';
                    showClassroomDetail(classroom, school);
                    updateStatus(`Importación exitosa: ${importedCount} estudiantes agregados`);
                } else {
                    updateStatus(`Importación fallida: ${errorCount} errores encontrados`);
                }
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Error durante la importación. Por favor verifique el formato de los datos.');
                updateStatus('Error durante la importación');
            }
        }

        // Attendance functions
        function loadAttendanceClassroomList() {
            const classroomList = document.getElementById('attendanceClassroomList');
            classroomList.innerHTML = '<h3>SELECCIONAR AULA PARA TOMAR ASISTENCIA:</h3><br>';
            
            if (classrooms.length === 0) {
                classroomList.innerHTML += '<p style="color: #FFFF00; text-align: center;">No hay aulas disponibles</p>';
                return;
            }
            
            classrooms.forEach((classroom, index) => {
                const classroomStudents = students.filter(s => 
                    s.year + '°' + s.division === classroom.name && s.school === classroom.school
                );
                const studentCount = classroomStudents.length;
                
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.style.cursor = 'pointer';
                menuItem.onclick = () => selectClassroomForAttendance(classroom.name, classroom.school);
                
                menuItem.innerHTML = `[${index + 1}] ${classroom.name} - ${classroom.school} (${studentCount} estudiantes)`;
                
                classroomList.appendChild(menuItem);
            });
        }

        function selectClassroomForAttendance(classroom, school) {
            // Store selected classroom
            currentAttendanceSession.classroom = classroom;
            currentAttendanceSession.school = school;
            
            // Show date selection screen
            pushNavigation('attendanceDateSelection');
            hideAllScreens();
            document.getElementById('attendanceDateSelection').classList.remove('hidden');
            
            // Update display
            document.getElementById('attendanceSelectedClassroom').textContent = classroom;
            document.getElementById('attendanceSelectedSchool').textContent = school;
            
            updateStatus(`Aula seleccionada: ${classroom} - ${school}`);
        }

        function selectCurrentDate() {
            const today = new Date();
            currentAttendanceSession.date = today.toISOString().split('T')[0];
            startAttendanceSession();
        }

        function selectCustomDate() {
            document.getElementById('customDateInput').classList.remove('hidden');
            // Set default to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('customAttendanceDate').value = today;
        }

        function confirmCustomDate() {
            const customDate = document.getElementById('customAttendanceDate').value;
            if (!customDate) {
                alert('Por favor seleccione una fecha');
                return;
            }
            
            currentAttendanceSession.date = customDate;
            startAttendanceSession();
        }

        function startAttendanceSession() {
            // Get students for the selected classroom
            const classroomStudents = students.filter(s => 
                s.year + '°' + s.division === currentAttendanceSession.classroom && 
                s.school === currentAttendanceSession.school
            );
            
            if (classroomStudents.length === 0) {
                alert('No hay estudiantes en esta aula');
                showAttendanceManager();
                return;
            }
            
            // Sort students alphabetically
            const sortedStudents = [...classroomStudents].sort((a, b) => {
                const lastNameCompare = a.lastName.localeCompare(b.lastName, 'es', { sensitivity: 'base' });
                if (lastNameCompare !== 0) return lastNameCompare;
                return a.name.localeCompare(b.name, 'es', { sensitivity: 'base' });
            });
            
            // Initialize session
            currentAttendanceSession.students = sortedStudents;
            currentAttendanceSession.currentIndex = 0;
            currentAttendanceSession.records = {};
            
            // Show individual attendance screen
            pushNavigation('individualAttendance');
            hideAllScreens();
            document.getElementById('individualAttendance').classList.remove('hidden');
            
            // Update display
            document.getElementById('attendanceCurrentClassroom').textContent = 
                `${currentAttendanceSession.classroom} - ${currentAttendanceSession.school}`;
            document.getElementById('attendanceCurrentDate').textContent = 
                new Date(currentAttendanceSession.date).toLocaleDateString('es-ES');
            
            // Show first student
            showCurrentStudent();
            updateStatus('Tomando asistencia individual');
        }

        function showCurrentStudent() {
            const session = currentAttendanceSession;
            const student = session.students[session.currentIndex];
            
            if (!student) {
                // Finished with all students
                finishAttendanceSession();
                return;
            }
            
            // Update display
            document.getElementById('currentStudentName').textContent = 
                `${student.name} ${student.lastName}`;
            document.getElementById('attendanceProgress').textContent = 
                `${session.currentIndex + 1}/${session.students.length}`;
        }

        function markAttendance(status) {
            const session = currentAttendanceSession;
            const student = session.students[session.currentIndex];
            
            if (!student) return;
            
            // Record attendance
            session.records[student.id] = status;
            
            // Move to next student
            session.currentIndex++;
            showCurrentStudent();
        }

        function cancelAttendance() {
            if (confirm('¿Está seguro que desea cancelar la toma de asistencia?\n\nSe perderán todos los datos ingresados.')) {
                showAttendanceManager();
                updateStatus('Toma de asistencia cancelada');
            }
        }

        function finishAttendanceSession() {
            const session = currentAttendanceSession;
            
            // Save attendance records
            session.students.forEach(student => {
                if (!attendanceRecords[student.id]) {
                    attendanceRecords[student.id] = {};
                }
                
                const dateKey = formatDateForStorage(session.date);
                attendanceRecords[student.id][dateKey] = session.records[student.id] || 'A'; // Default to absent if not marked
            });
            
            // Save to localStorage
            saveData();
            
            // Show results
            showAttendanceResults();
        }

        function showAttendanceResults() {
            const session = currentAttendanceSession;
            
            pushNavigation('attendanceResults');
            hideAllScreens();
            document.getElementById('attendanceResults').classList.remove('hidden');
            
            // Calculate statistics
            let presentCount = 0;
            let absentCount = 0;
            let lateCount = 0;
            
            Object.values(session.records).forEach(status => {
                switch(status) {
                    case 'P': presentCount++; break;
                    case 'A': absentCount++; break;
                    case 'T': lateCount++; break;
                }
            });
            
            // Update display
            document.getElementById('resultsClassroom').textContent = 
                `${session.classroom} - ${session.school}`;
            document.getElementById('resultsDate').textContent = 
                new Date(session.date).toLocaleDateString('es-ES');
            document.getElementById('resultsTotal').textContent = session.students.length;
            document.getElementById('resultsPresent').textContent = presentCount;
            document.getElementById('resultsAbsent').textContent = absentCount;
            document.getElementById('resultsLate').textContent = lateCount;
            
            // Update table header with current date
            const dateFormatted = new Date(session.date).toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit'
            });
            document.getElementById('attendanceTableHeader').textContent = dateFormatted;
            
            // Load results table
            loadAttendanceResultsTable();
            
            updateStatus(`Asistencia guardada: ${presentCount} presentes, ${absentCount} ausentes, ${lateCount} tardanzas`);
        }

        function loadAttendanceResultsTable() {
            const session = currentAttendanceSession;
            const tbody = document.getElementById('attendanceResultsList');
            tbody.innerHTML = '';
            
            session.students.forEach(student => {
                const row = tbody.insertRow();
                const attendancePercentage = calculateAttendancePercentage(student.id);
                const todayStatus = session.records[student.id] || 'A';
                
                // Color coding for attendance status
                let statusColor = '#FFFFFF';
                let statusText = todayStatus;
                switch(todayStatus) {
                    case 'P': 
                        statusColor = '#00FF00'; 
                        statusText = 'P';
                        break;
                    case 'A': 
                        statusColor = '#FF0000'; 
                        statusText = 'A';
                        break;
                    case 'T': 
                        statusColor = '#FFAA00'; 
                        statusText = 'T';
                        break;
                }
                
                row.innerHTML = `
                    <td>${student.name} ${student.lastName}</td>
                    <td style="text-align: center; font-weight: bold;">${attendancePercentage}%</td>
                    <td style="text-align: center; color: ${statusColor}; font-weight: bold;">${statusText}</td>
                `;
            });
        }

        function showAttendanceView() {
            const session = currentAttendanceSession;
            
            pushNavigation('attendanceView');
            hideAllScreens();
            document.getElementById('attendanceView').classList.remove('hidden');
            
            // Update display
            document.getElementById('viewClassroom').textContent = session.classroom;
            document.getElementById('viewSchool').textContent = session.school;
            document.getElementById('viewTotal').textContent = session.students.length;
            
            // Load full attendance table
            loadFullAttendanceTable();
            
            updateStatus('Vista completa de asistencia');
        }

        function loadFullAttendanceTable() {
            const session = currentAttendanceSession;
            const classroomStudents = session.students;
            
            // Get all unique dates for this classroom
            const allDates = new Set();
            classroomStudents.forEach(student => {
                if (attendanceRecords[student.id]) {
                    Object.keys(attendanceRecords[student.id]).forEach(date => {
                        allDates.add(date);
                    });
                }
            });
            
            // Sort dates chronologically
            const sortedDates = Array.from(allDates).sort((a, b) => {
                const dateA = parseStoredDate(a);
                const dateB = parseStoredDate(b);
                return dateA - dateB;
            });
            
            // Build header
            const thead = document.getElementById('fullAttendanceHeader');
            let headerHTML = '<tr><th>ESTUDIANTE</th><th>% ASIST.</th>';
            sortedDates.forEach(date => {
                const displayDate = formatDateForDisplay(date);
                headerHTML += `<th style="text-align: center; min-width: 50px;">${displayDate}</th>`;
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;
            
            // Build body
            const tbody = document.getElementById('fullAttendanceList');
            tbody.innerHTML = '';
            
            classroomStudents.forEach(student => {
                const row = tbody.insertRow();
                const attendancePercentage = calculateAttendancePercentage(student.id);
                
                let rowHTML = `<td>${student.name} ${student.lastName}</td>`;
                rowHTML += `<td style="text-align: center; font-weight: bold;">${attendancePercentage}%</td>`;
                
                sortedDates.forEach(date => {
                    const status = attendanceRecords[student.id] && attendanceRecords[student.id][date] 
                        ? attendanceRecords[student.id][date] : '';
                    
                    let statusColor = '#FFFFFF';
                    switch(status) {
                        case 'P': statusColor = '#00FF00'; break;
                        case 'A': statusColor = '#FF0000'; break;
                        case 'T': statusColor = '#FFAA00'; break;
                    }
                    
                    rowHTML += `<td style="text-align: center; color: ${statusColor}; font-weight: bold;">${status}</td>`;
                });
                
                row.innerHTML = rowHTML;
            });
        }

        function calculateAttendancePercentage(studentId) {
            const studentAttendance = attendanceRecords[studentId];
            if (!studentAttendance) return 0;
            
            const records = Object.values(studentAttendance);
            if (records.length === 0) return 0;
            
            const presentCount = records.filter(status => status === 'P' || status === 'T').length;
            return Math.round((presentCount / records.length) * 100);
        }

        function formatDateForStorage(dateString) {
            // Convert YYYY-MM-DD to DD/MM format for storage
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${day}/${month}`;
        }

        function formatDateForDisplay(storedDate) {
            // storedDate is already in DD/MM format
            return storedDate;
        }

        function parseStoredDate(storedDate) {
            // Convert DD/MM to Date object (assuming current year)
            const [day, month] = storedDate.split('/');
            const currentYear = new Date().getFullYear();
            return new Date(currentYear, parseInt(month) - 1, parseInt(day));
        }

        function exportAttendanceReport() {
            const session = currentAttendanceSession;
            
            // Generate attendance report
            let report = `REPORTE DE ASISTENCIA\n`;
            report += `═══════════════════════════════════════\n\n`;
            report += `AULA: ${session.classroom}\n`;
            report += `COLEGIO: ${session.school}\n`;
            report += `FECHA DE GENERACIÓN: ${new Date().toLocaleDateString('es-ES')}\n`;
            report += `TOTAL DE ESTUDIANTES: ${session.students.length}\n\n`;
            
            // Get all dates
            const allDates = new Set();
            session.students.forEach(student => {
                if (attendanceRecords[student.id]) {
                    Object.keys(attendanceRecords[student.id]).forEach(date => {
                        allDates.add(date);
                    });
                }
            });
            
            const sortedDates = Array.from(allDates).sort((a, b) => {
                const dateA = parseStoredDate(a);
                const dateB = parseStoredDate(b);
                return dateA - dateB;
            });
            
            report += `REGISTRO DETALLADO:\n`;
            report += `─────────────────────────────────────────\n`;
            
            // Header
            report += `ESTUDIANTE`.padEnd(25) + `% ASIST.`.padEnd(10);
            sortedDates.forEach(date => {
                report += date.padEnd(8);
            });
            report += `\n`;
            report += `─────────────────────────────────────────\n`;
            
            // Student data
            session.students.forEach(student => {
                const percentage = calculateAttendancePercentage(student.id);
                const name = `${student.name} ${student.lastName}`.substring(0, 24);
                
                report += name.padEnd(25) + `${percentage}%`.padEnd(10);
                
                sortedDates.forEach(date => {
                    const status = attendanceRecords[student.id] && attendanceRecords[student.id][date] 
                        ? attendanceRecords[student.id][date] : '-';
                    report += status.padEnd(8);
                });
                report += `\n`;
            });
            
            report += `\n\nLEYENDA:\n`;
            report += `P = Presente\n`;
            report += `A = Ausente\n`;
            report += `T = Tarde\n`;
            report += `- = Sin registro\n\n`;
            
            report += `Reporte generado por Cátedra Abierta Suite\n`;
            report += `Usuario: ${currentUser}\n`;
            report += `Fecha: ${new Date().toLocaleString('es-ES')}\n`;
            
            // Download report
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Asistencia_${session.classroom}_${session.school.replace(/\s+/g, '_')}.txt`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Reporte de asistencia exportado exitosamente');
            updateStatus('Reporte de asistencia exportado');
        }

        // Report functions
        function generateStudentReport() {
            alert('Generando reporte de estudiantes...\nTotal de estudiantes: ' + students.length);
            updateStatus('Reporte de estudiantes generado');
        }

        function generateGradeReport() {
            alert('Generando reporte de calificaciones...');
            updateStatus('Reporte de calificaciones generado');
        }

        function generateAttendanceReport() {
            alert('Generando reporte de asistencia...');
            updateStatus('Reporte de asistencia generado');
        }

        // Update status bar
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (!document.getElementById('loginScreen').classList.contains('hidden')) {
                    return;
                }
                if (!document.getElementById('mainMenu').classList.contains('hidden')) {
                    logout();
                } else {
                    showMainMenu();
                }
            }
            
            if (e.key === 'F1') {
                e.preventDefault();
                alert('AYUDA DEL SISTEMA\n\nTeclas de acceso rápido:\n• ESC: Volver al menú principal o salir\n• F1: Mostrar esta ayuda\n\nEn DETALLE DEL AULA:\n• A: Agregar estudiante\n• I: Importar desde Excel\n• E: Crear examen\n• R: Ver recursantes\n• V: Volver a aulas\n\nPara navegar use los botones o haga clic en las opciones del menú.');
            }
            
            // Keyboard shortcuts for classroom detail screen
            if (!document.getElementById('classroomDetail').classList.contains('hidden')) {
                if (e.key.toLowerCase() === 'a' && !e.target.matches('input, textarea, select')) {
                    e.preventDefault();
                    showAddStudent();
                }
                if (e.key.toLowerCase() === 'i' && !e.target.matches('input, textarea, select')) {
                    e.preventDefault();
                    showImportExcel();
                }
                if (e.key.toLowerCase() === 'e' && !e.target.matches('input, textarea, select')) {
                    e.preventDefault();
                    showCreateExam();
                }
                if (e.key.toLowerCase() === 'r' && !e.target.matches('input, textarea, select')) {
                    e.preventDefault();
                    showRepeatersTab();
                }
                if (e.key.toLowerCase() === 'v' && !e.target.matches('input, textarea, select')) {
                    e.preventDefault();
                    showClassroomManager();
                }
            }
        });

        // Store current classroom being viewed
        let currentClassroomId = null;
        let currentStudentId = null;
        let currentExamId = null;
        let currentClassroomName = '';
        let currentSchoolName = '';

        // Load and display classrooms
        function loadClassroomList() {
            const classroomList = document.getElementById('classroomList');
            classroomList.innerHTML = '';
            
            classrooms.forEach((classroom, index) => {
                // Calculate TEA percentage based on exam grades
                const classroomStudents = students.filter(s => 
                    s.year + '°' + s.division === classroom.name && s.school === classroom.school
                );
                const total = classroomStudents.length;
                let teaCount = 0;
                
                classroomStudents.forEach(student => {
                    // Calculate average from exam grades
                    const studentGrades = [];
                    exams.forEach(exam => {
                        if (exam.grades && exam.grades[student.id] && exam.grades[student.id].grade !== null) {
                            studentGrades.push(exam.grades[student.id].grade);
                        }
                    });
                    
                    if (studentGrades.length > 0) {
                        const calculatedAverage = studentGrades.reduce((sum, grade) => sum + grade, 0) / studentGrades.length;
                        if (calculatedAverage >= 7) {
                            teaCount++;
                        }
                    }
                });
                
                const teaPercentage = total > 0 ? Math.round((teaCount / total) * 100) : 0;
                
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.style.display = 'flex';
                menuItem.style.justifyContent = 'space-between';
                menuItem.style.alignItems = 'center';
                
                menuItem.innerHTML = `
                    <span onclick="showClassroomDetail('${classroom.name}', '${classroom.school}')" style="flex: 1; cursor: pointer;">
                        [${index + 1}] ${classroom.name} - ${classroom.school} (TEA: ${teaPercentage}%)
                    </span>
                `;
                
                classroomList.appendChild(menuItem);
            });
        }

        // Delete classroom function
        function deleteClassroom(classroomId) {
            const classroom = classrooms.find(c => c.id === classroomId);
            if (!classroom) return;
            
            if (confirm(`¿Está seguro que desea eliminar el aula ${classroom.name} - ${classroom.school}?\n\nEsta acción también eliminará todos los estudiantes asociados.`)) {
                // Remove classroom
                classrooms = classrooms.filter(c => c.id !== classroomId);
                
                // Remove students from this classroom
                students = students.filter(s => 
                    !(s.year + '°' + s.division === classroom.name && s.school === classroom.school)
                );
                
                // Remove notes for students from this classroom
                Object.keys(studentNotes).forEach(studentId => {
                    const student = students.find(s => s.id == studentId);
                    if (!student) {
                        delete studentNotes[studentId];
                    }
                });
                
                saveData();
                loadClassroomList();
                updateStatus(`Aula ${classroom.name} - ${classroom.school} eliminada`);
            }
        }

        // Open classroom link
        function openClassroomLink(event) {
            event.preventDefault();
            const classroom = classrooms.find(c => c.id === currentClassroomId);
            if (classroom && classroom.classroomLink) {
                window.open(classroom.classroomLink, '_blank');
                updateStatus('Abriendo Google Classroom...');
            } else {
                alert('No hay enlace de Classroom configurado para esta aula');
            }
        }

        // Show edit classroom form
        function showEditClassroom() {
            const classroom = classrooms.find(c => c.id === currentClassroomId);
            if (!classroom) return;
            
            pushNavigation('editClassroomForm');
            hideAllScreens();
            document.getElementById('editClassroomForm').classList.remove('hidden');
            
            // Populate form with current data
            const yearMatch = classroom.name.match(/(\d+)°/);
            document.getElementById('editClassroomYear').value = yearMatch ? yearMatch[1] : '';
            document.getElementById('editClassroomDivision').value = classroom.name.replace(/\d+°/, '');
            document.getElementById('editClassroomSchool').value = classroom.school;
            document.getElementById('editClassroomShift').value = classroom.shift;
            document.getElementById('editClassroomCode').value = classroom.classroomCode || '';
            document.getElementById('editClassroomLink').value = classroom.classroomLink || '';
            
            updateStatus('Editando aula: ' + classroom.name);
        }

        // Update classroom
        function updateClassroom() {
            const classroom = classrooms.find(c => c.id === currentClassroomId);
            if (!classroom) return;
            
            const year = document.getElementById('editClassroomYear').value.trim();
            const division = document.getElementById('editClassroomDivision').value.trim().toUpperCase();
            const school = document.getElementById('editClassroomSchool').value.trim().toUpperCase();
            const shift = document.getElementById('editClassroomShift').value;
            const classroomCode = document.getElementById('editClassroomCode').value.trim();
            const classroomLink = document.getElementById('editClassroomLink').value.trim();
            
            if (year && division && school && shift) {
                const oldName = classroom.name;
                const oldSchool = classroom.school;
                const newName = year + '°' + division;
                
                // Update classroom
                classroom.name = newName;
                classroom.school = school;
                classroom.shift = shift;
                classroom.classroomCode = classroomCode;
                classroom.classroomLink = classroomLink;
                
                // Update students if classroom name or school changed
                if (oldName !== newName || oldSchool !== school) {
                    students.forEach(student => {
                        if (student.year + '°' + student.division === oldName && student.school === oldSchool) {
                            const yearMatch = newName.match(/(\d+)°/);
                            student.year = yearMatch ? yearMatch[1] : student.year;
                            student.division = newName.replace(/\d+°/, '');
                            student.school = school;
                        }
                    });
                }
                
                saveData();
                alert('Aula actualizada exitosamente');
                showClassroomDetail(newName, school);
                updateStatus(`Aula actualizada: ${newName} - ${school}`);
            } else {
                alert('Por favor complete todos los campos obligatorios');
            }
        }

        // Classroom and Exam management functions
        function showCreateClassroom() {
            pushNavigation('createClassroomForm');
            hideAllScreens();
            document.getElementById('createClassroomForm').classList.remove('hidden');
            updateStatus('Formulario de nueva aula');
        }

        function showCreateExam() {
            hideAllScreens();
            document.getElementById('createExamForm').classList.remove('hidden');
            updateStatus('Formulario de nuevo examen');
        }

        function saveClassroom() {
            const year = document.getElementById('newClassroomYear').value.trim();
            const division = document.getElementById('newClassroomDivision').value.trim().toUpperCase();
            const school = document.getElementById('newClassroomSchool').value.trim().toUpperCase();
            const shift = document.getElementById('newClassroomShift').value;
            const classroomCode = document.getElementById('newClassroomCode').value.trim();
            const classroomLink = document.getElementById('newClassroomLink').value.trim();
            
            if (year && division && school && shift) {
                const classroomName = year + '°' + division;
                
                // Check if classroom already exists
                const exists = classrooms.find(c => c.name === classroomName && c.school === school);
                if (exists) {
                    alert('ERROR: Ya existe un aula con esa configuración');
                    return;
                }
                
                // Create new classroom object
                const newClassroom = {
                    id: Math.max(...classrooms.map(c => c.id), 0) + 1,
                    name: classroomName,
                    school: school,
                    shift: shift,
                    classroomCode: classroomCode || 'No asignado',
                    classroomLink: classroomLink || ''
                };
                
                classrooms.push(newClassroom);
                saveData();
                
                // Clear form
                clearClassroomForm();
                
                let message = `Aula ${classroomName} - ${school} creada exitosamente\nTurno: ${shift}`;
                if (classroomCode) {
                    message += `\nCódigo Classroom: ${classroomCode}`;
                }
                if (classroomLink) {
                    message += `\nEnlace configurado correctamente`;
                }
                
                alert(message);
                showClassroomManager();
                updateStatus(`Nueva aula creada: ${classroomName} - ${school}`);
            } else {
                alert('Por favor complete los campos obligatorios: Año, División, Colegio y Turno');
            }
        }

        function clearClassroomForm() {
            document.getElementById('newClassroomYear').value = '';
            document.getElementById('newClassroomDivision').value = '';
            document.getElementById('newClassroomSchool').value = '';
            document.getElementById('newClassroomShift').value = '';
            document.getElementById('newClassroomCode').value = '';
            document.getElementById('newClassroomLink').value = '';
        }

        function toggleGradeOptions() {
            const gradeType = document.getElementById('examGradeType').value;
            const qualitativeOptions = document.getElementById('qualitativeOptions');
            
            if (gradeType === 'qualitative') {
                qualitativeOptions.classList.remove('hidden');
            } else {
                qualitativeOptions.classList.add('hidden');
            }
        }

        function saveExam() {
            const name = document.getElementById('examName').value;
            const subject = document.getElementById('examSubject').value;
            const date = document.getElementById('examDate').value;
            const gradeType = document.getElementById('examGradeType').value;
            const description = document.getElementById('examDescription').value;
            
            if (name && subject && date && gradeType) {
                let gradeSystem = '';
                
                if (gradeType === 'qualitative') {
                    const qualitativeSystem = document.getElementById('qualitativeSystem').value;
                    if (!qualitativeSystem) {
                        alert('Por favor seleccione el sistema cualitativo');
                        return;
                    }
                    
                    if (qualitativeSystem === 'tep_tea_ted') {
                        gradeSystem = 'TEP / TEA / TED';
                    } else if (qualitativeSystem === 'excellence_scale') {
                        gradeSystem = 'EXCELENTE / MUY BIEN / BIEN / REGULAR / INSUFICIENTE';
                    }
                } else {
                    gradeSystem = 'CALIFICACIÓN NUMÉRICA (1-10)';
                }
                
                // Create exam object (in a real app, this would be saved to database)
                const newExam = {
                    id: Date.now(),
                    name: name,
                    subject: subject,
                    date: date,
                    gradeType: gradeType,
                    gradeSystem: gradeSystem,
                    description: description,
                    classroom: document.getElementById('currentClassroom').textContent,
                    school: document.getElementById('currentSchool').textContent
                };
                
                // Clear form
                clearExamForm();
                
                let message = `EXAMEN CREADO EXITOSAMENTE\n\n`;
                message += `• Nombre: ${name}\n`;
                message += `• Materia: ${subject}\n`;
                message += `• Fecha: ${new Date(date).toLocaleDateString('es-ES')}\n`;
                message += `• Sistema: ${gradeSystem}\n`;
                if (description) message += `• Descripción: ${description}\n`;
                
                alert(message);
                showClassroomDetail();
                updateStatus(`Examen creado: ${name} - ${subject}`);
            } else {
                alert('Por favor complete todos los campos obligatorios');
            }
        }

        function clearExamForm() {
            document.getElementById('examName').value = '';
            document.getElementById('examSubject').value = '';
            document.getElementById('examDate').value = '';
            document.getElementById('examGradeType').value = '';
            document.getElementById('qualitativeSystem').value = '';
            document.getElementById('examDescription').value = '';
            document.getElementById('qualitativeOptions').classList.add('hidden');
        }

        // School management functions
        let savedSchools = [
            'COLEGIO SAN MARTÍN',
            'COLEGIO BELGRANO', 
            'INSTITUTO MORENO',
            'INSTITUTO RIVADAVIA',
            'COLEGIO NACIONAL'
        ];

        function showAddSchool() {
            pushNavigation('addSchoolForm');
            hideAllScreens();
            document.getElementById('addSchoolForm').classList.remove('hidden');
            updateStatus('Formulario de nuevo colegio');
        }

        function saveNewSchool() {
            const schoolName = document.getElementById('newSchoolName').value.trim().toUpperCase();
            const address = document.getElementById('newSchoolAddress').value.trim();
            const phone = document.getElementById('newSchoolPhone').value.trim();
            
            if (schoolName) {
                // Check if school already exists
                if (savedSchools.includes(schoolName)) {
                    alert('ERROR: Ya existe un colegio con ese nombre');
                    return;
                }
                
                // Add to schools list (this will persist for future selections)
                savedSchools.push(schoolName);
                
                // Update datalist to include the new school
                const datalist = document.getElementById('schoolsList');
                const newOption = document.createElement('option');
                newOption.value = schoolName;
                datalist.appendChild(newOption);
                
                // Set the new school in the classroom form
                document.getElementById('newClassroomSchool').value = schoolName;
                
                // Save to localStorage for persistence
                localStorage.setItem('savedSchools', JSON.stringify(savedSchools));
                
                // Clear form
                clearSchoolForm();
                
                let message = `COLEGIO AGREGADO EXITOSAMENTE\n\n`;
                message += `• Nombre: ${schoolName}\n`;
                if (address) message += `• Dirección: ${address}\n`;
                if (phone) message += `• Teléfono: ${phone}\n`;
                message += `\nEl colegio ha sido guardado y seleccionado automáticamente.`;
                
                alert(message);
                showCreateClassroom();
                updateStatus(`Nuevo colegio agregado: ${schoolName}`);
            } else {
                alert('Por favor ingrese el nombre del colegio');
            }
        }

        function clearSchoolForm() {
            document.getElementById('newSchoolName').value = '';
            document.getElementById('newSchoolAddress').value = '';
            document.getElementById('newSchoolPhone').value = '';
        }

        // Load saved schools from localStorage
        function loadSavedSchools() {
            const saved = localStorage.getItem('savedSchools');
            if (saved) {
                savedSchools = JSON.parse(saved);
                
                // Update datalist with all saved schools
                const datalist = document.getElementById('schoolsList');
                datalist.innerHTML = '';
                savedSchools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school;
                    datalist.appendChild(option);
                });
            }
        }

        // Load saved classroom codes from localStorage
        function loadSavedClassroomCodes() {
            const saved = localStorage.getItem('classroomCodes');
            if (saved) {
                classroomCodes = JSON.parse(saved);
            }
        }

        // Exam management
        let exams = [
            {id: 1, title: 'Primer Parcial de Matemáticas', subject: 'MATEMÁTICAS', date: '2024-03-15', semester: '1', type: 'PARCIAL', classroom: '1°A', school: 'COLEGIO SAN MARTÍN', description: 'Ecuaciones y funciones lineales', grades: {}},
            {id: 2, title: 'Análisis de Textos Narrativos', subject: 'LENGUA', date: '2024-03-20', semester: '1', type: 'TRABAJO PRÁCTICO', classroom: '1°A', school: 'COLEGIO SAN MARTÍN', description: 'Análisis de cuentos contemporáneos', grades: {}},
            {id: 3, title: 'Examen Final de Ciencias', subject: 'CIENCIAS NATURALES', date: '2024-03-25', semester: '2', type: 'FINAL', classroom: '2°A', school: 'COLEGIO BELGRANO', description: 'Contenidos del año completo', grades: {}},
            {id: 4, title: 'Recuperatorio de Inglés', subject: 'INGLÉS', date: '2024-04-01', semester: '2', type: 'RECUPERATORIO', classroom: '1°B', school: 'COLEGIO SAN MARTÍN', description: 'Present Perfect y Past Simple', grades: {}}
        ];
        
        function showExamManager() {
            pushNavigation('examManager');
            hideAllScreens();
            document.getElementById('examManager').classList.remove('hidden');
            
            // Set current classroom info - check if elements exist
            const classroomEl = document.getElementById('currentClassroom');
            const schoolEl = document.getElementById('currentSchool');
            const examClassroomEl = document.getElementById('examClassroom');
            const examSchoolEl = document.getElementById('examSchool');
            
            if (classroomEl && schoolEl && examClassroomEl && examSchoolEl) {
                const classroom = classroomEl.textContent;
                const school = schoolEl.textContent;
                examClassroomEl.textContent = classroom;
                examSchoolEl.textContent = school;
            }
            
            loadExamList();
            updateStatus('Gestión de exámenes activa');
        }
        
        function showCreateExam() {
            pushNavigation('createExamForm');
            hideAllScreens();
            document.getElementById('createExamForm').classList.remove('hidden');
            updateStatus('Formulario de nuevo examen');
        }
        
        function loadExamList() {
            const classroom = document.getElementById('currentClassroom').textContent;
            const school = document.getElementById('currentSchool').textContent;
            
            // Filter exams for current classroom
            const classroomExams = exams.filter(e => e.classroom === classroom && e.school === school);
            
            const tbody = document.getElementById('examList');
            tbody.innerHTML = '';
            
            if (classroomExams.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5" style="text-align: center; color: #FFFF00;">No hay exámenes registrados</td>';
                return;
            }
            
            // Sort by date (newest first)
            const sortedExams = [...classroomExams].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExams.forEach(exam => {
                const row = tbody.insertRow();
                const formattedDate = new Date(exam.date).toLocaleDateString('es-ES');
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${exam.subject}</td>
                    <td onclick="showExamGrades(${exam.id})" style="cursor: pointer; color: #00FFFF; text-decoration: underline;" title="Click para calificar">${exam.title || exam.subject + ' - ' + exam.type}</td>
                    <td>${exam.type}</td>
                    <td style="text-align: center;">
                        <button class="dos-button" onclick="showExamGrades(${exam.id})" style="padding: 2px 6px; font-size: 10px; background: #008000;">📝</button>
                        <button class="dos-button" onclick="deleteExam(${exam.id})" style="padding: 2px 6px; font-size: 10px; background: #FF0000;">🗑️</button>
                    </td>
                `;
            });
        }
        
        function saveExam() {
            const title = document.getElementById('examTitle').value.trim();
            const subject = document.getElementById('examSubject').value;
            const date = document.getElementById('examDate').value;
            const semester = document.getElementById('examSemester').value;
            const type = document.getElementById('examType').value;
            const description = document.getElementById('examDescription').value.trim();
            
            if (title && subject && date && semester && type) {
                const classroomEl = document.getElementById('currentClassroom');
                const schoolEl = document.getElementById('currentSchool');
                
                if (!classroomEl || !schoolEl) {
                    alert('Error: No se puede determinar el aula actual');
                    return;
                }
                
                const classroom = classroomEl.textContent;
                const school = schoolEl.textContent;
                
                const newExam = {
                    id: Date.now(),
                    title: title,
                    subject: subject,
                    date: date,
                    semester: semester,
                    type: type,
                    description: description,
                    classroom: classroom,
                    school: school,
                    grades: {} // Store student grades
                };
                
                exams.push(newExam);
                saveData();
                
                // Clear form
                document.getElementById('examTitle').value = '';
                document.getElementById('examSubject').value = '';
                document.getElementById('examDate').value = '';
                document.getElementById('examSemester').value = '';
                document.getElementById('examType').value = '';
                document.getElementById('examDescription').value = '';
                
                alert(`Examen creado: ${title}`);
                showExamManager(); // Return to exam manager
                updateStatus(`Examen creado: ${title}`);
            } else {
                alert('Por favor complete todos los campos obligatorios (Título, Materia, Fecha, Cuatrimestre y Tipo)');
            }
        }
        
        function deleteExam(examId) {
            const exam = exams.find(e => e.id === examId);
            if (!exam) return;
            
            if (confirm(`¿Eliminar el examen "${exam.title || exam.subject + ' - ' + exam.type}"?`)) {
                exams = exams.filter(e => e.id !== examId);
                saveData();
                loadExamList();
                updateStatus(`Examen eliminado: ${exam.title || exam.subject + ' - ' + exam.type}`);
            }
        }
        
        // Show exam grades screen
        function showExamGrades(examId) {
            const exam = exams.find(e => e.id === examId);
            if (!exam) return;
            
            // Store current exam ID for reference
            currentExamId = examId;
            
            pushNavigation('examGrades');
            hideAllScreens();
            document.getElementById('examGrades').classList.remove('hidden');
            
            // Update exam info
            document.getElementById('gradeExamTitle').textContent = exam.title || exam.subject + ' - ' + exam.type;
            document.getElementById('gradeExamSubject').textContent = exam.subject;
            document.getElementById('gradeExamDate').textContent = new Date(exam.date).toLocaleDateString('es-ES');
            document.getElementById('gradeExamClassroom').textContent = exam.classroom + ' - ' + exam.school;
            
            // Load students for grading
            loadExamGradesList(exam);
            updateStatus(`Calificando examen: ${exam.title || exam.subject}`);
        }
        
        // Load students list for grading
        function loadExamGradesList(exam) {
            const classroom = exam.classroom;
            const school = exam.school;
            
            // Filter students for this classroom
            const classroomStudents = students.filter(s => 
                s.year + '°' + s.division === classroom && s.school === school
            );
            
            const tbody = document.getElementById('examGradesList');
            tbody.innerHTML = '';
            
            if (classroomStudents.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="3" style="text-align: center; color: #FFFF00;">No hay estudiantes en esta aula</td>';
                return;
            }
            
            // Sort students alphabetically
            const sortedStudents = [...classroomStudents].sort((a, b) => {
                const lastNameCompare = a.lastName.localeCompare(b.lastName, 'es', { sensitivity: 'base' });
                if (lastNameCompare !== 0) return lastNameCompare;
                return a.name.localeCompare(b.name, 'es', { sensitivity: 'base' });
            });
            
            sortedStudents.forEach(student => {
                const row = tbody.insertRow();
                const currentGrade = exam.grades && exam.grades[student.id] ? exam.grades[student.id].grade : '';
                const currentObservation = exam.grades && exam.grades[student.id] ? exam.grades[student.id].observation : '';
                
                row.innerHTML = `
                    <td>${student.name} ${student.lastName}</td>
                    <td>
                        <input type="number" 
                               min="1" max="10" step="0.1" 
                               value="${currentGrade}" 
                               class="dos-input" 
                               style="width: 80px; text-align: center;"
                               id="grade_${student.id}"
                               onchange="updateStudentGrade(${exam.id}, ${student.id})">
                    </td>
                    <td>
                        <input type="text" 
                               value="${currentObservation}" 
                               class="dos-input" 
                               placeholder="Observaciones..."
                               id="observation_${student.id}"
                               onchange="updateStudentGrade(${exam.id}, ${student.id})">
                    </td>
                `;
            });
        }
        
        // Update individual student grade
        function updateStudentGrade(examId, studentId) {
            const exam = exams.find(e => e.id === examId);
            if (!exam) return;
            
            const gradeInput = document.getElementById(`grade_${studentId}`);
            const observationInput = document.getElementById(`observation_${studentId}`);
            
            if (!exam.grades) {
                exam.grades = {};
            }
            
            const grade = gradeInput.value ? parseFloat(gradeInput.value) : null;
            const observation = observationInput.value.trim();
            
            if (grade !== null || observation) {
                exam.grades[studentId] = {
                    grade: grade,
                    observation: observation,
                    timestamp: new Date().toISOString()
                };
            } else {
                delete exam.grades[studentId];
            }
            
            saveData();
            
            const student = students.find(s => s.id === studentId);
            if (grade !== null) {
                updateStatus(`Nota guardada: ${student.name} ${student.lastName} - ${grade}`);
            }
        }
        
        // Save all grades at once
        function saveAllGrades() {
            const examId = exams.find(e => document.getElementById('gradeExamTitle').textContent.includes(e.title || e.subject))?.id;
            if (!examId) return;
            
            let savedCount = 0;
            const inputs = document.querySelectorAll('#examGradesList input[type="number"]');
            
            inputs.forEach(input => {
                if (input.value) {
                    savedCount++;
                }
            });
            
            if (savedCount > 0) {
                alert(`Se han guardado ${savedCount} calificaciones exitosamente`);
                updateStatus(`${savedCount} calificaciones guardadas`);
            } else {
                alert('No hay calificaciones para guardar');
            }
        }
        
        // Edit student average function
        function editStudentAverage(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const currentAverage = student.average !== null ? student.average.toFixed(1) : '';
            const newAverage = prompt(`Editar promedio de ${student.name} ${student.lastName}:\n\nIngrese el nuevo promedio (0-10) o deje vacío para quitar:`, currentAverage);
            
            if (newAverage === null) return; // User cancelled
            
            if (newAverage.trim() === '') {
                // Remove average
                student.average = null;
                saveData();
                
                // Refresh current view
                const classroomEl = document.getElementById('currentClassroom');
                const schoolEl = document.getElementById('currentSchool');
                
                if (!classroomEl || !schoolEl) {
                    alert('Error: No se puede determinar el aula actual');
                    return;
                }
                
                const classroom = classroomEl.textContent;
                const school = schoolEl.textContent;
                showClassroomDetail(classroom, school);
                updateStatus(`Promedio eliminado para ${student.name} ${student.lastName}`);
            } else {
                const average = parseFloat(newAverage);
                if (isNaN(average) || average < 0 || average > 10) {
                    alert('Por favor ingrese un número válido entre 0 y 10');
                    return;
                }
                
                student.average = average;
                saveData();
                
                // Refresh current view
                const classroomEl = document.getElementById('currentClassroom');
                const schoolEl = document.getElementById('currentSchool');
                
                if (!classroomEl || !schoolEl) {
                    alert('Error: No se puede determinar el aula actual');
                    return;
                }
                
                const classroom = classroomEl.textContent;
                const school = schoolEl.textContent;
                showClassroomDetail(classroom, school);
                updateStatus(`Promedio actualizado para ${student.name} ${student.lastName}: ${average.toFixed(1)}`);
            }
        }

        // Initialize
        setInterval(updateTime, 1000);
        updateTime();
        loadSavedSchools();
        loadSavedClassroomCodes();
        updateStatus('Sistema iniciado - Ingrese sus credenciales');

        // Student Notes System
        let studentNotes = {};
        let classrooms = [
            {id: 1, name: '1°A', school: 'COLEGIO SAN MARTÍN', shift: 'MAÑANA', classroomCode: 'abc123', classroomLink: 'https://classroom.google.com/c/abc123'},
            {id: 2, name: '1°B', school: 'COLEGIO SAN MARTÍN', shift: 'TARDE', classroomCode: 'def456', classroomLink: 'https://classroom.google.com/c/def456'},
            {id: 3, name: '2°A', school: 'COLEGIO BELGRANO', shift: 'MAÑANA', classroomCode: 'ghi789', classroomLink: 'https://classroom.google.com/c/ghi789'},
            {id: 4, name: '2°B', school: 'COLEGIO BELGRANO', shift: 'TARDE', classroomCode: 'jkl012', classroomLink: 'https://classroom.google.com/c/jkl012'},
            {id: 5, name: '3°A', school: 'INSTITUTO MORENO', shift: 'MAÑANA', classroomCode: 'mno345', classroomLink: 'https://classroom.google.com/c/mno345'}
        ];
        let classroomCodes = {};

        // Attendance System
        let attendanceRecords = {}; // Format: {studentId: {date: 'P'|'A'|'T'}}
        let currentAttendanceSession = {
            classroom: '',
            school: '',
            date: '',
            students: [],
            currentIndex: 0,
            records: {}
        };

        // Show add student note form
        function showAddStudentNote(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            currentStudentId = studentId;
            pushNavigation('studentNotesForm');
            hideAllScreens();
            document.getElementById('studentNotesForm').classList.remove('hidden');
            
            // Update form header with student info
            document.getElementById('noteStudentName').textContent = `${student.name} ${student.lastName}`;
            
            // Clear form
            document.getElementById('noteType').value = '';
            document.getElementById('noteLevel').value = '';
            document.getElementById('noteDescription').value = '';
            
            updateStatus(`Agregando nota para: ${student.name} ${student.lastName}`);
        }

        // Save student note
        function saveStudentNote() {
            const type = document.getElementById('noteType').value;
            const level = document.getElementById('noteLevel').value;
            const description = document.getElementById('noteDescription').value.trim();
            
            if (type && level && description) {
                if (!studentNotes[currentStudentId]) {
                    studentNotes[currentStudentId] = [];
                }
                
                const newNote = {
                    id: Date.now(),
                    type: type,
                    level: level,
                    description: description,
                    date: new Date().toLocaleDateString('es-ES'),
                    time: new Date().toLocaleTimeString('es-ES', {hour12: false})
                };
                
                studentNotes[currentStudentId].push(newNote);
                saveData();
                
                const student = students.find(s => s.id === currentStudentId);
                alert(`Nota agregada exitosamente para ${student.name} ${student.lastName}`);
                
                // Return to classroom detail
                const classroomEl = document.getElementById('currentClassroom');
                const schoolEl = document.getElementById('currentSchool');
                
                if (!classroomEl || !schoolEl) {
                    alert('Error: No se puede determinar el aula actual');
                    return;
                }
                
                const classroom = classroomEl.textContent;
                const school = schoolEl.textContent;
                showClassroomDetail(classroom, school);
                updateStatus(`Nota agregada para: ${student.name} ${student.lastName}`);
            } else {
                alert('Por favor complete todos los campos');
            }
        }

        // Show student notes history
        function showStudentNotesHistory(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            currentStudentId = studentId;
            pushNavigation('studentNotesHistory');
            hideAllScreens();
            document.getElementById('studentNotesHistory').classList.remove('hidden');
            
            // Update header
            document.getElementById('historyStudentName').textContent = `${student.name} ${student.lastName}`;
            
            // Load notes
            const notes = studentNotes[studentId] || [];
            const tbody = document.getElementById('notesHistoryList');
            tbody.innerHTML = '';
            
            if (notes.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5" style="text-align: center; color: #FFFF00;">No hay notas registradas</td>';
            } else {
                // Sort notes by date (newest first)
                const sortedNotes = [...notes].sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
                
                sortedNotes.forEach(note => {
                    const row = tbody.insertRow();
                    
                    // Color coding by level
                    let levelColor = '#FFFFFF';
                    switch(note.level) {
                        case 'LEVE': levelColor = '#00FF00'; break;
                        case 'MODERADA': levelColor = '#FFFF00'; break;
                        case 'GRAVE': levelColor = '#FF8800'; break;
                        case 'MUY GRAVE': levelColor = '#FF0000'; break;
                    }
                    
                    row.innerHTML = `
                        <td>${note.date}</td>
                        <td>${note.time}</td>
                        <td>${note.type}</td>
                        <td style="color: ${levelColor};">${note.level}</td>
                        <td>${note.description}</td>
                    `;
                });
            }
            
            updateStatus(`Historial de notas: ${student.name} ${student.lastName}`);
        }

        // Get student notes count for display
        function getStudentNotesCount(studentId) {
            const notes = studentNotes[studentId] || [];
            return notes.length;
        }

        // Return to current classroom (fixes navigation issue)
        function returnToCurrentClassroom() {
            if (currentClassroomName && currentSchoolName) {
                showClassroomDetail(currentClassroomName, currentSchoolName);
            } else {
                showClassroomManager();
            }
        }

        // Return to classroom from import screen
        function returnToClassroomFromImport() {
            const classroomEl = document.getElementById('currentClassroom');
            const schoolEl = document.getElementById('currentSchool');
            
            if (classroomEl && schoolEl) {
                const classroom = classroomEl.textContent;
                const school = schoolEl.textContent;
                
                if (classroom && school) {
                    showClassroomDetail(classroom, school);
                    updateStatus(`Volviendo al aula: ${classroom} - ${school}`);
                } else {
                    showClassroomManager();
                    updateStatus('Volviendo a la gestión de aulas');
                }
            } else {
                showClassroomManager();
                updateStatus('Volviendo a la gestión de aulas');
            }
        }

        // Generate PDF report for student notes using AI-powered content generation
        function generateStudentNotePDF(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const notes = studentNotes[studentId] || [];
            
            if (notes.length === 0) {
                alert('No hay notas registradas para generar el reporte');
                return;
            }
            
            // Show loading message
            updateStatus('Generando reporte PDF con IA...');
            
            // Simulate AI processing time
            setTimeout(() => {
                generatePDFContent(student, notes);
            }, 1500);
        }

        // Generate PDF content with AI-powered analysis
        function generatePDFContent(student, notes) {
            // AI-powered analysis of student behavior patterns
            const behaviorAnalysis = analyzeStudentBehavior(notes);
            const recommendations = generateRecommendations(notes, behaviorAnalysis);
            
            // Create PDF content
            const pdfContent = createPDFDocument(student, notes, behaviorAnalysis, recommendations);
            
            // Generate and download PDF
            downloadPDF(pdfContent, `Reporte_${student.name}_${student.lastName}.pdf`);
            
            updateStatus(`Reporte PDF generado para ${student.name} ${student.lastName}`);
        }

        // AI-powered behavior analysis
        function analyzeStudentBehavior(notes) {
            const analysis = {
                totalNotes: notes.length,
                severityDistribution: {},
                typeDistribution: {},
                trends: '',
                riskLevel: 'BAJO',
                improvementAreas: []
            };
            
            // Count by severity and type
            notes.forEach(note => {
                analysis.severityDistribution[note.level] = (analysis.severityDistribution[note.level] || 0) + 1;
                analysis.typeDistribution[note.type] = (analysis.typeDistribution[note.type] || 0) + 1;
            });
            
            // Determine risk level based on severity
            const graveCount = (analysis.severityDistribution['GRAVE'] || 0) + (analysis.severityDistribution['MUY GRAVE'] || 0);
            if (graveCount >= 3) {
                analysis.riskLevel = 'ALTO';
            } else if (graveCount >= 1 || analysis.totalNotes >= 5) {
                analysis.riskLevel = 'MEDIO';
            }
            
            // Generate trend analysis
            if (notes.length >= 3) {
                const recentNotes = notes.slice(-3);
                const severityLevels = {'LEVE': 1, 'MODERADA': 2, 'GRAVE': 3, 'MUY GRAVE': 4};
                const avgSeverity = recentNotes.reduce((sum, note) => sum + severityLevels[note.level], 0) / recentNotes.length;
                
                if (avgSeverity >= 3) {
                    analysis.trends = 'TENDENCIA PREOCUPANTE - Incremento en la gravedad de las incidencias';
                } else if (avgSeverity <= 1.5) {
                    analysis.trends = 'TENDENCIA POSITIVA - Mejora en el comportamiento';
                } else {
                    analysis.trends = 'COMPORTAMIENTO ESTABLE - Sin cambios significativos';
                }
            }
            
            // Identify improvement areas
            const mostCommonType = Object.keys(analysis.typeDistribution).reduce((a, b) => 
                analysis.typeDistribution[a] > analysis.typeDistribution[b] ? a : b
            );
            
            switch(mostCommonType) {
                case 'SANCIÓN':
                case 'AMONESTACIÓN':
                    analysis.improvementAreas.push('Autorregulación emocional', 'Resolución de conflictos');
                    break;
                case 'LLAMADO DE ATENCIÓN':
                    analysis.improvementAreas.push('Atención y concentración', 'Seguimiento de normas');
                    break;
                case 'SUSPENSIÓN':
                    analysis.improvementAreas.push('Control de impulsos', 'Respeto por la autoridad');
                    break;
                default:
                    analysis.improvementAreas.push('Desarrollo de habilidades sociales');
            }
            
            return analysis;
        }

        // Generate AI-powered recommendations
        function generateRecommendations(notes, analysis) {
            const recommendations = [];
            
            // Risk-based recommendations
            switch(analysis.riskLevel) {
                case 'ALTO':
                    recommendations.push('🚨 INTERVENCIÓN INMEDIATA: Reunión urgente con padres y equipo directivo');
                    recommendations.push('📋 PLAN DE APOYO: Implementar plan de intervención conductual personalizado');
                    recommendations.push('👥 SEGUIMIENTO INTENSIVO: Monitoreo diario por parte del gabinete psicopedagógico');
                    break;
                case 'MEDIO':
                    recommendations.push('⚠️ ATENCIÓN PREVENTIVA: Citación a padres para establecer estrategias conjuntas');
                    recommendations.push('📚 APOYO ACADÉMICO: Evaluar necesidades de apoyo pedagógico adicional');
                    recommendations.push('🎯 OBJETIVOS CLAROS: Establecer metas conductuales específicas y medibles');
                    break;
                case 'BAJO':
                    recommendations.push('✅ REFUERZO POSITIVO: Reconocer y reforzar comportamientos apropiados');
                    recommendations.push('📈 MONITOREO REGULAR: Seguimiento quincenal del progreso');
                    break;
            }
            
            // Specific recommendations based on note types
            if (analysis.typeDistribution['SUSPENSIÓN']) {
                recommendations.push('🏠 TRABAJO EN CASA: Actividades reflexivas durante el período de suspensión');
                recommendations.push('🤝 REINTEGRACIÓN: Plan estructurado de reincorporación a las actividades');
            }
            
            if (analysis.typeDistribution['CITACIÓN A PADRES'] >= 2) {
                recommendations.push('👨‍👩‍👧‍👦 COMPROMISO FAMILIAR: Establecer acuerdos escritos con la familia');
                recommendations.push('📞 COMUNICACIÓN FLUIDA: Canal directo de comunicación diaria con los padres');
            }
            
            // Improvement area recommendations
            analysis.improvementAreas.forEach(area => {
                switch(area) {
                    case 'Autorregulación emocional':
                        recommendations.push('🧘 TÉCNICAS DE RELAJACIÓN: Enseñar estrategias de manejo del estrés');
                        break;
                    case 'Resolución de conflictos':
                        recommendations.push('🤝 MEDIACIÓN ESCOLAR: Participación en programa de resolución de conflictos');
                        break;
                    case 'Atención y concentración':
                        recommendations.push('🎯 ESTRATEGIAS COGNITIVAS: Técnicas para mejorar la concentración en clase');
                        break;
                }
            });
            
            return recommendations;
        }

        // Create PDF document structure
        function createPDFDocument(student, notes, analysis, recommendations) {
            const currentDate = new Date().toLocaleDateString('es-ES');
            const classroom = `${student.year}°${student.division} - ${student.school}`;
            
            let pdfContent = `
CÁTEDRA ABIERTA SUITE
REPORTE INTEGRAL DE SEGUIMIENTO ESTUDIANTIL
═══════════════════════════════════════════════════════════════

INFORMACIÓN DEL ESTUDIANTE
──────────────────────────────────────────────────────────────
Nombre Completo: ${student.name} ${student.lastName}
ID Estudiante: ${String(student.id).padStart(3, '0')}
Aula: ${classroom}
Promedio Académico: ${student.average.toFixed(1)}
Estado Académico: ${student.average >= 6 ? 'APROBADO' : 'DESAPROBADO'}
Fecha del Reporte: ${currentDate}
${student.isRepeater ? `Recursante: SÍ (${student.reason})` : 'Recursante: NO'}

ANÁLISIS CONDUCTUAL GENERADO POR IA
──────────────────────────────────────────────────────────────
Total de Notas Registradas: ${analysis.totalNotes}
Nivel de Riesgo: ${analysis.riskLevel}
Tendencia: ${analysis.trends}

DISTRIBUCIÓN POR GRAVEDAD:
${Object.entries(analysis.severityDistribution).map(([level, count]) => 
    `• ${level}: ${count} incidencia(s)`).join('\n')}

DISTRIBUCIÓN POR TIPO:
${Object.entries(analysis.typeDistribution).map(([type, count]) => 
    `• ${type}: ${count} incidencia(s)`).join('\n')}

ÁREAS DE MEJORA IDENTIFICADAS:
${analysis.improvementAreas.map(area => `• ${area}`).join('\n')}

HISTORIAL DETALLADO DE NOTAS
──────────────────────────────────────────────────────────────
`;

            // Add detailed notes
            notes.forEach((note, index) => {
                pdfContent += `
${index + 1}. FECHA: ${note.date} - HORA: ${note.time}
   TIPO: ${note.type}
   GRAVEDAD: ${note.level}
   DESCRIPCIÓN: ${note.description}
   ────────────────────────────────────────────────────────────
`;
            });

            pdfContent += `

RECOMENDACIONES GENERADAS POR IA
──────────────────────────────────────────────────────────────
${recommendations.map((rec, index) => `${index + 1}. ${rec}`).join('\n\n')}

PLAN DE SEGUIMIENTO SUGERIDO
──────────────────────────────────────────────────────────────
• Próxima evaluación: ${new Date(Date.now() + 15*24*60*60*1000).toLocaleDateString('es-ES')}
• Responsable del seguimiento: Coordinador de Convivencia
• Frecuencia de monitoreo: ${analysis.riskLevel === 'ALTO' ? 'Diario' : analysis.riskLevel === 'MEDIO' ? 'Semanal' : 'Quincenal'}

OBSERVACIONES ADICIONALES
──────────────────────────────────────────────────────────────
Este reporte ha sido generado automáticamente por Cátedra Abierta Suite
utilizando algoritmos de inteligencia artificial para el análisis conductual.
Las recomendaciones deben ser evaluadas por el equipo docente y directivo.

Reporte generado el: ${new Date().toLocaleString('es-ES')}
Usuario: ${currentUser}

═══════════════════════════════════════════════════════════════
            `;
            
            return pdfContent;
        }

        // Download PDF function
        function downloadPDF(content, filename) {
            // Create a blob with the content
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            
            // Create download link
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            alert(`📄 REPORTE GENERADO EXITOSAMENTE\n\n` +
                  `El reporte con análisis de IA ha sido descargado como:\n` +
                  `"${filename}"\n\n` +
                  `El archivo incluye:\n` +
                  `• Análisis conductual automatizado\n` +
                  `• Recomendaciones personalizadas\n` +
                  `• Plan de seguimiento sugerido\n` +
                  `• Historial completo de notas\n\n` +
                  `Nota: El archivo se descarga en formato de texto.\n` +
                  `Para convertir a PDF, puede usar herramientas online\n` +
                  `o impresoras virtuales PDF.`);
        }

        // Data persistence functions
        function saveData() {
            try {
                localStorage.setItem('academicSystem_students', JSON.stringify(students));
                localStorage.setItem('academicSystem_classrooms', JSON.stringify(classrooms));
                localStorage.setItem('academicSystem_studentNotes', JSON.stringify(studentNotes));
                localStorage.setItem('academicSystem_classroomCodes', JSON.stringify(classroomCodes));
                localStorage.setItem('academicSystem_savedSchools', JSON.stringify(savedSchools));
                localStorage.setItem('academicSystem_exams', JSON.stringify(exams));
                localStorage.setItem('academicSystem_attendanceRecords', JSON.stringify(attendanceRecords));
                console.log('Data saved successfully:', {
                    students: students.length,
                    classrooms: classrooms.length,
                    exams: exams.length,
                    attendanceRecords: Object.keys(attendanceRecords).length
                });
            } catch (e) {
                console.error('Error saving data:', e);
                updateStatus('Error al guardar datos');
            }
        }

        function loadData() {
            try {
                const savedStudents = localStorage.getItem('academicSystem_students');
                const savedClassrooms = localStorage.getItem('academicSystem_classrooms');
                const savedNotes = localStorage.getItem('academicSystem_studentNotes');
                const savedCodes = localStorage.getItem('academicSystem_classroomCodes');
                const savedSchoolsList = localStorage.getItem('academicSystem_savedSchools');
                const savedExams = localStorage.getItem('academicSystem_exams');
                const savedAttendance = localStorage.getItem('academicSystem_attendanceRecords');
                
                console.log('Loading data from localStorage...');
                console.log('Saved students:', savedStudents);
                console.log('Saved classrooms:', savedClassrooms);
                console.log('Saved exams:', savedExams);
                console.log('Saved attendance:', savedAttendance);
                
                if (savedStudents) {
                    students = JSON.parse(savedStudents);
                    console.log('Loaded students:', students);
                }
                
                if (savedClassrooms) {
                    classrooms = JSON.parse(savedClassrooms);
                    console.log('Loaded classrooms:', classrooms);
                }
                
                if (savedNotes) {
                    studentNotes = JSON.parse(savedNotes);
                }
                
                if (savedCodes) {
                    classroomCodes = JSON.parse(savedCodes);
                }
                
                if (savedSchoolsList) {
                    savedSchools = JSON.parse(savedSchoolsList);
                }
                
                if (savedExams) {
                    exams = JSON.parse(savedExams);
                    console.log('Loaded exams:', exams);
                }
                
                if (savedAttendance) {
                    attendanceRecords = JSON.parse(savedAttendance);
                    console.log('Loaded attendance records:', attendanceRecords);
                }
                
                console.log('Final data state:', {
                    students: students.length,
                    classrooms: classrooms.length,
                    exams: exams.length,
                    attendanceRecords: Object.keys(attendanceRecords).length
                });
                
                updateStatus('Datos cargados desde memoria');
            } catch (e) {
                console.error('Error loading data:', e);
                updateStatus('Error al cargar datos - usando valores por defecto');
            }
        }

        // Initialize system
        function initializeSystem() {
            loadData();
            loadSavedSchools();
            updateTime();
            updateStatus('Sistema iniciado - Ingrese sus credenciales');
        }

        // Enter key support for login
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Loading animation
        function startLoadingAnimation() {
            const loadingBar = document.getElementById('loadingBar');
            if (loadingBar) {
                loadingBar.classList.add('loading-bar');
            }
        }

        // Refresh application function
        function refreshApplication() {
            updateStatus('Actualizando aplicación...');
            
            // Show loading message
            const originalStatus = document.getElementById('statusText').textContent;
            updateStatus('🔄 Refrescando datos y ordenando listas...');
            
            // Simulate refresh process
            setTimeout(() => {
                // Reload data from localStorage
                loadData();
                
                // Refresh current view if we're in classroom detail
                if (!document.getElementById('classroomDetail').classList.contains('hidden')) {
                    const classroomEl = document.getElementById('currentClassroom');
                    const schoolEl = document.getElementById('currentSchool');
                    
                    if (classroomEl && schoolEl) {
                        const classroom = classroomEl.textContent;
                        const school = schoolEl.textContent;
                        if (classroom && school) {
                            showClassroomDetail(classroom, school);
                        }
                    }
                }
                
                // Refresh classroom manager if visible
                if (!document.getElementById('classroomManager').classList.contains('hidden')) {
                    loadClassroomList();
                }
                
                // Refresh exam manager if visible
                if (!document.getElementById('examManager').classList.contains('hidden')) {
                    loadExamList();
                }
                
                // Refresh exam grades if visible
                if (!document.getElementById('examGrades').classList.contains('hidden') && currentExamId) {
                    const exam = exams.find(e => e.id === currentExamId);
                    if (exam) {
                        loadExamGradesList(exam);
                    }
                }
                
                updateStatus('✅ Aplicación actualizada - Listas ordenadas alfabéticamente');
                
                // Return to original status after 3 seconds
                setTimeout(() => {
                    updateStatus('Sistema actualizado y listo');
                }, 3000);
            }, 500);
        }

        // Show exam type description
        function showExamTypeDescription() {
            const examType = document.getElementById('examType').value;
            const descriptionDiv = document.getElementById('examTypeDescription');
            const descriptionText = document.getElementById('typeDescriptionText');
            
            const descriptions = {
                'EXAMEN ESCRITO': 'Prueba realizada por escrito para evaluar conocimientos teóricos o prácticos al finalizar un tema o período.',
                'EXAMEN ORAL': 'Exposición verbal del estudiante ante el docente, para evaluar comprensión y expresión de ideas.',
                'PUESTA GRUPAL': 'Presentación o trabajo colaborativo de un grupo, donde muestran sus aprendizajes de forma conjunta.',
                'EXAMEN INTEGRADOR': 'Evaluación que combina contenidos de distintas áreas o unidades para aplicar conocimientos de forma global.',
                'INTENSIFICACIÓN': 'Actividad de profundización para estudiantes que deben reforzar aprendizajes, previa a la evaluación final.',
                'RECUPERATORIO': 'Oportunidad para mejorar o recuperar una evaluación desaprobada.',
                'EVALUACIONES DIAGNÓSTICAS': 'Actividad inicial para conocer los saberes previos del alumnado antes de comenzar un tema o ciclo.'
            };
            
            if (examType && descriptions[examType]) {
                descriptionText.textContent = descriptions[examType];
                descriptionDiv.style.display = 'block';
            } else {
                descriptionDiv.style.display = 'none';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startLoadingAnimation();
            initializeSystem();
            setInterval(updateTime, 1000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9697607ad10fda0e',t:'MTc1NDI0MDQ4NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
