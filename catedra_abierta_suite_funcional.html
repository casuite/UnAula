<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Cátedra Abierta Suite</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --bg:#e8f0ff;
  --card:#ffffff;
  --primary:#5b9bd5;
  --accent:#70ad47;
  --danger:#ff6b6b;
  --text:#333;
  --border:#ddd;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,sans-serif;}
body{background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}
.screen{background:var(--card);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);width:100%;max-width:480px;padding:30px;display:none;}
.screen.active{display:block;}
h2{margin-bottom:20px;text-align:center;color:var(--primary);}
label{display:block;margin:8px 0 4px;font-size:.9rem;}
input,select,textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;margin-bottom:12px;}
button{width:100%;padding:10px;border:none;border-radius:6px;color:#fff;background:var(--primary);cursor:pointer;margin-bottom:8px;}
button.accent{background:var(--accent);}
button.danger{background:var(--danger);}
.menu-item{background:#f7f7f7;margin:6px 0;padding:12px;border-radius:6px;cursor:pointer;transition:.2s;}
.menu-item:hover{background:#eef;}
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.85rem;}
th,td{padding:8px;border:1px solid var(--border);text-align:center;}
th{background:#f0f4f8;}
.status-bar{position:fixed;bottom:0;left:0;right:0;background:var(--primary);color:#fff;padding:6px 12px;font-size:.75rem;text-align:center;}
.hidden{display:none;}
.search-bar{margin-bottom:12px;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="screen active">
  <h2>Cátedra Abierta Suite</h2>
  <label>Usuario</label><input id="username" placeholder="Ej. profe1" />
  <button onclick="login()">Ingresar</button>
</div>

<!-- MAIN MENU -->
<div id="mainMenu" class="screen">
  <input id="mainSearch" class="search-bar" placeholder="Buscar opción...">
  <h2>Menú Principal</h2>
  <div class="menu-item" onclick="showScreen('classroomManager')">Aulas</div>
  <div class="menu-item" onclick="showScreen('attendanceManager')">Asistencia</div>
  <div class="menu-item" onclick="showScreen('reports')">Reportes</div>
  <button class="danger" onclick="logout()">Salir</button>
</div>

<!-- CLASSROOM MANAGER -->
<div id="classroomManager" class="screen">
  <h2>Gestionar Aulas</h2>
  <button onclick="showScreen('createClassroomForm')">Crear Aula</button>
  <div id="classroomList"></div>
  <button onclick="goBack()">Volver</button>
</div>

<!-- CREATE CLASSROOM -->
<div id="createClassroomForm" class="screen">
  <h2>Crear Aula</h2>
  <label>Año</label><input id="cYear" type="number" min="1" max="12">
  <label>División</label><input id="cDiv" maxlength="3" placeholder="A">
  <label>Colegio</label><input id="cSchool" placeholder="Nombre">
  <label>Turno</label>
  <select id="cShift"><option>MAÑANA</option><option>TARDE</option><option>VESPERTINO</option></select>
  <button onclick="saveClassroom()">Guardar</button>
  <button onclick="goBack()">Cancelar</button>
</div>

<!-- CLASSROOM DETAIL -->
<div id="classroomDetail" class="screen">
  <h2 id="detailTitle">Aula</h2>
  <p><strong>TEA ≥7:</strong> <span id="teaCount">0</span> / <span id="totalCount">0</span></p>
  <input class="search-bar" placeholder="Buscar estudiante…" oninput="filterStudents(this.value)">
  <table>
    <thead><tr><th>Apellido, Nombre</th><th>Promedio</th></tr></thead>
    <tbody id="studentList"></tbody>
  </table>
  <button onclick="showScreen('addStudentForm')">Agregar Estudiante</button>
  <button onclick="showScreen('importStudentForm')">Importar Lista</button>
  <button onclick="showScreen('createExamForm')">Crear Examen</button>
  <button onclick="goBack()">Volver</button>
</div>

<!-- ADD STUDENT -->
<div id="addStudentForm" class="screen">
  <h2>Agregar Estudiante</h2>
  <label>Nombre</label><input id="sName">
  <label>Apellido</label><input id="sLast">
  <label>Fecha de nacimiento</label><input type="date" id="sBirth">
  <label>¿Recursante?</label>
  <select id="sRepeater" onchange="toggleRepeater()">
    <option value="no">No</option>
    <option value="yes">Sí</option>
  </select>
  <div id="repeaterFields" class="hidden">
    <label>Colegio anterior</label><input id="rSchool">
    <label>Año anterior</label><input id="rYear">
    <label>Motivo</label><input id="rReason">
  </div>
  <button onclick="saveStudent()">Guardar</button>
  <button onclick="goBack()">Cancelar</button>
</div>

<!-- IMPORT STUDENTS -->
<div id="importStudentForm" class="screen">
  <h2>Importar Lista</h2>
  <textarea id="importData" rows="6" placeholder="Apellido, Nombre&#10;García López, Juan Carlos"></textarea>
  <button onclick="importStudents()">Importar</button>
  <button onclick="goBack()">Cancelar</button>
</div>

<!-- STUDENT DETAIL -->
<div id="studentDetail" class="screen">
  <h2 id="sdTitle">Estudiante</h2>
  <div id="sdInfo" style="background:#eef;padding:10px;border-radius:6px;margin-bottom:12px;"></div>
  <div class="menu-item" onclick="showAddNote()">[1] Agregar Nota</div>
  <div class="menu-item" onclick="showNotesHistory()">[2] Ver Historial de Notas</div>
  <div class="menu-item" onclick="editStudentInfo()">[3] Editar Información</div>
  <div class="menu-item" onclick="showStudentAttendance()">[4] Asistencia</div>
  <div class="menu-item" onclick="deleteStudent()" style="color:#d9534f;">[6] Eliminar Estudiante</div>
  <div class="menu-item" onclick="showScreen('classroomDetail')">[0] Volver al Aula</div>
</div>

<!-- ADD NOTE -->
<div id="addNoteForm" class="screen">
  <h2>Agregar Nota</h2>
  <label>Tipo de Nota</label>
  <select id="noteType">
    <option>SANCIÓN</option><option>OBSIVACIÓN</option><option>FELICITACIÓN</option>
    <option>LLAMADO DE ATENCIÓN</option><option>CITACIÓN A PADRES</option>
  </select>
  <label>Nivel de Gravedad</label>
  <select id="noteLevel">
    <option>LEVE</option><option>MODERADA</option><option>GRAVE</option><option>MUY GRAVE</option>
  </select>
  <label>Descripción</label><textarea id="noteDesc" rows="3"></textarea>
  <button onclick="saveNote()">Guardar Nota</button>
  <button onclick="showNotesHistory()">Ver Historial</button>
  <button onclick="showScreen('studentDetail')">Cancelar</button>
</div>

<!-- NOTES HISTORY -->
<div id="notesHistory" class="screen">
  <h2>Historial de Notas</h2>
  <div id="notesTable"></div>
  <button onclick="showScreen('studentDetail')">Volver</button>
</div>

<!-- EDIT STUDENT -->
<div id="editStudentForm" class="screen">
  <h2>Editar Alumno</h2>
  <label>Nombre</label><input id="esName">
  <label>Apellido</label><input id="esLast">
  <label>Fecha de nacimiento</label><input type="date" id="esBirth">
  <button onclick="saveEditStudent()">Guardar Cambios</button>
  <button onclick="showScreen('studentDetail')">Cancelar</button>
</div>

<!-- ATTENDANCE DETAIL -->
<div id="studentAttendance" class="screen">
  <h2>Asistencia de <span id="saName"></span></h2>
  <table>
    <thead><tr><th>Fecha</th><th>Estado</th></tr></thead>
    <tbody id="saTable"></tbody>
  </table>
  <button onclick="showScreen('studentDetail')">Volver</button>
</div>

<!-- REPORTS -->
<div id="reports" class="screen">
  <h2>Reportes</h2>
  <button onclick="exportData()">Exportar Datos</button>
  <button onclick="goBack()">Volver</button>
</div>

<div class="status-bar" id="statusText">Listo</div>

<script>
/* ===== GLOBALS ===== */
let currentScreen="loginScreen", currentAttendance={}, currentDate="";

/* ===== DATA ===== */
let students=[], classrooms=[], exams=[], attendance={}, notes={}, currentUser='', currentClassroom=null, currentStudent=null;

/* ===== STORAGE ===== */
function saveData(){localStorage.setItem('caSuiteData',JSON.stringify({students,classrooms,exams,attendance,notes}));}
function loadData(){
  const d=JSON.parse(localStorage.getItem('caSuiteData')||'{}');
  students=d.students||[]; classrooms=d.classrooms||[]; exams=d.exams||[]; attendance=d.attendance||{}; notes=d.notes||{};
}
loadData();

/* ===== NAV ===== */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function goBack(){
  const map={'classroomDetail':'classroomManager','studentDetail':'classroomDetail','addNoteForm':'studentDetail','notesHistory':'studentDetail','editStudentForm':'studentDetail','studentAttendance':'studentDetail'};
  showScreen(map[currentScreen]||'mainMenu');
}

/* ===== LOGIN / LOGOUT ===== */
function login(){
  const u=document.getElementById('username').value.trim();
  if(!u){alert('Usuario requerido');return;}
  currentUser=u; showScreen('mainMenu'); loadClassroomList(); loadAttendanceClassroomList();
}
function logout(){if(confirm('¿Salir?')){currentUser='';showScreen('loginScreen');}}

/* ===== CLASSROOM ===== */
function saveClassroom(){
  const y=document.getElementById('cYear').value.trim();
  const d=document.getElementById('cDiv').value.trim().toUpperCase();
  const s=document.getElementById('cSchool').value.trim();
  const sh=document.getElementById('cShift').value;
  if(!y||!d||!s||!sh){alert('Complete campos obligatorios');return;}
  classrooms.push({id:Date.now(),name:y+'°'+d,school:s,shift:sh});
  saveData(); loadClassroomList(); loadAttendanceClassroomList();
  ['cYear','cDiv','cSchool'].forEach(id=>document.getElementById(id).value='');
  showScreen('classroomManager');
}
function loadClassroomList(){
  const list=document.getElementById('classroomList');
  list.innerHTML='';
  classrooms.forEach(c=>{
    const div=document.createElement('div');
    div.className='menu-item';
    div.innerHTML=`<span style="flex:1">${c.name} - ${c.school}</span>
                   <button onclick="openClassroom(${c.id})" style="width:auto;padding:4px 8px;margin-left:8px;">Ver aula</button>`;
    list.appendChild(div);
  });
}
function openClassroom(id){
  currentClassroom=classrooms.find(c=>c.id===id);
  document.getElementById('detailTitle').textContent=currentClassroom.name+' - '+currentClassroom.school;
  renderStudents(); showScreen('classroomDetail');
}
function renderStudents(){
  const tbody=document.getElementById('studentList');
  tbody.innerHTML='';
  const roomStudents=students.filter(s=>s.year+'°'+s.division===currentClassroom.name && s.school===currentClassroom.school);
  let tea=0;
  roomStudents.forEach(s=>{
    const grades=exams.filter(e=>e.classroom===currentClassroom.name && e.school===currentClassroom.school && e.grades[s.id]!==undefined).map(e=>e.grades[s.id]);
    const avg=grades.length?(grades.reduce((a,b)=>a+b,0)/grades.length).toFixed(1):'';
    if(avg>=7)tea++;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="cursor:pointer" onclick="openStudent(${s.id})">${s.lastName}, ${s.name}</td><td>${avg}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('teaCount').textContent=tea;
  document.getElementById('totalCount').textContent=roomStudents.length;
}
function filterStudents(q){
  const rows=document.querySelectorAll('#studentList tr');
  rows.forEach(r=>r.style.display=r.cells[0].textContent.toUpperCase().includes(q.toUpperCase())?'':'none');
}

/* ===== STUDENT ===== */
function openStudent(id){
  currentStudent=students.find(s=>s.id===id);
  document.getElementById('sdTitle').textContent='Estudiante';
  document.getElementById('sdInfo').innerHTML=`
    <strong>ESTUDIANTE:</strong> ${currentStudent.name} ${currentStudent.lastName}<br>
    <strong>ID:</strong> ${String(currentStudent.id).padStart(3,'0')}<br>
    <strong>AULA:</strong> ${currentStudent.year}°${currentStudent.division} - ${currentStudent.school}<br>
    <strong>PROMEDIO:</strong> ${averageStudent(currentStudent)}<br>
    <strong>ESTADO:</strong> ${stateStudent(currentStudent)}`;
  showScreen('studentDetail');
}
function averageStudent(s){
  const grades=exams.filter(e=>e.grades[s.id]!==undefined).map(e=>e.grades[s.id]);
  return grades.length?(grades.reduce((a,b)=>a+b,0)/grades.length).toFixed(1):'Sin calificar';
}
function stateStudent(s){
  const avg=Number(averageStudent(s));
  return isNaN(avg)?'SIN CALIFICAR':avg>=7?'TEA':avg>=4?'TEP':'TED';
}
function saveStudent(){
  const name=document.getElementById('sName').value.trim().toUpperCase();
  const last=document.getElementById('sLast').value.trim().toUpperCase();
  const birth=document.getElementById('sBirth').value;
  const repeater=document.getElementById('sRepeater').value==='yes';
  if(!name||!last){alert('Nombre y apellido requeridos');return;}
  const student={id:Date.now(),name,lastName:last,birth,repeater,
    year:currentClassroom.name.split('°')[0],division:currentClassroom.name.split('°')[1],school:currentClassroom.school};
  if(repeater){
    student.previousSchool=document.getElementById('rSchool').value.trim();
    student.previousYear=document.getElementById('rYear').value.trim();
    student.reason=document.getElementById('rReason').value.trim();
  }
  students.push(student);saveData();renderStudents();showScreen('classroomDetail');
}
function importStudents(){
  const raw=document.getElementById('importData').value.trim();
  if(!raw){alert('No hay datos');return;}
  const lines=raw.split('\n').map(l=>l.trim()).filter(Boolean);
  let imported=0;
  lines.forEach(line=>{
    const parts=line.split(',').map(p=>p.trim().toUpperCase());
    const last=parts[0]||'',first=parts[1]||'';
    if(!first||!last)return;
    const exists=students.find(s=>s.name===first&&s.lastName===last&&s.year===currentClassroom.name.split('°')[0]&&s.school===currentClassroom.school);
    if(!exists){students.push({id:Date.now(),name:first,lastName:last,year:currentClassroom.name.split('°')[0],division:currentClassroom.name.split('°')[1],school:currentClassroom.school});imported++;}
  });
  saveData();renderStudents();showScreen('classroomDetail');alert('Importados '+imported);
}
function toggleRepeater(){document.getElementById('repeaterFields').classList.toggle('hidden',document.getElementById('sRepeater').value==='no');}

/* ===== STUDENT DETAIL ===== */
function showAddNote(){
  showScreen('addNoteForm');
}
function saveNote(){
  const type=document.getElementById('noteType').value;
  const level=document.getElementById('noteLevel').value;
  const desc=document.getElementById('noteDesc').value.trim();
  if(!desc){alert('Descripción requerida');return;}
  if(!notes[currentStudent.id])notes[currentStudent.id]=[];
  notes[currentStudent.id].push({type,level,desc,date:new Date().toLocaleDateString('es-ES'),time:new Date().toLocaleTimeString('es-ES',{hour12:false})});
  saveData();showNotesHistory();
}
function showNotesHistory(){
  showScreen('notesHistory');
  const tbody=document.getElementById('notesTable');
  tbody.innerHTML='';
  const list=notes[currentStudent.id]||[];
  if(list.length===0){tbody.innerHTML='<p style="text-align:center;color:#888;">No hay notas</p>';return;}
  list.reverse().forEach(n=>{
    const div=document.createElement('div');
    div.innerHTML=`<p>${n.date} ${n.time} - ${n.type} (${n.level})<br>${n.desc}</p>`;
    tbody.appendChild(div);
  });
}
function editStudentInfo(){
  document.getElementById('esName').value=currentStudent.name;
  document.getElementById('esLast').value=currentStudent.lastName;
  document.getElementById('esBirth').value=currentStudent.birth||'';
  showScreen('editStudentForm');
}
function saveEditStudent(){
  currentStudent.name=document.getElementById('esName').value.trim().toUpperCase();
  currentStudent.lastName=document.getElementById('esLast').value.trim().toUpperCase();
  currentStudent.birth=document.getElementById('esBirth').value;
  saveData();openStudent(currentStudent.id);
}
function deleteStudent(){
  if(!confirm('¿Eliminar definitivamente?'))return;
  students=students.filter(s=>s.id!==currentStudent.id);
  delete notes[currentStudent.id];
  saveData();renderStudents();showScreen('classroomDetail');
}
function showStudentAttendance(){
  showScreen('studentAttendance');
  document.getElementById('saName').textContent=currentStudent.name+' '+currentStudent.lastName;
  const tbody=document.getElementById('saTable');
  tbody.innerHTML='';
  const rec=attendance[currentStudent.id]||{};
  Object.entries(rec).forEach(([date,status])=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${date}</td><td>${status}</td>`;
    tbody.appendChild(tr);
  });
}

/* ===== ATTENDANCE ===== */
function loadAttendanceClassroomList(){
  const list=document.getElementById('attendanceClassroomList');
  list.innerHTML='';
  classrooms.forEach(c=>{
    const div=document.createElement('div');
    div.className='menu-item';
    div.innerHTML=`<span>${c.name} - ${c.school}</span>
                   <button onclick="startAttendance(${c.id})" style="width:auto;margin-left:8px;">Tomar lista</button>`;
    list.appendChild(div);
  });
}
function startAttendance(cId){
  currentClassroom=classrooms.find(c=>c.id===cId);
  showScreen('attendanceDateSelector');
  document.getElementById('attClassName').textContent=currentClassroom.name+' - '+currentClassroom.school;
}
function selectDate(type){
  if(type==='today'){
    currentDate=new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'});
    startTakingAttendance();
  }else{
    document.getElementById('customDateDiv').classList.remove('hidden');
  }
}
function confirmCustomDate(){
  const d=document.getElementById('customDate').value;
  if(!d){alert('Seleccione fecha');return;}
  currentDate=new Date(d).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'});
  startTakingAttendance();
}
function startTakingAttendance(){
  const roomStudents=students.filter(s=>s.year+'°'+s.division===currentClassroom.name && s.school===currentClassroom.school);
  if(roomStudents.length===0){alert('No hay alumnos');return;}
  currentAttendance.students=roomStudents.sort((a,b)=>(a.lastName+a.name).localeCompare(b.lastName+b.name));
  currentAttendance.index=0;
  currentAttendance.records={};
  showScreen('attendanceTaking');
  nextStudent();
}
function nextStudent(){
  const st=currentAttendance.students[currentAttendance.index];
  if(!st){finishAttendance();return;}
  document.getElementById('currentStudentName').textContent=st.lastName+', '+st.name;
  document.getElementById('attProgress').textContent=(currentAttendance.index+1)+' / '+currentAttendance.students.length;
}
function markAttendance(status){
  const st=currentAttendance.students[currentAttendance.index];
  if(!attendance[st.id])attendance[st.id]={};
  attendance[st.id][currentDate]=status;
  currentAttendance.index++;
  nextStudent();
}
function finishAttendance(){
  saveData();
  showAttendanceResults();
}
function showAttendanceResults(){
  showScreen('attendanceResults');
  document.getElementById('resDate').textContent=currentDate;
  document.getElementById('resDateCol').textContent=currentDate;
  const stu=currentAttendance.students;
  const tbody=document.getElementById('resTableBody');
  tbody.innerHTML='';
  stu.forEach(s=>{
    const rec=attendance[s.id]||{};
    const dates=Object.keys(rec);
    const present=dates.filter(d=>rec[d]==='P').length;
    const percent=dates.length?Math.round((present/dates.length)*100):0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.lastName}, ${s.name}</td><td>${percent}%</td><td>${rec[currentDate]||''}</td>`;
    tbody.appendChild(tr);
  });
}

/* ===== REPORTS ===== */
function exportData(){
  const blob=new Blob([JSON.stringify({students,classrooms,exams,attendance,notes},null,2)],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='datos.txt';a.click();
}

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded',()=>{loadData();loadClassroomList();loadAttendanceClassroomList();});

document.getElementById('mainSearch').addEventListener('input', function(e) {
  const q = e.target.value.toLowerCase();
  document.querySelectorAll('#mainMenu .menu-item').forEach(item => {
    item.style.display = item.textContent.toLowerCase().includes(q) ? 'block' : 'none';
  });
});

</script>
</body>
</html>